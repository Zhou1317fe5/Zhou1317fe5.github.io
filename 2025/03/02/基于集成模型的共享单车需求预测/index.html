<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Zhou1317fe5"><meta name="keywords" content=""><meta name="description" content="1 赛题分析 https:&#x2F;&#x2F;www.kaggle.com&#x2F;competitions&#x2F;bike-sharing-demand 2 数据探索 理解数据背景与目标 概述 共享单车系统是一种租赁自行车的方式，通过城市各处的自动化站点网络，实现会员注册、租赁和还车的自动化过程。使用这些系统，人们可以在一个地点租车，并在需要时将其归还到不同的地点。目前，全球有超过500个共享单车项目。 数据字段"><meta property="og:type" content="article"><meta property="og:title" content="基于集成模型的共享单车需求预测"><meta property="og:url" content="https://zhou1317fe5.github.io/2025/03/02/%E5%9F%BA%E4%BA%8E%E9%9B%86%E6%88%90%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6%E9%9C%80%E6%B1%82%E9%A2%84%E6%B5%8B/index.html"><meta property="og:site_name" content="Zhou1317fe5"><meta property="og:description" content="1 赛题分析 https:&#x2F;&#x2F;www.kaggle.com&#x2F;competitions&#x2F;bike-sharing-demand 2 数据探索 理解数据背景与目标 概述 共享单车系统是一种租赁自行车的方式，通过城市各处的自动化站点网络，实现会员注册、租赁和还车的自动化过程。使用这些系统，人们可以在一个地点租车，并在需要时将其归还到不同的地点。目前，全球有超过500个共享单车项目。 数据字段"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_19_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_20_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_21_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_28_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_28_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_28_2.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_28_3.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_28_4.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_28_5.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_28_6.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_31_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_34_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_36_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_39_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_43_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_45_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_49_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_50_0.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_64_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_67_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_72_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_77_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_80_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_80_3.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_97_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_120_1.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_120_2.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_120_3.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_120_4.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_120_5.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_120_6.png"><meta property="og:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_120_7.png"><meta property="article:published_time" content="2025-03-02T01:56:55.000Z"><meta property="article:modified_time" content="2025-03-02T12:38:38.489Z"><meta property="article:author" content="Zhou1317fe5"><meta property="article:tag" content="机器学习"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://zhou1317fe5.github.io/img/EDA-stacking_files/EDA-stacking_19_0.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>基于集成模型的共享单车需求预测 - Zhou1317fe5</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/iconfont_csdn/iconfont.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"zhou1317fe5.github.io",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Zhou1317fe5</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/Post_banner_img.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="基于集成模型的共享单车需求预测"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2025-03-02 09:56" pubdate>2025年3月2日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 152k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 1268 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">基于集成模型的共享单车需求预测</h1><div class="markdown-body"><h1 id="赛题分析">1 赛题分析</h1><p>https://www.kaggle.com/competitions/bike-sharing-demand</p><h1 id="数据探索">2 数据探索</h1><h2 id="理解数据背景与目标">理解数据背景与目标</h2><h4 id="概述"><strong>概述</strong></h4><p>共享单车系统是一种租赁自行车的方式，通过城市各处的自动化站点网络，实现会员注册、租赁和还车的自动化过程。使用这些系统，人们可以在一个地点租车，并在需要时将其归还到不同的地点。目前，全球有超过500个共享单车项目。</p><h4 id="数据字段"><strong>数据字段</strong></h4><ul><li>datetime - 小时日期 + 时间戳</li><li>season - 1 = 春季, 2 = 夏季, 3 = 秋季, 4 = 冬季</li><li>holiday - 是否为假日</li><li>workingday - 是否为工作日（非周末或假日）</li><li>weather - 天气情况：<ul><li>1: 晴天、少云、局部多云</li><li>2: 薄雾 + 多云、薄雾 + 碎云、薄雾 + 少云、薄雾</li><li>3: 小雪、小雨 + 雷暴 + 散云、小雨 + 散云</li><li>4: 大雨 + 冰雹 + 雷暴 + 薄雾、雪 + 雾</li></ul></li><li>temp - 温度（摄氏度）</li><li>atemp - "体感"温度（摄氏度）</li><li>humidity - 相对湿度</li><li>windspeed - 风速</li><li>casual - 非注册用户租赁数量</li><li>registered - 注册用户租赁数量</li><li>count - 租赁总数量（因变量）</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pylab<br><span class="hljs-keyword">import</span> calendar<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns<br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats<br><span class="hljs-keyword">import</span> missingno <span class="hljs-keyword">as</span> msno<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> warnings<br><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> MinMaxScaler, StandardScaler, RobustScaler, MaxAbsScaler<br>pd.options.mode.chained_assignment = <span class="hljs-literal">None</span><br>warnings.filterwarnings(<span class="hljs-string">&quot;ignore&quot;</span>, category=DeprecationWarning)<br>%matplotlib inline<br></code></pre></td></tr></table></figure><h2 id="数据初步观察与概览">数据初步观察与概览</h2><p><strong>加载数据集</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data = pd.read_csv(<span class="hljs-string">&quot;./data/train.csv&quot;</span>)<br>submit_data = pd.read_csv(<span class="hljs-string">&quot;./data/test.csv&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>查看数据集维度</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data.shape<br></code></pre></td></tr></table></figure><pre><code class="hljs">(10886, 12)</code></pre><p><strong>查看数据集前几行</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data.head(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><div><style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style><table border="1" class="dataframe"><thead><tr style="text-align:right"><th></th><th>datetime</th><th>season</th><th>holiday</th><th>workingday</th><th>weather</th><th>temp</th><th>atemp</th><th>humidity</th><th>windspeed</th><th>casual</th><th>registered</th><th>count</th></tr></thead><tbody><tr><th>0</th><td>2011-01-01 00:00:00</td><td>1</td><td>0</td><td>0</td><td>1</td><td>9.84</td><td>14.395</td><td>81</td><td>0.0</td><td>3</td><td>13</td><td>16</td></tr><tr><th>1</th><td>2011-01-01 01:00:00</td><td>1</td><td>0</td><td>0</td><td>1</td><td>9.02</td><td>13.635</td><td>80</td><td>0.0</td><td>8</td><td>32</td><td>40</td></tr></tbody></table></div><p><strong>查看各个特征的数据类型</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用info()查看信息</span><br><span class="hljs-built_in">print</span>(train_data.info())<br><span class="hljs-built_in">print</span>(submit_data.info())<br></code></pre></td></tr></table></figure><pre><code class="hljs">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 10886 entries, 0 to 10885
Data columns (total 12 columns):
 #   Column      Non-Null Count  Dtype  
---  ------      --------------  -----  
 0   datetime    10886 non-null  object 
 1   season      10886 non-null  int64  
 2   holiday     10886 non-null  int64  
 3   workingday  10886 non-null  int64  
 4   weather     10886 non-null  int64  
 5   temp        10886 non-null  float64
 6   atemp       10886 non-null  float64
 7   humidity    10886 non-null  int64  
 8   windspeed   10886 non-null  float64
 9   casual      10886 non-null  int64  
 10  registered  10886 non-null  int64  
 11  count       10886 non-null  int64  
dtypes: float64(3), int64(8), object(1)
memory usage: 1020.7+ KB
None
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 6493 entries, 0 to 6492
Data columns (total 9 columns):
 #   Column      Non-Null Count  Dtype  
---  ------      --------------  -----  
 0   datetime    6493 non-null   object 
 1   season      6493 non-null   int64  
 2   holiday     6493 non-null   int64  
 3   workingday  6493 non-null   int64  
 4   weather     6493 non-null   int64  
 5   temp        6493 non-null   float64
 6   atemp       6493 non-null   float64
 7   humidity    6493 non-null   int64  
 8   windspeed   6493 non-null   float64
dtypes: float64(3), int64(5), object(1)
memory usage: 456.7+ KB
None</code></pre><h2 id="时间特征处理和分类特征转换">时间特征处理和分类特征转换</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">from</span> dateutil <span class="hljs-keyword">import</span> parser<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_time_features</span>(<span class="hljs-params">data, time_col_name</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    处理各种格式的时间特征列，提取年、月、日、小时、分钟、星期几，以及其他时间特征。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        data: Pandas DataFrame，包含时间特征的原始数据。</span><br><span class="hljs-string">        time_col_name: str，时间特征在 DataFrame 中的列名。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns:</span><br><span class="hljs-string">        Pandas DataFrame，包含原始数据和新增的时间特征列。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># 定义新生成的时间特征列名</span><br>    date_col = <span class="hljs-string">&quot;date&quot;</span> <span class="hljs-comment"># 日期列名</span><br>    year_col = <span class="hljs-string">&quot;year&quot;</span> <span class="hljs-comment"># 年</span><br>    month_col = <span class="hljs-string">&quot;month&quot;</span> <span class="hljs-comment"># 月</span><br>    day_col = <span class="hljs-string">&quot;day&quot;</span> <span class="hljs-comment"># 日</span><br>    hour_col = <span class="hljs-string">&quot;hour&quot;</span> <span class="hljs-comment"># 小时</span><br>    minute_col = <span class="hljs-string">&quot;minute&quot;</span> <span class="hljs-comment"># 分钟</span><br>    weekday_col = <span class="hljs-string">&quot;weekday&quot;</span> <span class="hljs-comment"># 星期几，0 代表星期一 </span><br>    <span class="hljs-comment">#day_of_year_col = &quot;dayofyear&quot; # 一年中第几天</span><br>    quarter_col = <span class="hljs-string">&quot;quarter&quot;</span> <span class="hljs-comment"># 季度</span><br>    is_weekend_col = <span class="hljs-string">&quot;is_weekend&quot;</span> <span class="hljs-comment"># 是否为周末（1 表示是，0 表示否）</span><br>    <span class="hljs-comment">#is_month_start_col = &quot;is_month_start&quot; # 否为月初</span><br>    <span class="hljs-comment">#is_month_end_col = &quot;is_month_end&quot; # 否为月末</span><br>    <br><br><br>    <span class="hljs-comment"># 使用 dateutil.parser 解析各种格式的时间字符串</span><br>    datetime_series = data[time_col_name].apply(<span class="hljs-keyword">lambda</span> x: parser.parse(<span class="hljs-built_in">str</span>(x)))<br><br>    <span class="hljs-comment"># 创建一个新的 DataFrame 以避免修改原始数据</span><br>    processed_data = data.copy()<br><br>    <span class="hljs-comment"># 提取时间特征</span><br>    processed_data[date_col] = pd.to_datetime(datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.date()))<br>    processed_data[year_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.year).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    processed_data[month_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.month).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    processed_data[day_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.day).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    processed_data[hour_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.hour).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    processed_data[minute_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.minute).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    processed_data[weekday_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.weekday()).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    <span class="hljs-comment">#processed_data[day_of_year_col] = datetime_series.apply(lambda x: x.timetuple().tm_yday).astype(&#x27;int&#x27;)</span><br>    processed_data[quarter_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: x.quarter).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    processed_data[is_weekend_col] = datetime_series.apply(<span class="hljs-keyword">lambda</span> x: <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> x.weekday() &gt;= <span class="hljs-number">5</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>).astype(<span class="hljs-string">&#x27;int&#x27;</span>)<br>    <span class="hljs-comment">#processed_data[is_month_start_col] = datetime_series.apply(lambda x: int(x.is_month_start)).astype(&#x27;int&#x27;)</span><br>    <span class="hljs-comment">#processed_data[is_month_end_col] = datetime_series.apply(lambda x: int(x.is_month_end)).astype(&#x27;int&#x27;)</span><br><br><br>    <span class="hljs-keyword">return</span> processed_data<br><br><span class="hljs-comment"># 同时处理训练集和提交集的时间特征</span><br>train_data = process_time_features(train_data,<span class="hljs-string">&quot;datetime&quot;</span>)<br>submit_data = process_time_features(submit_data,<span class="hljs-string">&quot;datetime&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="时间特征可视化">时间特征可视化</h2><ul><li>很明显，人们倾向于在夏季租用自行车，因为那个季节骑自行车的条件真的很好。因此，六月、七月和八月的自行车需求相对较高。</li><li>在工作日，更多人倾向于在上午7-8点和下午5-6点租用自行车。如前所述，这可以归因于常规的上学和上班通勤者。</li><li>在"周六"和"周日"没有观察到上述模式。更多人倾向于在上午10点到下午4点之间租用自行车。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_basic_time_series</span>(<span class="hljs-params">data, target=<span class="hljs-string">&#x27;count&#x27;</span>, n_cols=<span class="hljs-number">2</span>, figsize=(<span class="hljs-params"><span class="hljs-number">20</span>, <span class="hljs-number">8</span></span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    基础时间序列分析：展示目标变量随时间的整体趋势</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - target: str, 目标变量名称</span><br><span class="hljs-string">    - n_cols: int, 图表列数</span><br><span class="hljs-string">    - figsize: tuple, 图形大小</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    <br>    <span class="hljs-keyword">if</span> n_cols == <span class="hljs-number">1</span>:<br>        <span class="hljs-comment"># 单图布局</span><br>        fig, ax = plt.subplots(figsize=figsize)<br>        <br>        <span class="hljs-comment"># 1.1 原始时间序列</span><br>        ax.plot(data[<span class="hljs-string">&#x27;date&#x27;</span>], data[target], color=<span class="hljs-string">&#x27;#2ecc71&#x27;</span>, alpha=<span class="hljs-number">0.7</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">&#x27;Original&#x27;</span>)<br>        <br>        <span class="hljs-comment"># 1.2 月度趋势（带标准差区间）</span><br>        df_temp = data.copy()<br>        df_temp.set_index(<span class="hljs-string">&#x27;date&#x27;</span>, inplace=<span class="hljs-literal">True</span>)<br>        resampled = df_temp[target].resample(<span class="hljs-string">&#x27;M&#x27;</span>)<br>        mean_values = resampled.mean()<br>        std_values = resampled.std()<br>        <br>        mean_values.plot(ax=ax, color=<span class="hljs-string">&#x27;#3498db&#x27;</span>, label=<span class="hljs-string">&#x27;Monthly Mean&#x27;</span>, linewidth=<span class="hljs-number">2</span>)<br>        ax.fill_between(<br>            mean_values.index,<br>            mean_values - std_values,<br>            mean_values + std_values,<br>            color=<span class="hljs-string">&#x27;#3498db&#x27;</span>,<br>            alpha=<span class="hljs-number">0.2</span>,<br>            label=<span class="hljs-string">&#x27;±1 std&#x27;</span><br>        )<br>        <br>        <span class="hljs-comment"># 设置图表样式</span><br>        ax.set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;target&#125;</span> Over Time with Monthly Trend&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>        ax.set_xlabel(<span class="hljs-string">&#x27;Date&#x27;</span>, fontsize=<span class="hljs-number">10</span>)<br>        ax.set_ylabel(target, fontsize=<span class="hljs-number">10</span>)<br>        ax.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        ax.tick_params(axis=<span class="hljs-string">&#x27;x&#x27;</span>, rotation=<span class="hljs-number">45</span>)<br>        ax.legend(fontsize=<span class="hljs-number">10</span>)<br>        <br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 双图布局</span><br>        fig, axes = plt.subplots(<span class="hljs-number">1</span>, n_cols, figsize=figsize)<br>        <br>        <span class="hljs-comment"># 1.1 原始时间序列</span><br>        axes[<span class="hljs-number">0</span>].plot(data[<span class="hljs-string">&#x27;date&#x27;</span>], data[target], color=<span class="hljs-string">&#x27;#2ecc71&#x27;</span>, alpha=<span class="hljs-number">0.7</span>, linewidth=<span class="hljs-number">2</span>)<br>        axes[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;target&#125;</span> Over Time&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>        axes[<span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">&#x27;Date&#x27;</span>, fontsize=<span class="hljs-number">10</span>)<br>        axes[<span class="hljs-number">0</span>].set_ylabel(target, fontsize=<span class="hljs-number">10</span>)<br>        axes[<span class="hljs-number">0</span>].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        axes[<span class="hljs-number">0</span>].tick_params(axis=<span class="hljs-string">&#x27;x&#x27;</span>, rotation=<span class="hljs-number">45</span>)<br>        <br>        <span class="hljs-comment"># 1.2 月度趋势（带标准差区间）</span><br>        df_temp = data.copy()<br>        df_temp.set_index(<span class="hljs-string">&#x27;date&#x27;</span>, inplace=<span class="hljs-literal">True</span>)<br>        resampled = df_temp[target].resample(<span class="hljs-string">&#x27;M&#x27;</span>)<br>        mean_values = resampled.mean()<br>        std_values = resampled.std()<br>        <br>        mean_values.plot(ax=axes[<span class="hljs-number">1</span>], color=<span class="hljs-string">&#x27;#3498db&#x27;</span>, label=<span class="hljs-string">&#x27;Mean&#x27;</span>, linewidth=<span class="hljs-number">2</span>)<br>        axes[<span class="hljs-number">1</span>].fill_between(<br>            mean_values.index,<br>            mean_values - std_values,<br>            mean_values + std_values,<br>            color=<span class="hljs-string">&#x27;#3498db&#x27;</span>,<br>            alpha=<span class="hljs-number">0.2</span>,<br>            label=<span class="hljs-string">&#x27;±1 std&#x27;</span><br>        )<br>        axes[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">f&#x27;Monthly <span class="hljs-subst">&#123;target&#125;</span> Trend&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>        axes[<span class="hljs-number">1</span>].legend(fontsize=<span class="hljs-number">10</span>)<br>        axes[<span class="hljs-number">1</span>].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        axes[<span class="hljs-number">1</span>].tick_params(axis=<span class="hljs-string">&#x27;x&#x27;</span>, rotation=<span class="hljs-number">45</span>)<br>    <br>    plt.tight_layout()<br>    plt.show()<br><br><br><br>analyze_basic_time_series(train_data, target=<span class="hljs-string">&#x27;count&#x27;</span>, n_cols=<span class="hljs-number">2</span>, figsize=(<span class="hljs-number">20</span>, <span class="hljs-number">8</span>))<br></code></pre></td></tr></table></figure><p><img src="/img/EDA-stacking_files/EDA-stacking_19_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_time_distributions</span>(<span class="hljs-params">data, target=<span class="hljs-string">&#x27;count&#x27;</span>, n_cols=<span class="hljs-number">1</span>, figsize=(<span class="hljs-params"><span class="hljs-number">20</span>, <span class="hljs-number">15</span></span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    时间分布分析：展示目标变量在不同时间维度上的分布</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - target: str, 目标变量名称</span><br><span class="hljs-string">    - n_cols: int, 图表列数，默认为2</span><br><span class="hljs-string">    - figsize: tuple, 图形大小</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 计算所需的行数</span><br>    n_plots = <span class="hljs-number">3</span>  <span class="hljs-comment"># 总共需要4个图表</span><br>    n_rows = (n_plots + n_cols - <span class="hljs-number">1</span>) // n_cols  <span class="hljs-comment"># 向上取整</span><br>    <br>    <span class="hljs-comment"># 创建子图</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <span class="hljs-comment"># 确保axes是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment"># 设置颜色</span><br>    colors = [<span class="hljs-string">&#x27;#3498db&#x27;</span>, <span class="hljs-string">&#x27;#2ecc71&#x27;</span>, <span class="hljs-string">&#x27;#e74c3c&#x27;</span>, <span class="hljs-string">&#x27;#f1c40f&#x27;</span>, <span class="hljs-string">&#x27;#9b59b6&#x27;</span>]<br>    <br>    <span class="hljs-comment"># 获取每个图表在网格中的位置</span><br>    plot_positions = [(i // n_cols, i % n_cols) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_plots)]<br>    <br>    <span class="hljs-comment"># 2.1 年度分布</span><br>    row, col = plot_positions[<span class="hljs-number">0</span>]<br>    sns.boxplot(x=<span class="hljs-string">&#x27;year&#x27;</span>, y=target, data=data, ax=axes[row, col], palette=<span class="hljs-string">&#x27;husl&#x27;</span>)<br>    axes[row, col].set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;target&#125;</span> Distribution by Year&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>    axes[row, col].tick_params(labelsize=<span class="hljs-number">10</span>)<br>    <br>    <span class="hljs-comment"># 2.2 季度-月份分布</span><br>    row, col = plot_positions[<span class="hljs-number">1</span>]<br>    sns.boxplot(x=<span class="hljs-string">&#x27;month&#x27;</span>, y=target, hue=<span class="hljs-string">&#x27;quarter&#x27;</span>, data=data, ax=axes[row, col], palette=<span class="hljs-string">&#x27;husl&#x27;</span>)<br>    axes[row, col].set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;target&#125;</span> Distribution by Month and Quarter&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>    axes[row, col].tick_params(labelsize=<span class="hljs-number">10</span>)<br>    <br>    <span class="hljs-comment"># 2.3 工作日-时间段分布</span><br>    row, col = plot_positions[<span class="hljs-number">2</span>]<br>    sns.boxplot(x=<span class="hljs-string">&#x27;hour&#x27;</span>, y=target, hue=<span class="hljs-string">&#x27;is_weekend&#x27;</span>, data=data, ax=axes[row, col], palette=[<span class="hljs-string">&#x27;#3498db&#x27;</span>, <span class="hljs-string">&#x27;#e74c3c&#x27;</span>])<br>    axes[row, col].set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;target&#125;</span> Distribution by Hour and Weekend Status&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>    axes[row, col].tick_params(labelsize=<span class="hljs-number">10</span>)<br>    <br>    <br>    <span class="hljs-comment"># 隐藏多余的子图</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_plots, n_rows * n_cols):<br>        row = i // n_cols<br>        col = i % n_cols<br>        fig.delaxes(axes[row, col])<br>    <br>    plt.tight_layout()<br>    plt.show()<br><br>analyze_time_distributions(train_data, target=<span class="hljs-string">&#x27;count&#x27;</span>, n_cols=<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">30</span>))<br><br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_20_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_cyclical_patterns</span>(<span class="hljs-params">data, target=<span class="hljs-string">&#x27;count&#x27;</span>, n_cols=<span class="hljs-number">2</span>, figsize=(<span class="hljs-params"><span class="hljs-number">20</span>, <span class="hljs-number">15</span></span>)</span>):<br><br><br>    <span class="hljs-comment"># 设置中文字体</span><br>    plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]  <span class="hljs-comment"># 用来正常显示中文标签</span><br>    plt.rcParams[<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 用来正常显示负号</span><br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    时间周期模式分析：展示目标变量在不同周期上的变化模式</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - target: str, 目标变量名称</span><br><span class="hljs-string">    - n_cols: int, 图表列数</span><br><span class="hljs-string">    - figsize: tuple, 图形大小</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    feature_maps = &#123;<br>        <span class="hljs-string">&#x27;weekday&#x27;</span>: &#123;<br>            <span class="hljs-number">0</span>:<span class="hljs-string">&quot;Monday&quot;</span>, <span class="hljs-number">1</span>:<span class="hljs-string">&quot;Tuesday&quot;</span>, <span class="hljs-number">2</span>:<span class="hljs-string">&quot;Wednesday&quot;</span>, <span class="hljs-number">3</span>:<span class="hljs-string">&quot;Thursday&quot;</span>,<br>            <span class="hljs-number">4</span>:<span class="hljs-string">&quot;Friday&quot;</span>, <span class="hljs-number">5</span>:<span class="hljs-string">&quot;Saturday&quot;</span>, <span class="hljs-number">6</span>:<span class="hljs-string">&quot;Sunday&quot;</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment"># 计算所需的行数</span><br>    n_plots = <span class="hljs-number">4</span>  <span class="hljs-comment"># 总共需要4个图表</span><br>    n_rows = (n_plots + n_cols - <span class="hljs-number">1</span>) // n_cols  <span class="hljs-comment"># 向上取整</span><br>    <br>    <span class="hljs-comment"># 创建子图</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <span class="hljs-comment"># 确保axes是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment"># 设置颜色</span><br>    colors = [<span class="hljs-string">&#x27;#3498db&#x27;</span>, <span class="hljs-string">&#x27;#2ecc71&#x27;</span>, <span class="hljs-string">&#x27;#e74c3c&#x27;</span>, <span class="hljs-string">&#x27;#f1c40f&#x27;</span>]<br>    <br>    <span class="hljs-comment"># 获取每个图表在网格中的位置</span><br>    plot_positions = [(i // n_cols, i % n_cols) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_plots)]<br>    <br>    <span class="hljs-comment"># # 3.1 月度模式</span><br>    <span class="hljs-comment"># row, col = plot_positions[0]</span><br>    <span class="hljs-comment"># monthly_pattern = data.groupby(&#x27;month&#x27;)[target].mean()</span><br>    <span class="hljs-comment"># monthly_pattern.plot(</span><br>    <span class="hljs-comment">#     kind=&#x27;line&#x27;, </span><br>    <span class="hljs-comment">#     ax=axes[row, col], </span><br>    <span class="hljs-comment">#     marker=&#x27;o&#x27;,</span><br>    <span class="hljs-comment">#     color=colors[0],</span><br>    <span class="hljs-comment">#     linewidth=2,</span><br>    <span class="hljs-comment">#     markersize=8</span><br>    <span class="hljs-comment"># )</span><br>    <span class="hljs-comment"># axes[row, col].set_title(&#x27;Monthly Pattern&#x27;, fontsize=12, pad=15)</span><br>    <span class="hljs-comment"># axes[row, col].grid(True, linestyle=&#x27;--&#x27;, alpha=0.7)</span><br>    <span class="hljs-comment"># axes[row, col].tick_params(labelsize=10)</span><br>    <br>    <span class="hljs-comment"># 3.2 每周模式</span><br>    row, col = plot_positions[<span class="hljs-number">1</span>]<br><br>    <span class="hljs-comment"># 绘制箱型图</span><br>    sns.boxplot(<br>        data=data,<br>        x=<span class="hljs-string">&#x27;weekday&#x27;</span>,<br>        y=target,<br>        ax=axes[row, col],<br>        color=<span class="hljs-string">&#x27;plum&#x27;</span>,  <span class="hljs-comment"># 设置为紫色</span><br>        width=<span class="hljs-number">0.7</span>,<br>        flierprops=&#123;   <span class="hljs-comment"># 异常值点的样式</span><br>            <span class="hljs-string">&#x27;marker&#x27;</span>: <span class="hljs-string">&#x27;D&#x27;</span>,<br>            <span class="hljs-string">&#x27;markerfacecolor&#x27;</span>: <span class="hljs-string">&#x27;gray&#x27;</span>,<br>            <span class="hljs-string">&#x27;markersize&#x27;</span>: <span class="hljs-number">4</span>,<br>            <span class="hljs-string">&#x27;alpha&#x27;</span>: <span class="hljs-number">0.5</span><br>        &#125;<br>    )<br><br>    <span class="hljs-comment"># 设置x轴标签</span><br>    axes[row, col].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>))<br>    axes[row, col].set_xticklabels(<br>        [<span class="hljs-string">&#x27;Monday&#x27;</span>, <span class="hljs-string">&#x27;Tuesday&#x27;</span>, <span class="hljs-string">&#x27;Wednesday&#x27;</span>, <span class="hljs-string">&#x27;Thursday&#x27;</span>, <span class="hljs-string">&#x27;Friday&#x27;</span>, <span class="hljs-string">&#x27;Saturday&#x27;</span>, <span class="hljs-string">&#x27;Sunday&#x27;</span>],<br>        rotation=<span class="hljs-number">0</span>  <span class="hljs-comment"># 不旋转标签</span><br>    )<br><br>    <span class="hljs-comment"># 设置图表样式</span><br>    axes[row, col].set_title(<span class="hljs-string">&#x27;Weekly Pattern&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>    axes[row, col].set_xlabel(<span class="hljs-string">&#x27;Weekday&#x27;</span>, fontsize=<span class="hljs-number">10</span>)<br>    axes[row, col].set_ylabel(<span class="hljs-string">&#x27;Count&#x27;</span>, fontsize=<span class="hljs-number">10</span>)<br>    axes[row, col].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>    axes[row, col].tick_params(labelsize=<span class="hljs-number">10</span>)<br><br>    <span class="hljs-comment"># 设置y轴范围，使其从0开始</span><br>    axes[row, col].set_ylim(bottom=<span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment"># 设置背景样式</span><br>    <span class="hljs-comment"># axes[row, col].set_facecolor(&#x27;#F0F0F0&#x27;)  # 浅灰色背景</span><br><br><br>    <br>    <span class="hljs-comment"># 3.3 每日模式</span><br>    row, col = plot_positions[<span class="hljs-number">2</span>]<br>    daily_pattern = data.groupby(<span class="hljs-string">&#x27;hour&#x27;</span>)[target].mean()<br>    daily_pattern.plot(<br>        kind=<span class="hljs-string">&#x27;line&#x27;</span>, <br>        ax=axes[row, col], <br>        marker=<span class="hljs-string">&#x27;o&#x27;</span>,<br>        color=colors[<span class="hljs-number">2</span>],<br>        linewidth=<span class="hljs-number">2</span>,<br>        markersize=<span class="hljs-number">8</span><br>    )<br>    axes[row, col].set_title(<span class="hljs-string">&#x27;Daily Pattern&#x27;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>    axes[row, col].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>    axes[row, col].tick_params(labelsize=<span class="hljs-number">10</span>)<br>    <br>    <span class="hljs-comment"># 3.4 工作日-小时模式</span><br>    row, col = plot_positions[<span class="hljs-number">3</span>]<br>    hour_weekday_agg = pd.DataFrame(<br>        data.groupby([<span class="hljs-string">&quot;hour&quot;</span>,<span class="hljs-string">&quot;weekday&quot;</span>], sort=<span class="hljs-literal">True</span>)[target].mean()<br>    ).reset_index()<br>    hour_weekday_agg[<span class="hljs-string">&#x27;weekday&#x27;</span>] = hour_weekday_agg[<span class="hljs-string">&#x27;weekday&#x27;</span>].<span class="hljs-built_in">map</span>(feature_maps[<span class="hljs-string">&#x27;weekday&#x27;</span>])<br>    <br>    sns.pointplot(<br>        data=hour_weekday_agg, <br>        x=<span class="hljs-string">&quot;hour&quot;</span>, <br>        y=target, <br>        hue=<span class="hljs-string">&quot;weekday&quot;</span>, <br>        ax=axes[row, col],<br>        palette=<span class="hljs-string">&#x27;husl&#x27;</span><br>    )<br>    axes[row, col].set_title(<span class="hljs-string">f&quot;Average <span class="hljs-subst">&#123;target&#125;</span> By Hour Across Weekdays&quot;</span>, fontsize=<span class="hljs-number">12</span>, pad=<span class="hljs-number">15</span>)<br>    axes[row, col].tick_params(axis=<span class="hljs-string">&#x27;x&#x27;</span>, rotation=<span class="hljs-number">45</span>, labelsize=<span class="hljs-number">10</span>)<br>    <br>    <span class="hljs-comment"># 修改图例位置：放在图表内部的右上角</span><br>    axes[row, col].legend(<br>        title=<span class="hljs-string">&#x27;Weekday&#x27;</span>, <br>        loc=<span class="hljs-string">&#x27;upper right&#x27;</span>,  <span class="hljs-comment"># 放在右上角</span><br>        bbox_to_anchor=(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>),  <span class="hljs-comment"># 微调位置</span><br>        fontsize=<span class="hljs-number">8</span>,  <span class="hljs-comment"># 减小字体大小</span><br>        title_fontsize=<span class="hljs-number">9</span>,  <span class="hljs-comment"># 减小标题字体大小</span><br>        ncol=<span class="hljs-number">1</span>  <span class="hljs-comment"># 可以根据需要调整列数</span><br>    )<br>    <br>    <span class="hljs-comment"># 隐藏多余的子图</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_plots, n_rows * n_cols):<br>        row = i // n_cols<br>        col = i % n_cols<br>        fig.delaxes(axes[row, col])<br>    <br>    plt.tight_layout()<br>    plt.show()<br><br>analyze_cyclical_patterns(train_data, target=<span class="hljs-string">&#x27;count&#x27;</span>, n_cols=<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">30</span>))<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_21_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><h2 id="统计量分析--单变量分析">统计量分析- 单变量分析</h2><h3 id="数值型特征">数值型特征</h3><h4 id="描述性统计量">描述性统计量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data.describe()<br></code></pre></td></tr></table></figure><div><style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style><table border="1" class="dataframe"><thead><tr style="text-align:right"><th></th><th>season</th><th>holiday</th><th>workingday</th><th>weather</th><th>temp</th><th>atemp</th><th>humidity</th><th>windspeed</th><th>casual</th><th>registered</th><th>count</th><th>year</th><th>month</th><th>day</th><th>hour</th><th>minute</th><th>weekday</th><th>quarter</th><th>is_weekend</th></tr></thead><tbody><tr><th>count</th><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.00000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td><td>10886.0</td><td>10886.000000</td><td>10886.000000</td><td>10886.000000</td></tr><tr><th>mean</th><td>2.506614</td><td>0.028569</td><td>0.680875</td><td>1.418427</td><td>20.23086</td><td>23.655084</td><td>61.886460</td><td>12.799395</td><td>36.021955</td><td>155.552177</td><td>191.574132</td><td>2011.501929</td><td>6.521495</td><td>9.992559</td><td>11.541613</td><td>0.0</td><td>3.013963</td><td>2.506614</td><td>0.290557</td></tr><tr><th>std</th><td>1.116174</td><td>0.166599</td><td>0.466159</td><td>0.633839</td><td>7.79159</td><td>8.474601</td><td>19.245033</td><td>8.164537</td><td>49.960477</td><td>151.039033</td><td>181.144454</td><td>0.500019</td><td>3.444373</td><td>5.476608</td><td>6.915838</td><td>0.0</td><td>2.004585</td><td>1.116174</td><td>0.454040</td></tr><tr><th>min</th><td>1.000000</td><td>0.000000</td><td>0.000000</td><td>1.000000</td><td>0.82000</td><td>0.760000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>1.000000</td><td>2011.000000</td><td>1.000000</td><td>1.000000</td><td>0.000000</td><td>0.0</td><td>0.000000</td><td>1.000000</td><td>0.000000</td></tr><tr><th>25%</th><td>2.000000</td><td>0.000000</td><td>0.000000</td><td>1.000000</td><td>13.94000</td><td>16.665000</td><td>47.000000</td><td>7.001500</td><td>4.000000</td><td>36.000000</td><td>42.000000</td><td>2011.000000</td><td>4.000000</td><td>5.000000</td><td>6.000000</td><td>0.0</td><td>1.000000</td><td>2.000000</td><td>0.000000</td></tr><tr><th>50%</th><td>3.000000</td><td>0.000000</td><td>1.000000</td><td>1.000000</td><td>20.50000</td><td>24.240000</td><td>62.000000</td><td>12.998000</td><td>17.000000</td><td>118.000000</td><td>145.000000</td><td>2012.000000</td><td>7.000000</td><td>10.000000</td><td>12.000000</td><td>0.0</td><td>3.000000</td><td>3.000000</td><td>0.000000</td></tr><tr><th>75%</th><td>4.000000</td><td>0.000000</td><td>1.000000</td><td>2.000000</td><td>26.24000</td><td>31.060000</td><td>77.000000</td><td>16.997900</td><td>49.000000</td><td>222.000000</td><td>284.000000</td><td>2012.000000</td><td>10.000000</td><td>15.000000</td><td>18.000000</td><td>0.0</td><td>5.000000</td><td>4.000000</td><td>1.000000</td></tr><tr><th>max</th><td>4.000000</td><td>1.000000</td><td>1.000000</td><td>4.000000</td><td>41.00000</td><td>45.455000</td><td>100.000000</td><td>56.996900</td><td>367.000000</td><td>886.000000</td><td>977.000000</td><td>2012.000000</td><td>12.000000</td><td>19.000000</td><td>23.000000</td><td>0.0</td><td>6.000000</td><td>4.000000</td><td>1.000000</td></tr></tbody></table></div><h4 id="直方图和q-q图">直方图和Q-Q图</h4><p>从下图可以看出，"count"变量向右偏斜。由于大多数机器学习技术要求因变量呈正态分布，因此最好是正态分布。一个可能的解决方案是在删除异常数据点后对"count"变量进行对数转换。转换后的数据看起来好多了，但仍然不是完全理想的正态分布。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_distributions</span>(<span class="hljs-params">data, features=<span class="hljs-literal">None</span>, figsize=(<span class="hljs-params"><span class="hljs-number">15</span>, <span class="hljs-number">5</span></span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    对数据集中的数值型特征进行分布可视化分析</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - features: list, 需要分析的特征列表，默认为None（分析所有数值型特征）</span><br><span class="hljs-string">    - figsize: tuple, 每个特征的图形大小，默认(15, 5)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 如果未指定特征，则选择所有数值型特征</span><br>    <span class="hljs-keyword">if</span> features <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        features = data.select_dtypes(include=[<span class="hljs-string">&#x27;int64&#x27;</span>, <span class="hljs-string">&#x27;float64&#x27;</span>]).columns<br>    <br>    <span class="hljs-comment"># 忽略 UserWarning</span><br>    <span class="hljs-keyword">import</span> warnings<br>    warnings.filterwarnings(<span class="hljs-string">&#x27;ignore&#x27;</span>, <span class="hljs-string">&#x27;p-value may not be accurate for N &gt; 5000&#x27;</span>)<br>    <br>    <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> features:<br>        <span class="hljs-comment"># 检查特征是否存在且为数值型</span><br>        <span class="hljs-keyword">if</span> feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不存在于数据集中&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> np.issubdtype(data[feature].dtype, np.number):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不是数值型变量&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>        <br>        <span class="hljs-comment"># 创建子图</span><br>        fig, (ax1, ax2) = plt.subplots(ncols=<span class="hljs-number">2</span>, nrows=<span class="hljs-number">1</span>, figsize=figsize)<br>        <br>        <span class="hljs-comment"># 1. 直方图 + 核密度估计-了解数据分布形状</span><br>        sns.histplot(data=data, x=feature, kde=<span class="hljs-literal">True</span>, ax=ax1)<br>        ax1.set_title(<span class="hljs-string">f&quot;Distribution of <span class="hljs-subst">&#123;feature&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-comment"># 添加描述性统计信息</span><br>        stats_info = (<span class="hljs-string">f&quot;Mean: <span class="hljs-subst">&#123;data[feature].mean():<span class="hljs-number">.2</span>f&#125;</span>\n&quot;</span><br>                     <span class="hljs-string">f&quot;Median: <span class="hljs-subst">&#123;data[feature].median():<span class="hljs-number">.2</span>f&#125;</span>\n&quot;</span><br>                     <span class="hljs-string">f&quot;Std: <span class="hljs-subst">&#123;data[feature].std():<span class="hljs-number">.2</span>f&#125;</span>\n&quot;</span><br>                     <span class="hljs-string">f&quot;Skew: <span class="hljs-subst">&#123;stats.skew(data[feature]):<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>        <br>        ax1.text(<span class="hljs-number">0.95</span>, <span class="hljs-number">0.95</span>, stats_info,<br>                transform=ax1.transAxes,<br>                verticalalignment=<span class="hljs-string">&#x27;top&#x27;</span>,<br>                horizontalalignment=<span class="hljs-string">&#x27;right&#x27;</span>,<br>                bbox=<span class="hljs-built_in">dict</span>(boxstyle=<span class="hljs-string">&#x27;round&#x27;</span>, facecolor=<span class="hljs-string">&#x27;white&#x27;</span>, alpha=<span class="hljs-number">0.8</span>))<br>        <br>        <span class="hljs-comment"># 2. Q-Q图-检验是否符合正态分布</span><br>        stats.probplot(data[feature], dist=<span class="hljs-string">&#x27;norm&#x27;</span>, fit=<span class="hljs-literal">True</span>, plot=ax2)<br>        ax2.set_title(<span class="hljs-string">f&quot;skew=<span class="hljs-subst">&#123;stats.skew(data[feature]):<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>        ax2.set_xlabel(feature)<br>        <span class="hljs-comment"># 调整布局</span><br>        plt.tight_layout()<br>        plt.show()<br><br><span class="hljs-comment"># 使用示例:</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 1. 分析所有数值型特征</span><br><span class="hljs-string">plot_distributions(train_data)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 2. 分析指定特征</span><br><span class="hljs-string">selected_features = [&#x27;temp&#x27;, &#x27;humidity&#x27;, &#x27;windspeed&#x27;, &#x27;count&#x27;]</span><br><span class="hljs-string">plot_distributions(train_data, features=selected_features)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 3. 自定义图形大小</span><br><span class="hljs-string">plot_distributions(train_data, features=[&#x27;count&#x27;], figsize=(12, 4))</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>selected_features = [<span class="hljs-string">&#x27;temp&#x27;</span> ,<span class="hljs-string">&#x27;atemp&#x27;</span>,<span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;windspeed&#x27;</span>, <span class="hljs-string">&#x27;casual&#x27;</span>,<span class="hljs-string">&#x27;registered&#x27;</span>,<span class="hljs-string">&#x27;count&#x27;</span>]<br>plot_distributions(train_data, features=selected_features)<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_28_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><figure><img src="/img/EDA-stacking_files/EDA-stacking_28_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_28_2.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_28_3.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_28_4.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_28_5.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_28_6.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><p>从这两张图可以得到以下重要信息：</p><ol type="1"><li>从分布图(左图)可以看出：</li></ol><ul><li>数据分布严重右偏（right-skewed）</li><li>大部分租赁数量集中在较低值区域（0-200左右）</li><li>分布呈现长尾特征，有少量高值样本</li><li>不符合正态分布的形状</li></ul><ol start="2" type="1"><li>从Q-Q图(右图)可以看出：</li></ol><ul><li>数据点与红色参考线（表示理想的正态分布）有明显偏离</li><li>在两端的偏离特别明显，说明分布的尾部与正态分布差异较大</li><li>曲线呈现S形，进一步确认了数据的偏态性</li></ul><p><strong>后序处理：</strong></p><ul><li>对数据进行转换使其更接近正态分布</li><li>考虑使用能处理非正态分布的模型</li></ul><h4 id="箱型图">箱型图</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_boxplots</span>(<span class="hljs-params">data, columns_to_plot, n_cols=<span class="hljs-number">2</span>,figsize=(<span class="hljs-params"><span class="hljs-number">10</span>, <span class="hljs-number">30</span></span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    绘制箱型图</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - columns_to_plot: list, 需要绘制箱型图的列名列表</span><br><span class="hljs-string">    - n_cols: int, 子图列数</span><br><span class="hljs-string">    - figsize: tuple, 图形大小，默认根据特征数量自动调整</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 计算所需行数</span><br>    n_features = <span class="hljs-built_in">len</span>(columns_to_plot)<br>    n_rows = (n_features - <span class="hljs-number">1</span>) // n_cols + <span class="hljs-number">1</span><br>    <br>    <span class="hljs-comment"># 创建子图</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <br>    <span class="hljs-comment"># 确保axes始终是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = np.array([[axes]])<br>    <span class="hljs-keyword">elif</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment"># 设置样式</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    colors = sns.color_palette(<span class="hljs-string">&quot;husl&quot;</span>, n_features)<br>    <br>    <span class="hljs-keyword">for</span> i, (col, color) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(columns_to_plot, colors)):<br>        row = i // n_cols<br>        col_idx = i % n_cols<br>        ax = axes[row, col_idx]<br>        <br>        <span class="hljs-comment"># 绘制箱型图</span><br>        sns.boxplot(data=data[col], <br>                   orient=<span class="hljs-string">&quot;h&quot;</span>,<br>                   width=<span class="hljs-number">0.7</span>,<br>                   color=color,<br>                   showfliers=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 显示异常值</span><br>                   ax=ax)<br>        <br>        <span class="hljs-comment"># 添加误差线</span><br>        mean = data[col].mean()<br>        std = data[col].std()<br>        ax.axvline(mean, color=<span class="hljs-string">&#x27;red&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.8</span>, label=<span class="hljs-string">&#x27;Mean&#x27;</span>)<br>        ax.axvline(mean + std, color=<span class="hljs-string">&#x27;green&#x27;</span>, linestyle=<span class="hljs-string">&#x27;:&#x27;</span>, alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">&#x27;Mean ± Std&#x27;</span>)<br>        ax.axvline(mean - std, color=<span class="hljs-string">&#x27;green&#x27;</span>, linestyle=<span class="hljs-string">&#x27;:&#x27;</span>, alpha=<span class="hljs-number">0.5</span>)<br>        <br>        <span class="hljs-comment"># 添加标题和标签</span><br>        ax.set_title(<span class="hljs-string">f&#x27;Distribution of <span class="hljs-subst">&#123;col&#125;</span>&#x27;</span>, <br>                    fontsize=<span class="hljs-number">12</span>, <br>                    pad=<span class="hljs-number">10</span>)<br>        ax.set_xlabel(<span class="hljs-string">&#x27;Value&#x27;</span>, fontsize=<span class="hljs-number">10</span>)<br>        <br>        <span class="hljs-comment"># 添加网格线</span><br>        ax.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        <br>        <span class="hljs-comment"># 美化刻度标签</span><br>        ax.tick_params(labelsize=<span class="hljs-number">10</span>)<br>        <br>        <span class="hljs-comment"># 添加描述性统计信息</span><br>        stats = data[col].describe()<br>        stats_text = (<span class="hljs-string">f&#x27;Mean: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;mean&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                     <span class="hljs-string">f&#x27;Std: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;std&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                     <span class="hljs-string">f&#x27;Min: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;min&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                     <span class="hljs-string">f&#x27;Max: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;max&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>&#x27;</span>)<br>        <br>        <span class="hljs-comment"># 将统计信息放在图的右上角</span><br>        ax.text(<span class="hljs-number">0.95</span>, <span class="hljs-number">0.95</span>, stats_text,<br>                transform=ax.transAxes,<br>                verticalalignment=<span class="hljs-string">&#x27;top&#x27;</span>,<br>                horizontalalignment=<span class="hljs-string">&#x27;right&#x27;</span>,<br>                bbox=<span class="hljs-built_in">dict</span>(boxstyle=<span class="hljs-string">&#x27;round&#x27;</span>, facecolor=<span class="hljs-string">&#x27;white&#x27;</span>, alpha=<span class="hljs-number">0.8</span>),<br>                fontsize=<span class="hljs-number">9</span>)<br>        <br>        <span class="hljs-comment"># 添加图例</span><br>        ax.legend(loc=<span class="hljs-string">&#x27;lower right&#x27;</span>, fontsize=<span class="hljs-number">8</span>)<br>    <br>    <span class="hljs-comment"># 处理多余的子图</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, n_rows * n_cols):<br>        row = i // n_cols<br>        col_idx = i % n_cols<br>        fig.delaxes(axes[row, col_idx])<br>    <br>    <span class="hljs-comment"># 调整布局</span><br>    plt.tight_layout(pad=<span class="hljs-number">3.0</span>)<br>    <br>    <span class="hljs-comment"># 添加总标题</span><br>    fig.suptitle(<span class="hljs-string">&#x27;Feature Distributions (Box Plots)&#x27;</span>, <br>                fontsize=<span class="hljs-number">14</span>, <br>                y=<span class="hljs-number">1.02</span>)<br>    <br>    plt.show()<br><br><span class="hljs-comment"># 使用示例</span><br>columns_to_plot = [<span class="hljs-string">&#x27;temp&#x27;</span>, <span class="hljs-string">&#x27;atemp&#x27;</span>, <span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;windspeed&#x27;</span>, <span class="hljs-string">&#x27;casual&#x27;</span>, <span class="hljs-string">&#x27;registered&#x27;</span>, <span class="hljs-string">&#x27;count&#x27;</span>]<br>plot_boxplots(train_data, columns_to_plot,n_cols=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_31_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><h4 id="核密度估计图-kde">核密度估计图 KDE</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_kde_distributions</span>(<span class="hljs-params">train_data, test_data, features_to_plot=<span class="hljs-literal">None</span>, figsize=<span class="hljs-literal">None</span>, n_cols=<span class="hljs-number">1</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    绘制训练集和测试集的KDE分布对比图</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - train_data: DataFrame, 训练数据</span><br><span class="hljs-string">    - test_data: DataFrame, 测试数据</span><br><span class="hljs-string">    - features_to_plot: list, 需要绘制的特征列表。如果为None,则使用test_data的所有列</span><br><span class="hljs-string">    - figsize: tuple, 图形大小。如果为None,则自动计算</span><br><span class="hljs-string">    - n_cols: int, 图表列数，默认为1</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 如果未指定特征,则使用测试集的所有数值型列</span><br>    <span class="hljs-keyword">if</span> features_to_plot <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        features_to_plot = test_data.select_dtypes(include=[<span class="hljs-string">&#x27;int64&#x27;</span>, <span class="hljs-string">&#x27;float64&#x27;</span>]).columns<br>    <br>    <span class="hljs-comment"># 检查特征是否存在且为数值型</span><br>    valid_features = []<br>    <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> features_to_plot:<br>        <span class="hljs-keyword">if</span> (feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> train_data.columns <span class="hljs-keyword">or</span> <br>            feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> test_data.columns):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不存在于训练集或测试集中&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        <span class="hljs-comment"># 检查数据类型是否为数值型</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pd.api.types.is_numeric_dtype(train_data[feature].astype(<span class="hljs-built_in">float</span>)):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不是数值型变量&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        valid_features.append(feature)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_features:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;错误: 没有有效的数值型特征可以绘制&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <br>    <span class="hljs-comment"># 计算行数</span><br>    n_rows = (<span class="hljs-built_in">len</span>(valid_features) + n_cols - <span class="hljs-number">1</span>) // n_cols<br>    <br>    <span class="hljs-comment"># 设置图形大小</span><br>    <span class="hljs-keyword">if</span> figsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        figsize = (<span class="hljs-number">6</span>*n_cols, <span class="hljs-number">4</span>*n_rows)<br>    <br>    <span class="hljs-comment"># 创建图形和子图网格</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = np.array([axes])<br>    axes = axes.flatten()<br>    <br>    <span class="hljs-comment"># 遍历特征绘制KDE图</span><br>    <span class="hljs-keyword">for</span> i, col <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(valid_features):<br>        <span class="hljs-comment"># 获取当前子图</span><br>        ax = axes[i]<br>        <br>        <span class="hljs-comment"># 绘制训练集KDE</span><br>        sns.kdeplot(data=train_data[col].astype(<span class="hljs-built_in">float</span>),<br>                   color=<span class="hljs-string">&quot;Red&quot;</span>, <br>                   fill=<span class="hljs-literal">True</span>,<br>                   label=<span class="hljs-string">&quot;train&quot;</span>,<br>                   ax=ax)<br>        <br>        <span class="hljs-comment"># 绘制测试集KDE</span><br>        sns.kdeplot(data=test_data[col].astype(<span class="hljs-built_in">float</span>),<br>                   color=<span class="hljs-string">&quot;Blue&quot;</span>, <br>                   fill=<span class="hljs-literal">True</span>,<br>                   label=<span class="hljs-string">&quot;test&quot;</span>,<br>                   ax=ax)<br>        <br>        <span class="hljs-comment"># 设置标签</span><br>        ax.set_xlabel(col)<br>        ax.set_ylabel(<span class="hljs-string">&quot;Frequency&quot;</span>)<br>        ax.legend()<br>    <br>    <span class="hljs-comment"># 隐藏多余的子图</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i+<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(axes)):<br>        axes[j].set_visible(<span class="hljs-literal">False</span>)<br>    <br>    <span class="hljs-comment"># 调整布局</span><br>    plt.tight_layout()<br>    plt.show()<br><br><span class="hljs-comment"># 使用示例:</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 1. 默认单列显示</span><br><span class="hljs-string">plot_kde_distributions(train_data, test_data)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 2. 双列显示</span><br><span class="hljs-string">plot_kde_distributions(</span><br><span class="hljs-string">    train_data, </span><br><span class="hljs-string">    test_data,</span><br><span class="hljs-string">    n_cols=2,</span><br><span class="hljs-string">    figsize=(15, 20)</span><br><span class="hljs-string">)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 3. 三列显示特定特征</span><br><span class="hljs-string">features_to_plot = [&#x27;temp&#x27;, &#x27;humidity&#x27;, &#x27;windspeed&#x27;, &#x27;casual&#x27;, &#x27;registered&#x27;, &#x27;count&#x27;]</span><br><span class="hljs-string">plot_kde_distributions(</span><br><span class="hljs-string">    train_data, </span><br><span class="hljs-string">    test_data,</span><br><span class="hljs-string">    features_to_plot=features_to_plot,</span><br><span class="hljs-string">    n_cols=3,</span><br><span class="hljs-string">    figsize=(18, 8)</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>features_to_plot = [<span class="hljs-string">&quot;season&quot;</span>,<span class="hljs-string">&quot;holiday&quot;</span>,<span class="hljs-string">&quot;workingday&quot;</span>,<span class="hljs-string">&quot;weather&quot;</span>,<span class="hljs-string">&quot;temp&quot;</span>,<span class="hljs-string">&quot;atemp&quot;</span>,<span class="hljs-string">&quot;humidity&quot;</span>,<span class="hljs-string">&quot;windspeed&quot;</span>]<br>plot_kde_distributions(<br>    train_data, <br>    submit_data,<br>    features_to_plot = features_to_plot,<br>    n_cols=<span class="hljs-number">2</span>,<br>    figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">15</span>)<br>)<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_34_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><h4 id="小提琴图">小提琴图</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_violinplots</span>(<span class="hljs-params">data, columns_to_plot, n_cols=<span class="hljs-number">2</span>,figsize=(<span class="hljs-params"><span class="hljs-number">10</span>, <span class="hljs-number">30</span></span>)</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    绘制小提琴图</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - columns_to_plot: list, 需要绘制小提琴图的列名列表</span><br><span class="hljs-string">    - n_cols: int, 子图列数</span><br><span class="hljs-string">    - figsize: tuple, 图形大小，默认根据特征数量自动调整</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 计算所需行数</span><br>    n_features = <span class="hljs-built_in">len</span>(columns_to_plot)<br>    n_rows = (n_features - <span class="hljs-number">1</span>) // n_cols + <span class="hljs-number">1</span><br>    <br>    <span class="hljs-comment"># 创建子图</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <br>    <span class="hljs-comment"># 确保axes始终是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = np.array([[axes]])<br>    <span class="hljs-keyword">elif</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment"># 设置样式</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    colors = sns.color_palette(<span class="hljs-string">&quot;husl&quot;</span>, n_features)<br>    <br>    <span class="hljs-keyword">for</span> i, (col, color) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(columns_to_plot, colors)):<br>        row = i // n_cols<br>        col_idx = i % n_cols<br>        ax = axes[row, col_idx]<br>        <br>        <span class="hljs-comment"># 绘制小提琴图</span><br>        sns.violinplot(data=data[col], <br>                   orient=<span class="hljs-string">&quot;h&quot;</span>,<br>                   width=<span class="hljs-number">0.7</span>,<br>                   color=color,<br>                   ax=ax)<br>        <br>        <span class="hljs-comment"># 添加误差线</span><br>        mean = data[col].mean()<br>        std = data[col].std()<br>        ax.axvline(mean, color=<span class="hljs-string">&#x27;red&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.8</span>, label=<span class="hljs-string">&#x27;Mean&#x27;</span>)<br>        ax.axvline(mean + std, color=<span class="hljs-string">&#x27;green&#x27;</span>, linestyle=<span class="hljs-string">&#x27;:&#x27;</span>, alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">&#x27;Mean ± Std&#x27;</span>)<br>        ax.axvline(mean - std, color=<span class="hljs-string">&#x27;green&#x27;</span>, linestyle=<span class="hljs-string">&#x27;:&#x27;</span>, alpha=<span class="hljs-number">0.5</span>)<br>        <br>        <span class="hljs-comment"># 添加标题和标签</span><br>        ax.set_title(<span class="hljs-string">f&#x27;Distribution of <span class="hljs-subst">&#123;col&#125;</span>&#x27;</span>, <br>                    fontsize=<span class="hljs-number">12</span>, <br>                    pad=<span class="hljs-number">10</span>)<br>        ax.set_xlabel(<span class="hljs-string">&#x27;Value&#x27;</span>, fontsize=<span class="hljs-number">10</span>)<br>        <br>        <span class="hljs-comment"># 添加网格线</span><br>        ax.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        <br>        <span class="hljs-comment"># 美化刻度标签</span><br>        ax.tick_params(labelsize=<span class="hljs-number">10</span>)<br>        <br>        <span class="hljs-comment"># 添加描述性统计信息</span><br>        stats = data[col].describe()<br>        stats_text = (<span class="hljs-string">f&#x27;Mean: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;mean&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                     <span class="hljs-string">f&#x27;Std: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;std&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                     <span class="hljs-string">f&#x27;Min: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;min&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                     <span class="hljs-string">f&#x27;Max: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;max&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>&#x27;</span>)<br>        <br>        <span class="hljs-comment"># 将统计信息放在图的右上角</span><br>        ax.text(<span class="hljs-number">0.95</span>, <span class="hljs-number">0.95</span>, stats_text,<br>                transform=ax.transAxes,<br>                verticalalignment=<span class="hljs-string">&#x27;top&#x27;</span>,<br>                horizontalalignment=<span class="hljs-string">&#x27;right&#x27;</span>,<br>                bbox=<span class="hljs-built_in">dict</span>(boxstyle=<span class="hljs-string">&#x27;round&#x27;</span>, facecolor=<span class="hljs-string">&#x27;white&#x27;</span>, alpha=<span class="hljs-number">0.8</span>),<br>                fontsize=<span class="hljs-number">9</span>)<br>        <br>        <span class="hljs-comment"># 添加图例</span><br>        ax.legend(loc=<span class="hljs-string">&#x27;lower right&#x27;</span>, fontsize=<span class="hljs-number">8</span>)<br>    <br>    <span class="hljs-comment"># 处理多余的子图</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, n_rows * n_cols):<br>        row = i // n_cols<br>        col_idx = i % n_cols<br>        fig.delaxes(axes[row, col_idx])<br>    <br>    <span class="hljs-comment"># 调整布局</span><br>    plt.tight_layout(pad=<span class="hljs-number">3.0</span>)<br>    <br>    <span class="hljs-comment"># 添加总标题</span><br>    fig.suptitle(<span class="hljs-string">&#x27;Feature Distributions (Violin Plots)&#x27;</span>, <br>                fontsize=<span class="hljs-number">14</span>, <br>                y=<span class="hljs-number">1.02</span>)<br>    <br>    plt.show()<br><br><span class="hljs-comment"># 使用示例</span><br>columns_to_plot = [<span class="hljs-string">&#x27;temp&#x27;</span>, <span class="hljs-string">&#x27;atemp&#x27;</span>, <span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;windspeed&#x27;</span>, <span class="hljs-string">&#x27;casual&#x27;</span>, <span class="hljs-string">&#x27;registered&#x27;</span>, <span class="hljs-string">&#x27;count&#x27;</span>]<br>plot_violinplots(train_data, columns_to_plot,n_cols=<span class="hljs-number">2</span>,figsize=(<span class="hljs-number">10</span>,<span class="hljs-number">15</span>))<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_36_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><h3 id="类别型特征">类别型特征</h3><h4 id="描述性统计量及条形图">描述性统计量及条形图</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_categorical_features</span>(<span class="hljs-params">data, categorical_features=<span class="hljs-literal">None</span>, target=<span class="hljs-literal">None</span>, n_cols=<span class="hljs-number">2</span>, figsize=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    分析类别型特征的描述性统计量和可视化</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - categorical_features: list or None, 需要分析的类别型特征列表，默认为None(自动选择)</span><br><span class="hljs-string">    - target: str or None, 目标变量名，默认为None</span><br><span class="hljs-string">    - n_cols: int, 子图列数，默认为2</span><br><span class="hljs-string">    - figsize: tuple or None, 图形大小，默认为None(自动计算大小)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1. 特征选择</span><br>    <span class="hljs-keyword">if</span> categorical_features <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        categorical_features = data.select_dtypes(include=[<span class="hljs-string">&#x27;object&#x27;</span>, <span class="hljs-string">&#x27;category&#x27;</span>, <span class="hljs-string">&#x27;int64&#x27;</span>]).columns.tolist()<br>        <span class="hljs-keyword">if</span> target <span class="hljs-keyword">in</span> categorical_features:<br>            categorical_features.remove(target)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;自动检测到的分类特征: <span class="hljs-subst">&#123;categorical_features&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 2. 特征验证</span><br>    valid_features = []<br>    <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> categorical_features:<br>        <span class="hljs-keyword">if</span> feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不存在&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>        <br>        n_unique = data[feature].nunique()<br>        <span class="hljs-keyword">if</span> n_unique &gt; <span class="hljs-number">50</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: <span class="hljs-subst">&#123;feature&#125;</span> 的唯一值过多(<span class="hljs-subst">&#123;n_unique&#125;</span>)&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        valid_features.append(feature)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_features:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;错误: 没有有效的分类特征&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <br>    <span class="hljs-comment"># 3. 计算布局</span><br>    n_features = <span class="hljs-built_in">len</span>(valid_features)<br>    n_rows = (n_features + n_cols - <span class="hljs-number">1</span>) // n_cols<br>    <br>    <span class="hljs-comment"># 4. 设置图形大小</span><br>    <span class="hljs-keyword">if</span> figsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        width = <span class="hljs-number">6</span> * n_cols<br>        height = <span class="hljs-number">5</span> * n_rows<br>        figsize = (width, height)<br>    <br>    <span class="hljs-comment"># 5. 创建图形</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <br>    <span class="hljs-comment"># 确保 axes 是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = np.array([[axes]])<br>    <span class="hljs-keyword">elif</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment"># 6. 设置样式</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    colors = sns.color_palette(<span class="hljs-string">&quot;husl&quot;</span>, n_features)<br>    <br>    <span class="hljs-comment"># 7. 遍历特征进行分析和可视化</span><br>    <span class="hljs-keyword">for</span> idx, (feature, color) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(valid_features, colors)):<br>        row = idx // n_cols<br>        col = idx % n_cols<br>        ax = axes[row][col] <span class="hljs-keyword">if</span> n_rows &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n_cols &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> axes[col]<br>        <br>        <span class="hljs-comment"># 计算描述性统计量</span><br>        value_counts = data[feature].value_counts()<br>        percentages = data[feature].value_counts(normalize=<span class="hljs-literal">True</span>) * <span class="hljs-number">100</span><br>        stats_df = pd.DataFrame(&#123;<br>            <span class="hljs-string">&#x27;Count&#x27;</span>: value_counts,<br>            <span class="hljs-string">&#x27;Percentage&#x27;</span>: percentages<br>        &#125;)<br>        <br>        <span class="hljs-comment"># 打印描述性统计量</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n=== <span class="hljs-subst">&#123;feature.capitalize()&#125;</span> 的描述性统计 ===&quot;</span>)<br>        <span class="hljs-built_in">print</span>(stats_df)<br>        <br>        <span class="hljs-comment"># 绘制条形图</span><br>        sns.barplot(<br>            x=stats_df.index,<br>            y=<span class="hljs-string">&#x27;Count&#x27;</span>,<br>            data=stats_df,<br>            ax=ax,<br>            color=color<br>        )<br>        <br>        <span class="hljs-comment"># 设置标题和标签</span><br>        ax.set_title(<span class="hljs-string">f&#x27;Distribution of <span class="hljs-subst">&#123;feature.capitalize()&#125;</span>&#x27;</span>, fontsize=<span class="hljs-number">14</span>, pad=<span class="hljs-number">20</span>)<br>        ax.set_xlabel(feature.capitalize(), fontsize=<span class="hljs-number">12</span>)<br>        ax.set_ylabel(<span class="hljs-string">&#x27;Count&#x27;</span>, fontsize=<span class="hljs-number">12</span>)<br>        <br>        <span class="hljs-comment"># 设置刻度</span><br>        ax.tick_params(axis=<span class="hljs-string">&#x27;both&#x27;</span>, labelsize=<span class="hljs-number">10</span>)<br>        ax.tick_params(axis=<span class="hljs-string">&#x27;x&#x27;</span>, rotation=<span class="hljs-number">45</span>)<br>        <br>        <span class="hljs-comment"># 添加网格</span><br>        ax.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>    <br>    <span class="hljs-comment"># 8. 删除多余的子图</span><br>    <span class="hljs-keyword">if</span> n_features % n_cols != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (n_rows &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n_cols &gt; <span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_features, n_rows * n_cols):<br>            row = j // n_cols<br>            col = j % n_cols<br>            fig.delaxes(axes[row][col])<br>    <br>    <span class="hljs-comment"># 9. 调整布局</span><br>    plt.tight_layout(pad=<span class="hljs-number">3.0</span>)<br>    <br>    <span class="hljs-comment"># 10. 添加总标题</span><br>    fig.suptitle(<br>        <span class="hljs-string">&#x27;Categorical Feature Analysis&#x27;</span>, <br>        fontsize=<span class="hljs-number">16</span>, <br>        y=<span class="hljs-number">1.02</span><br>    )<br>    <br>    plt.show()<br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 基本使用</span><br><span class="hljs-string">analyze_categorical_features(train_data)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 指定特征</span><br><span class="hljs-string">analyze_categorical_features(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    categorical_features=[&#x27;season&#x27;, &#x27;holiday&#x27;, &#x27;workingday&#x27;, &#x27;weather&#x27;]</span><br><span class="hljs-string">)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 自定义大小</span><br><span class="hljs-string">analyze_categorical_features(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    categorical_features=[&#x27;hour&#x27;, &#x27;weekday&#x27;, &#x27;month&#x27;],</span><br><span class="hljs-string">    figsize=(15, 20)</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>categorical_features=[<span class="hljs-string">&#x27;season&#x27;</span>,<span class="hljs-string">&#x27;holiday&#x27;</span>,  <span class="hljs-string">&#x27;workingday&#x27;</span>,<span class="hljs-string">&#x27;weather&#x27;</span>,<span class="hljs-string">&#x27;weekday&#x27;</span>]<br>analyze_categorical_features(<br>    data=train_data,<br>    categorical_features=categorical_features,<br>    n_cols=<span class="hljs-number">2</span><br>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">=== Season 的描述性统计 ===
   Count  Percentage
4   2734   25.114826
2   2733   25.105640
3   2733   25.105640
1   2686   24.673893

=== Holiday 的描述性统计 ===
   Count  Percentage
0  10575    97.14312
1    311     2.85688

=== Workingday 的描述性统计 ===
   Count  Percentage
1   7412   68.087452
0   3474   31.912548

=== Weather 的描述性统计 ===
   Count  Percentage
1   7192   66.066507
2   2834   26.033437
3    859    7.890869
4      1    0.009186

=== Weekday 的描述性统计 ===
   Count  Percentage
5   1584   14.550799
6   1579   14.504869
3   1553   14.266030
0   1551   14.247658
2   1551   14.247658
1   1539   14.137424
4   1529   14.045563</code></pre><figure><img src="/img/EDA-stacking_files/EDA-stacking_39_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><h2 id="统计量分析--双变量多变量分析">统计量分析- 双变量/多变量分析</h2><h3 id="数值型特征-vs.-数值型特征">1. 数值型特征 vs. 数值型特征</h3><h4 id="散点图">散点图</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_feature_target_relationships</span>(<span class="hljs-params">data, features_to_plot=<span class="hljs-literal">None</span>, target=<span class="hljs-string">&#x27;count&#x27;</span>, figsize=<span class="hljs-literal">None</span>, n_cols=<span class="hljs-number">1</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    绘制特征与目标变量的关系图，支持自定义布局</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - features_to_plot: list or None, 需要绘制的特征列表，默认为None(自动选择数值特征)</span><br><span class="hljs-string">    - target: str, 目标变量名，默认为&#x27;count&#x27;</span><br><span class="hljs-string">    - figsize: tuple or None, 图形大小，默认为None(自动计算大小)</span><br><span class="hljs-string">    - n_cols: int, 子图列数，默认为1</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1. 特征选择</span><br>    <span class="hljs-keyword">if</span> features_to_plot <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        features_to_plot = data.select_dtypes(include=[<span class="hljs-string">&#x27;int64&#x27;</span>, <span class="hljs-string">&#x27;float64&#x27;</span>]).columns.tolist()<br>        <span class="hljs-keyword">if</span> target <span class="hljs-keyword">in</span> features_to_plot:<br>            features_to_plot.remove(target)<br>    <br>    <span class="hljs-comment"># 2. 计算行列数</span><br>    n_features = <span class="hljs-built_in">len</span>(features_to_plot)<br>    n_rows = (n_features - <span class="hljs-number">1</span>) // n_cols + <span class="hljs-number">1</span><br>    <br>    <span class="hljs-comment"># 3. 智能计算图形尺寸（如果未指定）</span><br>    <span class="hljs-keyword">if</span> figsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        width = <span class="hljs-number">6</span> * n_cols  <span class="hljs-comment"># 每列6个单位宽度</span><br>        height = <span class="hljs-number">5</span> * n_rows  <span class="hljs-comment"># 每行5个单位高度</span><br>        figsize = (width, height)<br>    <br>    <span class="hljs-comment"># 4. 创建图形</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <br>    <span class="hljs-comment"># 确保axes是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = np.array([[axes]])<br>    <span class="hljs-keyword">elif</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment"># 5. 设置样式</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    colors = sns.color_palette(<span class="hljs-string">&quot;husl&quot;</span>, n_features)<br>    <br>    <span class="hljs-comment"># 6. 绘制每个特征</span><br>    <span class="hljs-keyword">for</span> idx, (feature, color) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(features_to_plot, colors)):<br>        row = idx // n_cols<br>        col = idx % n_cols<br>        ax = axes[row, col]<br>        <br>        <span class="hljs-comment"># 散点图和回归线</span><br>        sns.regplot(<br>            x=feature, <br>            y=target, <br>            data=data,<br>            ax=ax,<br>            scatter_kws=&#123;<br>                <span class="hljs-string">&#x27;alpha&#x27;</span>: <span class="hljs-number">0.5</span>,<br>                <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-number">50</span>,<br>                <span class="hljs-string">&#x27;color&#x27;</span>: color<br>            &#125;,<br>            <span class="hljs-comment"># line_kws=&#123;</span><br>            <span class="hljs-comment">#     &#x27;color&#x27;: &#x27;red&#x27;,</span><br>            <span class="hljs-comment">#     &#x27;linewidth&#x27;: 2</span><br>            <span class="hljs-comment"># &#125;</span><br>        )<br>        <br>        <span class="hljs-comment"># 设置标题和标签</span><br>        ax.set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;feature&#125;</span> vs <span class="hljs-subst">&#123;target&#125;</span>&#x27;</span>, fontsize=<span class="hljs-number">14</span>, pad=<span class="hljs-number">20</span>)<br>        ax.set_xlabel(feature, fontsize=<span class="hljs-number">12</span>)<br>        ax.set_ylabel(target, fontsize=<span class="hljs-number">12</span>)<br>        <br>        <span class="hljs-comment"># 设置刻度</span><br>        ax.tick_params(axis=<span class="hljs-string">&#x27;both&#x27;</span>, labelsize=<span class="hljs-number">10</span>)<br>        <br>        <span class="hljs-comment"># 添加网格</span><br>        ax.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        <br>        <span class="hljs-comment"># 添加相关系数</span><br>        corr = data[[feature, target]].corr().iloc[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]<br>        ax.text(<br>            <span class="hljs-number">0.05</span>, <span class="hljs-number">0.95</span>, <br>            <span class="hljs-string">f&#x27;Correlation: <span class="hljs-subst">&#123;corr:<span class="hljs-number">.2</span>f&#125;</span>&#x27;</span>,<br>            transform=ax.transAxes,<br>            fontsize=<span class="hljs-number">12</span>,<br>            bbox=<span class="hljs-built_in">dict</span>(facecolor=<span class="hljs-string">&#x27;white&#x27;</span>, alpha=<span class="hljs-number">0.8</span>)<br>        )<br>    <br>    <span class="hljs-comment"># 7. 删除多余的子图</span><br>    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_features, n_rows * n_cols):<br>        row = idx // n_cols<br>        col = idx % n_cols<br>        fig.delaxes(axes[row, col])<br>    <br>    <span class="hljs-comment"># 8. 调整布局</span><br>    plt.tight_layout(pad=<span class="hljs-number">3.0</span>)<br>    <br>    <span class="hljs-comment"># 9. 添加总标题</span><br>    fig.suptitle(<br>        <span class="hljs-string">f&#x27;Feature Relationships with <span class="hljs-subst">&#123;target&#125;</span>&#x27;</span>, <br>        fontsize=<span class="hljs-number">16</span>, <br>        y=<span class="hljs-number">1.02</span><br>    )<br>    <br>    <span class="hljs-comment"># 10. 只显示图形,不返回对象</span><br>    plt.show()<br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 1. 默认单列布局</span><br><span class="hljs-string">plot_feature_target_relationships(train_data)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 2. 双列布局</span><br><span class="hljs-string">plot_feature_target_relationships(train_data, n_cols=2)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 3. 三列布局并自定义大小</span><br><span class="hljs-string">plot_feature_target_relationships(</span><br><span class="hljs-string">    train_data,</span><br><span class="hljs-string">    n_cols=3,</span><br><span class="hljs-string">    figsize=(20, 15)</span><br><span class="hljs-string">)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 4. 完整自定义</span><br><span class="hljs-string">features = [&#x27;temp&#x27;, &#x27;atemp&#x27;, &#x27;humidity&#x27;, &#x27;windspeed&#x27;]</span><br><span class="hljs-string">plot_feature_target_relationships(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    features_to_plot=features,</span><br><span class="hljs-string">    target=&#x27;registered&#x27;,</span><br><span class="hljs-string">    n_cols=2,</span><br><span class="hljs-string">    figsize=(15, 10)</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>features_to_plot = [<span class="hljs-string">&#x27;temp&#x27;</span>, <span class="hljs-string">&#x27;atemp&#x27;</span>, <span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;windspeed&#x27;</span>, <span class="hljs-string">&#x27;casual&#x27;</span>, <span class="hljs-string">&#x27;registered&#x27;</span>]<br>plot_feature_target_relationships(<br>    train_data,<br>    features_to_plot,<br>    target=<span class="hljs-string">&#x27;count&#x27;</span>,<br>    n_cols=<span class="hljs-number">2</span>,<br>)<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_43_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><h4 id="热力图">热力图</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_feature_correlations</span>(<span class="hljs-params"></span><br><span class="hljs-params">    data, </span><br><span class="hljs-params">    target=<span class="hljs-string">&#x27;target&#x27;</span>, </span><br><span class="hljs-params">    k=<span class="hljs-number">10</span>, </span><br><span class="hljs-params">    threshold=<span class="hljs-number">0.5</span>, </span><br><span class="hljs-params">    figsize=(<span class="hljs-params"><span class="hljs-number">12</span>, <span class="hljs-number">8</span></span>),</span><br><span class="hljs-params">    exclude_features=<span class="hljs-literal">None</span>  <span class="hljs-comment"># 新增参数：要排除的特征列表</span></span><br><span class="hljs-params"></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    分析特征与目标变量的相关性</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - target: str, 目标变量名</span><br><span class="hljs-string">    - k: int, 选择最相关的特征数量</span><br><span class="hljs-string">    - threshold: float, 相关系数阈值</span><br><span class="hljs-string">    - figsize: tuple, 图形大小</span><br><span class="hljs-string">    - exclude_features: list, 要排除的特征列表，默认为None</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    返回:</span><br><span class="hljs-string">    - dict: 包含分析结果的字典</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 处理要排除的特征</span><br>    <span class="hljs-keyword">if</span> exclude_features <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        exclude_features = []<br>    <br>    <span class="hljs-comment"># 确保target不在排除列表中</span><br>    <span class="hljs-keyword">if</span> target <span class="hljs-keyword">in</span> exclude_features:<br>        exclude_features.remove(target)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告：目标变量 <span class="hljs-subst">&#123;target&#125;</span> 已从排除列表中移除&quot;</span>)<br>    <br>    <span class="hljs-comment"># 获取参与分析的特征列</span><br>    analysis_features = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> data.columns <br>                        <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> exclude_features]<br>    <br>    <span class="hljs-comment"># 使用筛选后的特征计算相关系数矩阵</span><br>    corr_matrix = data[analysis_features].corr()<br>    <br>    <span class="hljs-comment"># 相关性强度阈值</span><br>    correlation_thresholds = &#123;<br>        <span class="hljs-string">&#x27;extremely_strong&#x27;</span>: <span class="hljs-number">0.7</span>,  <span class="hljs-comment"># 极强相关</span><br>        <span class="hljs-string">&#x27;strong&#x27;</span>: <span class="hljs-number">0.5</span>,           <span class="hljs-comment"># 强相关</span><br>        <span class="hljs-string">&#x27;moderate&#x27;</span>: <span class="hljs-number">0.3</span>,         <span class="hljs-comment"># 中等相关</span><br>        <span class="hljs-string">&#x27;weak&#x27;</span>: <span class="hljs-number">0.1</span>              <span class="hljs-comment"># 弱相关</span><br>    &#125;<br>    <br>    <span class="hljs-comment"># 创建图形</span><br>    plt.figure(figsize=figsize)<br>    <br>    <span class="hljs-comment"># 创建遮罩</span><br>    mask = np.zeros_like(corr_matrix, dtype=<span class="hljs-built_in">bool</span>)<br>    mask[np.triu_indices_from(mask)] = <span class="hljs-literal">True</span><br>    <br>    <span class="hljs-comment"># 绘制热力图</span><br>    cmap = sns.diverging_palette(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, as_cmap=<span class="hljs-literal">True</span>)<br>    sns.heatmap(corr_matrix, <br>                mask=mask,<br>                cmap=cmap,<br>                square=<span class="hljs-literal">True</span>,<br>                annot=<span class="hljs-literal">True</span>,<br>                fmt=<span class="hljs-string">&#x27;.2f&#x27;</span>,<br>                cbar=<span class="hljs-literal">True</span>,<br>                linewidths=<span class="hljs-number">.5</span>,<br>                linecolor=<span class="hljs-string">&#x27;white&#x27;</span><br>                ) <br>    plt.title(<span class="hljs-string">&#x27;Feature Correlation Heatmap&#x27;</span>)<br>    plt.xticks(rotation=<span class="hljs-number">45</span>, ha=<span class="hljs-string">&#x27;right&#x27;</span>)  <span class="hljs-comment"># 优化x轴标签显示</span><br>    plt.yticks(rotation=<span class="hljs-number">0</span>)<br>    plt.tight_layout()  <span class="hljs-comment"># 优化布局</span><br>    plt.show()<br>    <br>    <span class="hljs-comment"># 获取所有特征与目标变量的相关系数并排序</span><br>    target_correlations = corr_matrix[target].sort_values(ascending=<span class="hljs-literal">False</span>)<br>    <br>    <span class="hljs-comment"># 按相关性强度分类特征</span><br>    correlation_categories = &#123;<br>        <span class="hljs-string">&#x27;extremely_strong&#x27;</span>: [],<br>        <span class="hljs-string">&#x27;strong&#x27;</span>: [],<br>        <span class="hljs-string">&#x27;moderate&#x27;</span>: [],<br>        <span class="hljs-string">&#x27;weak&#x27;</span>: [],<br>        <span class="hljs-string">&#x27;very_weak&#x27;</span>: []<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> feature, corr <span class="hljs-keyword">in</span> target_correlations.items():<br>        <span class="hljs-keyword">if</span> feature == target:<br>            <span class="hljs-keyword">continue</span><br>        abs_corr = <span class="hljs-built_in">abs</span>(corr)<br>        <span class="hljs-keyword">if</span> abs_corr &gt;= correlation_thresholds[<span class="hljs-string">&#x27;extremely_strong&#x27;</span>]:<br>            correlation_categories[<span class="hljs-string">&#x27;extremely_strong&#x27;</span>].append((feature, corr))<br>        <span class="hljs-keyword">elif</span> abs_corr &gt;= correlation_thresholds[<span class="hljs-string">&#x27;strong&#x27;</span>]:<br>            correlation_categories[<span class="hljs-string">&#x27;strong&#x27;</span>].append((feature, corr))<br>        <span class="hljs-keyword">elif</span> abs_corr &gt;= correlation_thresholds[<span class="hljs-string">&#x27;moderate&#x27;</span>]:<br>            correlation_categories[<span class="hljs-string">&#x27;moderate&#x27;</span>].append((feature, corr))<br>        <span class="hljs-keyword">elif</span> abs_corr &gt;= correlation_thresholds[<span class="hljs-string">&#x27;weak&#x27;</span>]:<br>            correlation_categories[<span class="hljs-string">&#x27;weak&#x27;</span>].append((feature, corr))<br>        <span class="hljs-keyword">else</span>:<br>            correlation_categories[<span class="hljs-string">&#x27;very_weak&#x27;</span>].append((feature, corr))<br>    <br>    <span class="hljs-comment"># 特征筛选</span><br>    high_corr_features = corr_matrix.index[<span class="hljs-built_in">abs</span>(corr_matrix[target]) &gt; threshold]<br>    high_corr_series = corr_matrix[target][high_corr_features]<br>    high_corr_series = high_corr_series.reindex(<br>        high_corr_series.<span class="hljs-built_in">abs</span>().sort_values(ascending=<span class="hljs-literal">False</span>).index<br>    )<br>    <br>    top_k_features = corr_matrix.nlargest(k, target)[target].index<br>    common_features = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(high_corr_series.index).intersection(<span class="hljs-built_in">set</span>(top_k_features)))<br>    <br>    <span class="hljs-comment"># 打印分析结果</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n=== 特征相关性分析结果 ===&quot;</span>)<br>    <span class="hljs-keyword">if</span> exclude_features:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n已排除的特征 (<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(exclude_features)&#125;</span>个):&quot;</span>)<br>        <span class="hljs-built_in">print</span>(exclude_features)<br>        <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n1. 相关系数大于 <span class="hljs-subst">&#123;threshold&#125;</span> 的特征 (<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(high_corr_features)&#125;</span>个):&quot;</span>)<br>    <span class="hljs-built_in">print</span>(high_corr_series.index.tolist())<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n2. 相关性最强的前 <span class="hljs-subst">&#123;k&#125;</span> 个特征:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(top_k_features.tolist())<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n3. 同时满足以上两个条件的特征:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(common_features)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n4. 按相关性强度划分的特征:&quot;</span>)<br>    <span class="hljs-keyword">for</span> category, features <span class="hljs-keyword">in</span> correlation_categories.items():<br>        <span class="hljs-keyword">if</span> features:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;category.replace(<span class="hljs-string">&#x27;_&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).title()&#125;</span> Correlation (|r| &gt;= <span class="hljs-subst">&#123;correlation_thresholds.get(category, <span class="hljs-number">0</span>)&#125;</span>):&quot;</span>)<br>            <span class="hljs-keyword">for</span> feature, corr <span class="hljs-keyword">in</span> features:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;feature&#125;</span>: <span class="hljs-subst">&#123;corr:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 返回结果字典</span><br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&#x27;high_corr_features&#x27;</span>: high_corr_series.index,<br>        <span class="hljs-string">&#x27;top_k_features&#x27;</span>: top_k_features,<br>        <span class="hljs-string">&#x27;target_correlations&#x27;</span>: target_correlations,<br>        <span class="hljs-string">&#x27;common_features&#x27;</span>: common_features,<br>        <span class="hljs-string">&#x27;correlation_categories&#x27;</span>: correlation_categories,<br>        <span class="hljs-string">&#x27;excluded_features&#x27;</span>: exclude_features  <span class="hljs-comment"># 新增：返回被排除的特征</span><br>    &#125;<br><br><span class="hljs-comment"># 使用示例</span><br><br>results = analyze_feature_correlations(<br>    data=train_data,<br>    target=<span class="hljs-string">&#x27;count&#x27;</span>,<br>    k=<span class="hljs-number">5</span>,<br>    threshold=<span class="hljs-number">0.3</span>,<br>    exclude_features=[<span class="hljs-string">&#x27;minute&#x27;</span>,<span class="hljs-string">&#x27;is_month_end&#x27;</span>]  <span class="hljs-comment"># 排除这些特征</span><br>)<br><br><br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_45_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><p>​<br>​ === 特征相关性分析结果 === ​</p><pre><code class="hljs">已排除的特征 (2个):
[&#39;minute&#39;, &#39;is_month_end&#39;]

1. 相关系数大于 0.3 的特征 (7个):
[&#39;count&#39;, &#39;registered&#39;, &#39;casual&#39;, &#39;hour&#39;, &#39;temp&#39;, &#39;atemp&#39;, &#39;humidity&#39;]

2. 相关性最强的前 5 个特征:
[&#39;count&#39;, &#39;registered&#39;, &#39;casual&#39;, &#39;hour&#39;, &#39;temp&#39;]

3. 同时满足以上两个条件的特征:
[&#39;temp&#39;, &#39;hour&#39;, &#39;count&#39;, &#39;registered&#39;, &#39;casual&#39;]

4. 按相关性强度划分的特征:

Extremely Strong Correlation (|r| &gt;= 0.7):
registered: 0.9709

Strong Correlation (|r| &gt;= 0.5):
casual: 0.6904

Moderate Correlation (|r| &gt;= 0.3):
hour: 0.4006
temp: 0.3945
atemp: 0.3898
humidity: -0.3174

Weak Correlation (|r| &gt;= 0.1):
year: 0.2604
month: 0.1669
quarter: 0.1634
season: 0.1634
windspeed: 0.1014
weather: -0.1287

Very Weak Correlation (|r| &gt;= 0):
day: 0.0198
workingday: 0.0116
weekday: -0.0023
holiday: -0.0054
is_weekend: -0.0099</code></pre><h3 id="类别型特征-vs.-数值型特征">2. 类别型特征 vs. 数值型特征</h3><h4 id="箱线图-box-plot-和小提琴图">箱线图 (Box Plot) 和小提琴图</h4><p>初看之下，"count"变量包含许多异常数据点，这使得分布向右偏斜（因为有更多的数据点超出了外四分位限）。但除此之外，从下面的简单箱线图中还可以得出以下结论：</p><ul><li>春季的租赁数量相对较低。箱线图中位数值的下降证实了这一点。</li><li>"每日小时数"的箱线图非常有趣。在上午7-8点和下午5-6点，中位数值相对较高。这可以归因于该时段的常规上学和上班用户。</li><li>大多数异常点主要来自"工作日"而不是"非工作日"。从图4中可以清楚地看到这一点。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_boxplots_with_target</span>(<span class="hljs-params">data, target, categorical_features=<span class="hljs-literal">None</span>, figsize=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    绘制优化版本的目标变量箱型图分析</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - target: str, 目标变量名称</span><br><span class="hljs-string">    - categorical_features: list or None, 分类特征列表</span><br><span class="hljs-string">    - figsize: tuple or None, 图形大小，默认根据特征数量自动计算</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1. 特征处理</span><br>    <span class="hljs-keyword">if</span> categorical_features <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        categorical_features = data.select_dtypes(include=[<span class="hljs-string">&#x27;object&#x27;</span>, <span class="hljs-string">&#x27;category&#x27;</span>, <span class="hljs-string">&#x27;int64&#x27;</span>]).columns<br>        categorical_features = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> categorical_features <span class="hljs-keyword">if</span> col != target]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;自动检测到的分类特征: <span class="hljs-subst">&#123;categorical_features&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 2. 特征验证</span><br>    valid_features = []<br>    <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> categorical_features:<br>        <span class="hljs-keyword">if</span> feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不存在&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>        <br>        n_unique = data[feature].nunique()<br>        <span class="hljs-keyword">if</span> n_unique &gt; <span class="hljs-number">50</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: <span class="hljs-subst">&#123;feature&#125;</span> 的唯一值过多(<span class="hljs-subst">&#123;n_unique&#125;</span>)&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        valid_features.append(feature)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_features:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;错误: 没有有效的分类特征&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <br>    <span class="hljs-comment"># 3. 计算布局</span><br>    n_plots = <span class="hljs-built_in">len</span>(valid_features) + <span class="hljs-number">1</span><br>    n_cols = <span class="hljs-number">2</span><br>    n_rows = (n_plots + <span class="hljs-number">1</span>) // n_cols<br>    <br>    <span class="hljs-comment"># 4. 设置图形大小</span><br>    <span class="hljs-keyword">if</span> figsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        figsize = (<span class="hljs-number">15</span>, <span class="hljs-number">6</span> * n_rows)  <span class="hljs-comment"># 自动计算合适的高度</span><br>    <br>    <span class="hljs-comment"># 5. 创建图形</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 6. 绘制总体分布箱型图</span><br>    sns.boxplot(<br>        data=data,<br>        y=target,<br>        orient=<span class="hljs-string">&quot;v&quot;</span>,<br>        ax=axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>],<br>        color=<span class="hljs-string">&#x27;lightblue&#x27;</span>,<br>        width=<span class="hljs-number">0.5</span><br>    )<br>    axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].set_title(<span class="hljs-string">f&#x27;Distribution of <span class="hljs-subst">&#123;target.capitalize()&#125;</span>&#x27;</span>, <br>                        fontsize=<span class="hljs-number">14</span>, pad=<span class="hljs-number">20</span>)<br>    axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].set_ylabel(target.capitalize(), fontsize=<span class="hljs-number">12</span>)<br>    axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].tick_params(labelsize=<span class="hljs-number">10</span>)<br>    axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>    <br>    <span class="hljs-comment"># 添加描述性统计</span><br>    stats = data[target].describe()<br>    stats_text = (<span class="hljs-string">f&#x27;Mean: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;mean&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                 <span class="hljs-string">f&#x27;Std: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;std&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                 <span class="hljs-string">f&#x27;Min: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;min&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                 <span class="hljs-string">f&#x27;Max: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;max&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>&#x27;</span>)<br>    axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].text(<br>        <span class="hljs-number">0.95</span>, <span class="hljs-number">0.95</span>, stats_text,<br>        transform=axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].transAxes,<br>        verticalalignment=<span class="hljs-string">&#x27;top&#x27;</span>,<br>        horizontalalignment=<span class="hljs-string">&#x27;right&#x27;</span>,<br>        bbox=<span class="hljs-built_in">dict</span>(boxstyle=<span class="hljs-string">&#x27;round&#x27;</span>, facecolor=<span class="hljs-string">&#x27;white&#x27;</span>, alpha=<span class="hljs-number">0.8</span>),<br>        fontsize=<span class="hljs-number">10</span><br>    )<br>    <br>    <span class="hljs-comment"># 7. 绘制特征关系箱型图</span><br>    colors = sns.color_palette(<span class="hljs-string">&quot;husl&quot;</span>, <span class="hljs-built_in">len</span>(valid_features))<br>    <span class="hljs-keyword">for</span> i, (feature, color) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(valid_features, colors)):<br>        row = (i + <span class="hljs-number">1</span>) // <span class="hljs-number">2</span><br>        col = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span><br>        <br>        <span class="hljs-comment"># 绘制箱型图</span><br>        sns.boxplot(<br>            data=data,<br>            x=feature,<br>            y=target,<br>            orient=<span class="hljs-string">&quot;v&quot;</span>,<br>            ax=axes[row][col],<br>            color=color,<br>            width=<span class="hljs-number">0.7</span><br>        )<br>        <br>        <span class="hljs-comment"># 设置标题和标签</span><br>        axes[row][col].set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;target.capitalize()&#125;</span> by <span class="hljs-subst">&#123;feature.capitalize()&#125;</span>&#x27;</span>, <br>                                fontsize=<span class="hljs-number">14</span>, pad=<span class="hljs-number">20</span>)<br>        axes[row][col].set_xlabel(feature.capitalize(), fontsize=<span class="hljs-number">12</span>)<br>        axes[row][col].set_ylabel(target.capitalize(), fontsize=<span class="hljs-number">12</span>)<br>        <br>        <span class="hljs-comment"># 设置刻度</span><br>        axes[row][col].tick_params(axis=<span class="hljs-string">&#x27;both&#x27;</span>, labelsize=<span class="hljs-number">10</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data[feature].unique()) &gt; <span class="hljs-number">10</span>:<br>            axes[row][col].tick_params(axis=<span class="hljs-string">&#x27;x&#x27;</span>, rotation=<span class="hljs-number">45</span>)<br>        <br>        <span class="hljs-comment"># 添加网格</span><br>        axes[row][col].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        <br><br>    <br>    <span class="hljs-comment"># 8. 删除多余的子图</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(valid_features) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:<br>        fig.delaxes(axes[n_rows-<span class="hljs-number">1</span>][<span class="hljs-number">1</span>])<br>    <br>    <span class="hljs-comment"># 9. 调整布局</span><br>    plt.tight_layout(pad=<span class="hljs-number">3.0</span>)<br>    <br>    <span class="hljs-comment"># 10. 添加总标题</span><br>    fig.suptitle(<br>        <span class="hljs-string">f&#x27;Distribution Analysis of <span class="hljs-subst">&#123;target.capitalize()&#125;</span>&#x27;</span>, <br>        fontsize=<span class="hljs-number">16</span>, <br>        y=<span class="hljs-number">1.02</span><br>    )<br>    plt.show()<br>    <span class="hljs-comment">#return fig, axes</span><br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 基本使用</span><br><span class="hljs-string">plot_boxplots_with_target(train_data, target=&#x27;count&#x27;)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 指定特征</span><br><span class="hljs-string">plot_boxplots_with_target(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    target=&#x27;count&#x27;,</span><br><span class="hljs-string">    categorical_features=[&#x27;season&#x27;, &#x27;holiday&#x27;, &#x27;workingday&#x27;, &#x27;weather&#x27;]</span><br><span class="hljs-string">)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 自定义大小</span><br><span class="hljs-string">plot_boxplots_with_target(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    target=&#x27;count&#x27;,</span><br><span class="hljs-string">    categorical_features=[&#x27;hour&#x27;, &#x27;weekday&#x27;, &#x27;month&#x27;],</span><br><span class="hljs-string">    figsize=(15, 20)</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>plot_boxplots_with_target(<br>    data=train_data,<br>    target=<span class="hljs-string">&#x27;count&#x27;</span>,<br>    categorical_features=[<span class="hljs-string">&#x27;season&#x27;</span>,<span class="hljs-string">&#x27;holiday&#x27;</span>,  <span class="hljs-string">&#x27;workingday&#x27;</span>,<span class="hljs-string">&#x27;hour&#x27;</span>,<span class="hljs-string">&#x27;weather&#x27;</span>,<span class="hljs-string">&#x27;weekday&#x27;</span>]<br>)<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_49_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_boxplots_with_target</span>(<span class="hljs-params">data, target, categorical_features=<span class="hljs-literal">None</span>, n_cols=<span class="hljs-number">2</span>, figsize=<span class="hljs-literal">None</span>, violin_width=<span class="hljs-number">0.7</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    绘制目标变量小提琴图分析</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - target: str, 目标变量名称</span><br><span class="hljs-string">    - categorical_features: list or None, 分类特征列表</span><br><span class="hljs-string">    - n_cols: int, 子图列数，默认为2</span><br><span class="hljs-string">    - figsize: tuple or None, 图形大小，默认根据特征数量自动计算</span><br><span class="hljs-string">    - violin_width: float, 小提琴图的宽度，默认为0.7</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1. 特征处理</span><br>    <span class="hljs-keyword">if</span> categorical_features <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        categorical_features = data.select_dtypes(include=[<span class="hljs-string">&#x27;object&#x27;</span>, <span class="hljs-string">&#x27;category&#x27;</span>, <span class="hljs-string">&#x27;int64&#x27;</span>]).columns<br>        categorical_features = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> categorical_features <span class="hljs-keyword">if</span> col != target]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;自动检测到的分类特征: <span class="hljs-subst">&#123;categorical_features&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 2. 特征验证</span><br>    valid_features = []<br>    <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> categorical_features:<br>        <span class="hljs-keyword">if</span> feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不存在&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>        <br>        n_unique = data[feature].nunique()<br>        <span class="hljs-keyword">if</span> n_unique &gt; <span class="hljs-number">50</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: <span class="hljs-subst">&#123;feature&#125;</span> 的唯一值过多(<span class="hljs-subst">&#123;n_unique&#125;</span>)&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        valid_features.append(feature)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_features:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;错误: 没有有效的分类特征&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <br>    <span class="hljs-comment"># 3. 计算布局</span><br>    n_plots = <span class="hljs-built_in">len</span>(valid_features) + <span class="hljs-number">1</span><br>    n_rows = (n_plots + n_cols - <span class="hljs-number">1</span>) // n_cols  <span class="hljs-comment"># 使用向上取整</span><br>    <br>    <span class="hljs-comment"># 4. 设置图形大小</span><br>    <span class="hljs-keyword">if</span> figsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        figsize = (<span class="hljs-number">15</span>, <span class="hljs-number">6</span> * n_rows)  <span class="hljs-comment"># 自动计算合适的高度</span><br>    <br>    <span class="hljs-comment"># 5. 创建图形</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 确保 axes 是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = np.array([[axes]])<br>    <span class="hljs-keyword">elif</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment"># 6. 绘制总体分布小提琴图</span><br>    sns.violinplot(<br>        data=data,<br>        y=target,<br>        orient=<span class="hljs-string">&quot;v&quot;</span>,<br>        ax=axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> n_rows &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n_cols &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> axes[<span class="hljs-number">0</span>], <span class="hljs-comment"># 处理单子图情况</span><br>        color=<span class="hljs-string">&#x27;lightblue&#x27;</span>,<br>        width=<span class="hljs-number">0.5</span><br>    )<br>    ax_main = axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> n_rows &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n_cols &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> axes[<span class="hljs-number">0</span>]<br>    ax_main.set_title(<span class="hljs-string">f&#x27;Distribution of <span class="hljs-subst">&#123;target.capitalize()&#125;</span>&#x27;</span>, <br>                        fontsize=<span class="hljs-number">14</span>, pad=<span class="hljs-number">20</span>)<br>    ax_main.set_ylabel(target.capitalize(), fontsize=<span class="hljs-number">12</span>)<br>    ax_main.tick_params(labelsize=<span class="hljs-number">10</span>)<br>    ax_main.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>    <br>    <span class="hljs-comment"># 添加描述性统计</span><br>    stats = data[target].describe()<br>    stats_text = (<span class="hljs-string">f&#x27;Mean: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;mean&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                 <span class="hljs-string">f&#x27;Std: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;std&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                 <span class="hljs-string">f&#x27;Min: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;min&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>\n&#x27;</span><br>                 <span class="hljs-string">f&#x27;Max: <span class="hljs-subst">&#123;stats[<span class="hljs-string">&quot;max&quot;</span>]:<span class="hljs-number">.2</span>f&#125;</span>&#x27;</span>)<br>    ax_main.text(<br>        <span class="hljs-number">0.95</span>, <span class="hljs-number">0.95</span>, stats_text,<br>        transform=ax_main.transAxes,<br>        verticalalignment=<span class="hljs-string">&#x27;top&#x27;</span>,<br>        horizontalalignment=<span class="hljs-string">&#x27;right&#x27;</span>,<br>        bbox=<span class="hljs-built_in">dict</span>(boxstyle=<span class="hljs-string">&#x27;round&#x27;</span>, facecolor=<span class="hljs-string">&#x27;white&#x27;</span>, alpha=<span class="hljs-number">0.8</span>),<br>        fontsize=<span class="hljs-number">10</span><br>    )<br>    <br>    <span class="hljs-comment"># 7. 绘制特征关系小提琴图</span><br>    colors = sns.color_palette(<span class="hljs-string">&quot;husl&quot;</span>, <span class="hljs-built_in">len</span>(valid_features))<br>    <span class="hljs-keyword">for</span> i, (feature, color) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(valid_features, colors)):<br>        row = (i + <span class="hljs-number">1</span>) // n_cols<br>        col = (i + <span class="hljs-number">1</span>) % n_cols<br>        ax = axes[row][col] <span class="hljs-keyword">if</span> n_rows &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n_cols &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> axes[col]<br>        <br>        <span class="hljs-comment"># 绘制小提琴图</span><br>        sns.violinplot(<br>            data=data,<br>            x=feature,<br>            y=target,<br>            orient=<span class="hljs-string">&quot;v&quot;</span>,<br>            ax=ax,<br>            color=color,<br>            width=violin_width <span class="hljs-keyword">if</span> feature != <span class="hljs-string">&#x27;hour&#x27;</span> <span class="hljs-keyword">else</span> violin_width * <span class="hljs-number">1.5</span> <span class="hljs-comment"># 调整hour的宽度</span><br>        )<br>        <br>        <span class="hljs-comment"># 设置标题和标签</span><br>        ax.set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;target.capitalize()&#125;</span> by <span class="hljs-subst">&#123;feature.capitalize()&#125;</span>&#x27;</span>, <br>                                fontsize=<span class="hljs-number">14</span>, pad=<span class="hljs-number">20</span>)<br>        ax.set_xlabel(feature.capitalize(), fontsize=<span class="hljs-number">12</span>)<br>        ax.set_ylabel(target.capitalize(), fontsize=<span class="hljs-number">12</span>)<br>        <br>        <span class="hljs-comment"># 设置刻度</span><br>        ax.tick_params(axis=<span class="hljs-string">&#x27;both&#x27;</span>, labelsize=<span class="hljs-number">10</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data[feature].unique()) &gt; <span class="hljs-number">10</span>:<br>            ax.tick_params(axis=<span class="hljs-string">&#x27;x&#x27;</span>, rotation=<span class="hljs-number">45</span>)<br>        <br>        <span class="hljs-comment"># 添加网格</span><br>        ax.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>        <br><br>    <br>    <span class="hljs-comment"># 8. 删除多余的子图</span><br>    <span class="hljs-keyword">if</span> n_plots % n_cols != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (n_rows &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n_cols &gt; <span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_plots, n_rows * n_cols):<br>            row = j // n_cols<br>            col = j % n_cols<br>            fig.delaxes(axes[row][col])<br>    <br>    <span class="hljs-comment"># 9. 调整布局</span><br>    plt.tight_layout(pad=<span class="hljs-number">3.0</span>)<br>    <br>    <span class="hljs-comment"># 10. 添加总标题</span><br>    fig.suptitle(<br>        <span class="hljs-string">f&#x27;Distribution Analysis of <span class="hljs-subst">&#123;target.capitalize()&#125;</span>&#x27;</span>, <br>        fontsize=<span class="hljs-number">16</span>, <br>        y=<span class="hljs-number">1.02</span><br>    )<br>    plt.show()<br>    <span class="hljs-comment">#return fig, axes</span><br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 基本使用</span><br><span class="hljs-string">plot_boxplots_with_target(train_data, target=&#x27;count&#x27;)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 指定特征</span><br><span class="hljs-string">plot_boxplots_with_target(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    target=&#x27;count&#x27;,</span><br><span class="hljs-string">    categorical_features=[&#x27;season&#x27;, &#x27;holiday&#x27;, &#x27;workingday&#x27;, &#x27;weather&#x27;]</span><br><span class="hljs-string">)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 自定义大小</span><br><span class="hljs-string">plot_boxplots_with_target(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    target=&#x27;count&#x27;,</span><br><span class="hljs-string">    categorical_features=[&#x27;hour&#x27;, &#x27;weekday&#x27;, &#x27;month&#x27;],</span><br><span class="hljs-string">    figsize=(15, 20)</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>plot_boxplots_with_target(<br>    data=train_data,<br>    target=<span class="hljs-string">&#x27;count&#x27;</span>,<br>    categorical_features=[<span class="hljs-string">&#x27;season&#x27;</span>,<span class="hljs-string">&#x27;holiday&#x27;</span>,  <span class="hljs-string">&#x27;workingday&#x27;</span>,<span class="hljs-string">&#x27;hour&#x27;</span>,<span class="hljs-string">&#x27;weather&#x27;</span>,<span class="hljs-string">&#x27;weekday&#x27;</span>],<br>    n_cols=<span class="hljs-number">2</span>, <span class="hljs-comment"># 自定义列数</span><br>)<br></code></pre></td></tr></table></figure><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_50_0.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><h3 id="类别型特征-vs.-类别型特征">3. 类别型特征 vs. 类别型特征</h3><h4 id="交叉表">交叉表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_categorical_relationship</span>(<span class="hljs-params">data, cat_features, n_cols=<span class="hljs-number">2</span>, figsize=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    绘制类别型特征之间的交叉表</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - cat_features: list, 需要分析的两个类别型特征列表</span><br><span class="hljs-string">    - n_cols: int, 子图列数，默认为2</span><br><span class="hljs-string">    - figsize: tuple or None, 图形大小，默认为None(自动计算大小)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1. 特征验证</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(cat_features) != <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;错误: 请提供两个类别型特征进行分析&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <br>    <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> cat_features:<br>        <span class="hljs-keyword">if</span> feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 特征 <span class="hljs-subst">&#123;feature&#125;</span> 不存在&quot;</span>)<br>            <span class="hljs-keyword">return</span><br>        <br>        n_unique = data[feature].nunique()<br>        <span class="hljs-keyword">if</span> n_unique &gt; <span class="hljs-number">50</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: <span class="hljs-subst">&#123;feature&#125;</span> 的唯一值过多(<span class="hljs-subst">&#123;n_unique&#125;</span>)&quot;</span>)<br>            <span class="hljs-keyword">return</span><br>    <br>    <span class="hljs-comment"># 2. 计算布局</span><br>    n_plots = <span class="hljs-number">1</span>  <span class="hljs-comment"># 只绘制交叉表</span><br>    n_rows = (n_plots + n_cols - <span class="hljs-number">1</span>) // n_cols<br>    <br>    <span class="hljs-comment"># 3. 设置图形大小</span><br>    <span class="hljs-keyword">if</span> figsize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        width = <span class="hljs-number">10</span> * n_cols<br>        height = <span class="hljs-number">6</span> * n_rows<br>        figsize = (width, height)<br>    <br>    <span class="hljs-comment"># 4. 创建图形</span><br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)<br>    <br>    <span class="hljs-comment"># 确保 axes 是二维数组</span><br>    <span class="hljs-keyword">if</span> n_rows == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> n_cols == <span class="hljs-number">1</span>:<br>        ax_cross = axes<br>    <span class="hljs-keyword">elif</span> n_rows == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)<br>        ax_cross = axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">elif</span> n_cols == <span class="hljs-number">1</span>:<br>        axes = axes.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>        ax_cross = axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">else</span>:<br>        ax_cross = axes[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>    <br>    <span class="hljs-comment"># 5. 设置样式</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 6. 计算交叉表</span><br>    cross_tab = pd.crosstab(data[cat_features[<span class="hljs-number">0</span>]], data[cat_features[<span class="hljs-number">1</span>]])<br>    <br>    <span class="hljs-comment"># 7. 绘制交叉表</span><br>    sns.heatmap(cross_tab, annot=<span class="hljs-literal">True</span>, fmt=<span class="hljs-string">&#x27;d&#x27;</span>, cmap=<span class="hljs-string">&#x27;Blues&#x27;</span>, ax=ax_cross)<br>    ax_cross.set_title(<span class="hljs-string">f&#x27;Crosstab of <span class="hljs-subst">&#123;cat_features[<span class="hljs-number">0</span>].capitalize()&#125;</span> vs <span class="hljs-subst">&#123;cat_features[<span class="hljs-number">1</span>].capitalize()&#125;</span>&#x27;</span>, fontsize=<span class="hljs-number">14</span>, pad=<span class="hljs-number">20</span>)<br>    ax_cross.set_xlabel(cat_features[<span class="hljs-number">1</span>].capitalize(), fontsize=<span class="hljs-number">12</span>)<br>    ax_cross.set_ylabel(cat_features[<span class="hljs-number">0</span>].capitalize(), fontsize=<span class="hljs-number">12</span>)<br>    ax_cross.tick_params(axis=<span class="hljs-string">&#x27;both&#x27;</span>, labelsize=<span class="hljs-number">10</span>)<br>    <br>    <br>    <span class="hljs-comment"># 8. 删除多余的子图</span><br>    <span class="hljs-keyword">if</span> n_plots % n_cols != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (n_rows &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> n_cols &gt; <span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_plots, n_rows * n_cols):<br>            row = j // n_cols<br>            col = j % n_cols<br>            fig.delaxes(axes[row][col])<br>    <br>    <span class="hljs-comment"># 9. 调整布局</span><br>    plt.tight_layout(pad=<span class="hljs-number">3.0</span>)<br>    <br>    <span class="hljs-comment"># 10. 添加总标题</span><br>    fig.suptitle(<br>        <span class="hljs-string">f&#x27;Relationship Analysis of <span class="hljs-subst">&#123;cat_features[<span class="hljs-number">0</span>].capitalize()&#125;</span> and <span class="hljs-subst">&#123;cat_features[<span class="hljs-number">1</span>].capitalize()&#125;</span>&#x27;</span>, <br>        fontsize=<span class="hljs-number">16</span>, <br>        y=<span class="hljs-number">1.02</span><br>    )<br>    <br>    plt.show()<br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"># 基本使用</span><br><span class="hljs-string">plot_categorical_relationship(train_data, cat_features=[&#x27;season&#x27;, &#x27;weather&#x27;])</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 自定义大小</span><br><span class="hljs-string">plot_categorical_relationship(</span><br><span class="hljs-string">    data=train_data,</span><br><span class="hljs-string">    cat_features=[&#x27;weekday&#x27;, &#x27;hour&#x27;],</span><br><span class="hljs-string">    figsize=(15, 10)</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment">#plot_categorical_relationship(data=train_data,cat_features=[&#x27;weekday&#x27;, &#x27;hour&#x27;])</span><br><br></code></pre></td></tr></table></figure><pre><code class="hljs">&quot;\n# 基本使用\nplot_categorical_relationship(train_data, cat_features=[&#39;season&#39;, &#39;weather&#39;])\n\n# 自定义大小\nplot_categorical_relationship(\n    data=train_data,\n    cat_features=[&#39;weekday&#39;, &#39;hour&#39;],\n    figsize=(15, 10)\n)\n&quot;</code></pre><h1 id="特征工程">3 特征工程</h1><p>https://www.kaggle.com/code/fatmakursun/bike-sharing-feature-engineering</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data.info()<br></code></pre></td></tr></table></figure><pre><code class="hljs">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 10886 entries, 0 to 10885
Data columns (total 21 columns):
 #   Column      Non-Null Count  Dtype         
---  ------      --------------  -----         
 0   datetime    10886 non-null  object        
 1   season      10886 non-null  int64         
 2   holiday     10886 non-null  int64         
 3   workingday  10886 non-null  int64         
 4   weather     10886 non-null  int64         
 5   temp        10886 non-null  float64       
 6   atemp       10886 non-null  float64       
 7   humidity    10886 non-null  int64         
 8   windspeed   10886 non-null  float64       
 9   casual      10886 non-null  int64         
 10  registered  10886 non-null  int64         
 11  count       10886 non-null  int64         
 12  date        10886 non-null  datetime64[ns]
 13  year        10886 non-null  int32         
 14  month       10886 non-null  int32         
 15  day         10886 non-null  int32         
 16  hour        10886 non-null  int32         
 17  minute      10886 non-null  int32         
 18  weekday     10886 non-null  int32         
 19  quarter     10886 non-null  int32         
 20  is_weekend  10886 non-null  int32         
dtypes: datetime64[ns](1), float64(3), int32(8), int64(8), object(1)
memory usage: 1.4+ MB</code></pre><h2 id="数据预处理">3.1 数据预处理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 加载数据集</span><br><span class="hljs-comment">#train_data = pd.read_csv(&quot;./data/train.csv&quot;)</span><br><span class="hljs-comment">#submit_data = pd.read_csv(&quot;./data/test.csv&quot;)</span><br></code></pre></td></tr></table></figure><h3 id="数据清洗">数据清洗</h3><h4 id="重复值处理"><strong>重复值处理</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del_duplicates</span>(<span class="hljs-params">data: pd.DataFrame</span>) -&gt; pd.DataFrame:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    删除DataFrame中的重复行，并重置索引。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        data: 输入的pandas DataFrame。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns:</span><br><span class="hljs-string">        处理后的pandas DataFrame，已删除重复行并重置索引。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    num_duplicates = data.duplicated().<span class="hljs-built_in">sum</span>()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;检测到 <span class="hljs-subst">&#123;num_duplicates&#125;</span> 条重复行。&quot;</span>)<br><br>    <span class="hljs-keyword">if</span> num_duplicates &gt; <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;重复行如下：\n<span class="hljs-subst">&#123;data[data.duplicated()]&#125;</span>&quot;</span>)<br>        data = data.drop_duplicates().reset_index(drop=<span class="hljs-literal">True</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;已删除重复行并重置索引。&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;未检测到重复行。&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> data<br><br><br>train_data = del_duplicates(train_data)<br><br><br><br></code></pre></td></tr></table></figure><pre><code class="hljs">检测到 0 条重复行。
未检测到重复行。</code></pre><h4 id="缺失值处理"><strong>缺失值处理</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 可视化缺失值</span><br>msno.matrix(train_data,figsize=(<span class="hljs-number">12</span>,<span class="hljs-number">5</span>))<br></code></pre></td></tr></table></figure><pre><code class="hljs">&lt;matplotlib.axes._subplots.AxesSubplot at 0x22448f65708&gt;</code></pre><p>​<br><img src="/img/EDA-stacking_files/EDA-stacking_64_1.png" srcset="/img/loading.gif" lazyload alt="png"> ​</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data.info()<br></code></pre></td></tr></table></figure><pre><code class="hljs">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 10886 entries, 0 to 10885
Data columns (total 21 columns):
 #   Column      Non-Null Count  Dtype         
---  ------      --------------  -----         
 0   datetime    10886 non-null  object        
 1   season      10886 non-null  int64         
 2   holiday     10886 non-null  int64         
 3   workingday  10886 non-null  int64         
 4   weather     10886 non-null  int64         
 5   temp        10886 non-null  float64       
 6   atemp       10886 non-null  float64       
 7   humidity    10886 non-null  int64         
 8   windspeed   10886 non-null  float64       
 9   casual      10886 non-null  int64         
 10  registered  10886 non-null  int64         
 11  count       10886 non-null  int64         
 12  date        10886 non-null  datetime64[ns]
 13  year        10886 non-null  int32         
 14  month       10886 non-null  int32         
 15  day         10886 non-null  int32         
 16  hour        10886 non-null  int32         
 17  minute      10886 non-null  int32         
 18  weekday     10886 non-null  int32         
 19  quarter     10886 non-null  int32         
 20  is_weekend  10886 non-null  int32         
dtypes: datetime64[ns](1), float64(3), int32(8), int64(8), object(1)
memory usage: 1.4+ MB</code></pre><p><strong>使用随机森林模型预测风速中的0值</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_windspeed_correlations</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    分析特征与windspeed的相关性并绘制热力图</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 选择需要分析的特征</span><br>    features = [<span class="hljs-string">&#x27;season&#x27;</span>, <span class="hljs-string">&#x27;holiday&#x27;</span>, <span class="hljs-string">&#x27;workingday&#x27;</span>, <span class="hljs-string">&#x27;weather&#x27;</span>, <br>                <span class="hljs-string">&#x27;temp&#x27;</span>, <span class="hljs-string">&#x27;atemp&#x27;</span>,<span class="hljs-string">&#x27;month&#x27;</span>,<span class="hljs-string">&#x27;day&#x27;</span>, <span class="hljs-string">&#x27;hour&#x27;</span>,<span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;windspeed&#x27;</span>]<br>    <br>    <span class="hljs-comment"># 计算相关系数矩阵</span><br>    corr_matrix = data[features].corr()<br>    <br>    <span class="hljs-comment"># 创建热力图</span><br>    plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))<br>    sns.heatmap(corr_matrix, <br>                annot=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 显示相关系数值</span><br>                fmt=<span class="hljs-string">&#x27;.2f&#x27;</span>,   <span class="hljs-comment"># 保留两位小数</span><br>                cmap=<span class="hljs-string">&#x27;coolwarm&#x27;</span>,  <span class="hljs-comment"># 使用蓝红配色</span><br>                center=<span class="hljs-number">0</span>,    <span class="hljs-comment"># 将相关系数0设为中心值</span><br>                square=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 保持方形</span><br>    <br>    plt.title(<span class="hljs-string">&#x27;特征与Windspeed的相关性热力图&#x27;</span>, pad=<span class="hljs-number">20</span>)<br>    plt.tight_layout()<br>    plt.show()<br>    <br>    <span class="hljs-comment"># 打印与windspeed的相关性排序</span><br>    correlations = corr_matrix[<span class="hljs-string">&#x27;windspeed&#x27;</span>].sort_values(ascending=<span class="hljs-literal">False</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nWindspeed相关性排序:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(correlations)<br><br><span class="hljs-comment"># 调用函数</span><br>analyze_windspeed_correlations(train_data)<br></code></pre></td></tr></table></figure><pre><code class="hljs">d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 29305 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 24449 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 19982 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 30340 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 30456 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 20851 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 24615 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 28909 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 21147 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:211: RuntimeWarning: Glyph 22270 missing from current font.
  font.set_text(s, 0.0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 29305 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 24449 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 19982 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 30340 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 30456 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 20851 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 24615 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 28909 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 21147 missing from current font.
  font.set_text(s, 0, flags=flags)
d:\Development\anaconda3\envs\ml\lib\site-packages\matplotlib\backends\backend_agg.py:180: RuntimeWarning: Glyph 22270 missing from current font.
  font.set_text(s, 0, flags=flags)</code></pre><figure><img src="/img/EDA-stacking_files/EDA-stacking_67_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><p>​<br>​ Windspeed相关性排序: ​ windspeed 1.000000 ​ hour 0.146631 ​ day 0.036157 ​ workingday 0.013373 ​ holiday 0.008409 ​ weather 0.007261 ​ temp -0.017852 ​ atemp -0.057473 ​ season -0.147121 ​ month -0.150192 ​ humidity -0.318607 ​ Name: windspeed, dtype: float64</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestRegressor<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill_missing_with_rf</span>(<span class="hljs-params">data, target_columns, feature_columns=<span class="hljs-literal">None</span>, missing_value=np.NAN, random_state=<span class="hljs-number">42</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    使用随机森林模型填充缺失值</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - target_columns: str or list, 需要填充的目标列(可以是单个字符串或列表)</span><br><span class="hljs-string">    - feature_columns: list or None, 用于预测的特征列。如果为None则自动选择数值列</span><br><span class="hljs-string">    - missing_value: any, 需要填充的值(默认为0)可修改为np.nan # 有bug，缺失值类型无法与target_columns一一匹配</span><br><span class="hljs-string">    - random_state: int, 随机种子(默认为42)</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    返回:</span><br><span class="hljs-string">    - DataFrame: 填充后的数据框</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 复制输入数据,避免修改原始数据</span><br>    df = data.copy()<br>    <br>    <span class="hljs-comment"># 将target_columns转换为列表</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(target_columns, <span class="hljs-built_in">str</span>):<br>        target_columns = [target_columns]<br>        <br>    <span class="hljs-comment"># 如果未指定特征列,自动选择数值列(排除目标列)</span><br>    <span class="hljs-keyword">if</span> feature_columns <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        feature_columns = df.select_dtypes(include=[<span class="hljs-string">&#x27;int64&#x27;</span>, <span class="hljs-string">&#x27;float64&#x27;</span>]).columns<br>        feature_columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> feature_columns <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> target_columns]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;自动选择的特征列: <span class="hljs-subst">&#123;feature_columns&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 对每个目标列进行填充</span><br>    <span class="hljs-keyword">for</span> target_column <span class="hljs-keyword">in</span> target_columns:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n开始处理列: <span class="hljs-subst">&#123;target_column&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-comment"># 检查目标列是否存在</span><br>        <span class="hljs-keyword">if</span> target_column <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> df.columns:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 列 <span class="hljs-subst">&#123;target_column&#125;</span> 不存在于数据中&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        <span class="hljs-comment"># 将数据分为包含缺失值和不包含缺失值的两部分</span><br>        data_missing = df[df[target_column] == missing_value]<br>        data_not_missing = df[df[target_column] != missing_value]<br>        <br>        <span class="hljs-comment"># 如果没有缺失值,跳过当前列</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data_missing) == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;列 <span class="hljs-subst">&#123;target_column&#125;</span> 中没有发现值为<span class="hljs-subst">&#123;missing_value&#125;</span>的记录,无需填充。&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>            <br>        <span class="hljs-comment"># 创建并训练随机森林模型</span><br>        rf_model = RandomForestRegressor(random_state=random_state)<br>        <br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 训练模型</span><br>            rf_model.fit(data_not_missing[feature_columns], <br>                        data_not_missing[target_column])<br>            <br>            <span class="hljs-comment"># 预测缺失值</span><br>            predicted_values = rf_model.predict(data_missing[feature_columns])<br>            <br>            <span class="hljs-comment"># 将预测值填充到缺失值位置</span><br>            df.loc[df[target_column] == missing_value, target_column] = predicted_values<br>            <br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;列 <span class="hljs-subst">&#123;target_column&#125;</span> 已成功填充 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data_missing)&#125;</span> 条记录。&quot;</span>)<br>            <br><br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;错误: 处理列 <span class="hljs-subst">&#123;target_column&#125;</span> 时发生异常: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">continue</span><br>    <br>    <span class="hljs-keyword">return</span> df<br><br><span class="hljs-comment"># 使用示例:</span><br><span class="hljs-comment"># 1. 填充单个列的缺失值</span><br>train_data = fill_missing_with_rf(<br>    data=train_data,<br>    target_columns=<span class="hljs-string">&#x27;windspeed&#x27;</span>,  <span class="hljs-comment"># 单个列名</span><br>    feature_columns=[<span class="hljs-string">&#x27;humidity&#x27;</span>,<span class="hljs-string">&#x27;month&#x27;</span>,<span class="hljs-string">&#x27;season&#x27;</span>, <span class="hljs-string">&#x27;hour&#x27;</span>,<span class="hljs-string">&#x27;weather&#x27;</span>,  <span class="hljs-string">&#x27;atemp&#x27;</span>],<br>    missing_value=<span class="hljs-number">0</span>,<br>    random_state=<span class="hljs-number">42</span><br>)<br><br><br></code></pre></td></tr></table></figure><pre><code class="hljs">开始处理列: windspeed
列 windspeed 已成功填充 1313 条记录。</code></pre><h4 id="异常值处理"><strong>异常值处理</strong></h4><p>先用IQR检测特征列的异常值，发现humidity和windspeed含有异常值，对于异常值使用季节、温度、天气状况等进行回归插值预测填充。对于目标变量count使用基于模型的方法检测异常值，对异常值进行对数变换 (log transformation) 可以 平滑 count 的分布，减小高值异常值的杠杆效应，使模型更关注相对变化而非绝对变化。</p><h5 id="iqr方法检测特征异常值">IQR方法检测特征异常值</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_iqr_outliers_selected_columns</span>(<span class="hljs-params">data, columns=<span class="hljs-literal">None</span>, threshold=<span class="hljs-number">1.5</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    使用IQR方法检测并可视化指定列的异常值</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - columns: list or None, 需要检测的列名列表。如果为None，则检测所有数值列</span><br><span class="hljs-string">    - threshold: float, IQR的倍数阈值，默认为1.5</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    返回:</span><br><span class="hljs-string">    - outliers_summary: dict, 异常值检测结果摘要</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 如果未指定列，则获取所有数值型列</span><br>    <span class="hljs-keyword">if</span> columns <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        columns = data.select_dtypes(include=[<span class="hljs-string">&#x27;int64&#x27;</span>, <span class="hljs-string">&#x27;float64&#x27;</span>]).columns<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 验证指定的列是否存在于数据中</span><br>        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns:<br>            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;列 &#x27;<span class="hljs-subst">&#123;col&#125;</span>&#x27; 不存在于数据中&quot;</span>)<br>            <span class="hljs-comment"># 验证指定的列是否为数值型</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> np.issubdtype(data[col].dtype, np.number):<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;列 &#x27;<span class="hljs-subst">&#123;col&#125;</span>&#x27; 不是数值类型&quot;</span>)<br>    <br>    <span class="hljs-comment"># 计算每列的IQR统计量</span><br>    Q1 = data[columns].quantile(<span class="hljs-number">0.25</span>)<br>    Q3 = data[columns].quantile(<span class="hljs-number">0.75</span>)<br>    IQR = Q3 - Q1<br>    <br>    <span class="hljs-comment"># 计算异常值边界</span><br>    lower_bounds = Q1 - threshold * IQR<br>    upper_bounds = Q3 + threshold * IQR<br>    <br>    <span class="hljs-comment"># 打印每列的异常值统计</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">20</span>&#125;</span> IQR异常值检测报告 <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">20</span>&#125;</span>&quot;</span>)<br>    <br>    outliers_summary = &#123;&#125;<br>    <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> columns:<br>        <span class="hljs-comment"># 标记异常值</span><br>        outliers = data[(data[column] &lt; lower_bounds[column]) | <br>                       (data[column] &gt; upper_bounds[column])]<br>        <br>        outliers_count = <span class="hljs-built_in">len</span>(outliers)<br>        outliers_percentage = (outliers_count/<span class="hljs-built_in">len</span>(data))*<span class="hljs-number">100</span><br>        <br>        <span class="hljs-comment"># 存储异常值的索引</span><br>        outliers_idx = outliers.index<br>        <br>        outliers_summary[column] = &#123;<br>            <span class="hljs-string">&#x27;Q1&#x27;</span>: Q1[column],<br>            <span class="hljs-string">&#x27;Q3&#x27;</span>: Q3[column],<br>            <span class="hljs-string">&#x27;IQR&#x27;</span>: IQR[column],<br>            <span class="hljs-string">&#x27;lower_bound&#x27;</span>: lower_bounds[column],<br>            <span class="hljs-string">&#x27;upper_bound&#x27;</span>: upper_bounds[column],<br>            <span class="hljs-string">&#x27;outliers_count&#x27;</span>: outliers_count,<br>            <span class="hljs-string">&#x27;outliers_percentage&#x27;</span>: outliers_percentage,<br>            <span class="hljs-string">&#x27;outliers_index&#x27;</span>: outliers_idx,  <span class="hljs-comment"># 添加异常值索引</span><br>            <span class="hljs-string">&#x27;outliers_values&#x27;</span>: data.loc[outliers_idx, column]  <span class="hljs-comment"># 添加异常值</span><br>        &#125;<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n列名: <span class="hljs-subst">&#123;column&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Q1: <span class="hljs-subst">&#123;Q1[column]:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Q3: <span class="hljs-subst">&#123;Q3[column]:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;IQR: <span class="hljs-subst">&#123;IQR[column]:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;下界: <span class="hljs-subst">&#123;lower_bounds[column]:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;上界: <span class="hljs-subst">&#123;upper_bounds[column]:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;异常值数量: <span class="hljs-subst">&#123;outliers_count&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;异常值占比: <span class="hljs-subst">&#123;outliers_percentage:<span class="hljs-number">.2</span>f&#125;</span>%&quot;</span>)<br>    <br>    <span class="hljs-comment"># 可视化</span><br>    n_cols = <span class="hljs-built_in">min</span>(<span class="hljs-number">3</span>, <span class="hljs-built_in">len</span>(columns))<br>    n_rows = (<span class="hljs-built_in">len</span>(columns) + n_cols - <span class="hljs-number">1</span>) // n_cols<br>    <br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    fig, axes = plt.subplots(n_rows, n_cols, figsize=(<span class="hljs-number">20</span>, <span class="hljs-number">6</span>*n_rows))<br>    axes = axes.flatten() <span class="hljs-keyword">if</span> n_rows * n_cols &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> [axes]<br>    <br>    <span class="hljs-keyword">for</span> idx, column <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(columns):<br>        <span class="hljs-comment"># 获取当前列的异常值</span><br>        outliers_idx = outliers_summary[column][<span class="hljs-string">&#x27;outliers_index&#x27;</span>]<br>        <br>        <span class="hljs-comment"># 绘制箱线图</span><br>        sns.boxplot(data=data, y=column, ax=axes[idx], color=<span class="hljs-string">&#x27;lightblue&#x27;</span>, width=<span class="hljs-number">0.3</span>)<br>        <br>        <span class="hljs-comment"># 添加异常值散点</span><br>        axes[idx].scatter(<br>            np.zeros(<span class="hljs-built_in">len</span>(outliers_idx)), <br>            data.loc[outliers_idx, column],<br>            c=<span class="hljs-string">&#x27;red&#x27;</span>, alpha=<span class="hljs-number">0.7</span>, label=<span class="hljs-string">&#x27;Outliers&#x27;</span><br>        )<br>        <br>        <span class="hljs-comment"># 添加边界线</span><br>        axes[idx].axhline(<br>            y=upper_bounds[column], <br>            color=<span class="hljs-string">&#x27;r&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, <br>            alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">&#x27;Upper Bound&#x27;</span><br>        )<br>        axes[idx].axhline(<br>            y=lower_bounds[column], <br>            color=<span class="hljs-string">&#x27;r&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, <br>            alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">&#x27;Lower Bound&#x27;</span><br>        )<br>        <br>        <span class="hljs-comment"># 设置标题和标签</span><br>        axes[idx].set_title(<br>            <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;column&#125;</span>\n(Outliers: <span class="hljs-subst">&#123;outliers_summary[column][<span class="hljs-string">&quot;outliers_count&quot;</span>]&#125;</span> - &#x27;</span><br>            <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;outliers_summary[column][<span class="hljs-string">&quot;outliers_percentage&quot;</span>]:<span class="hljs-number">.1</span>f&#125;</span>%)&#x27;</span>, <br>            pad=<span class="hljs-number">15</span><br>        )<br>        axes[idx].legend()<br>        axes[idx].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br>    <br>    <span class="hljs-comment"># 删除多余的子图</span><br>    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(columns), <span class="hljs-built_in">len</span>(axes)):<br>        fig.delaxes(axes[idx])<br>    <br>    plt.tight_layout()<br>    plt.show()<br>    <br>    <span class="hljs-keyword">return</span> outliers_summary<br><br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-comment"># 1. 检测所有数值列的异常值</span><br>outliers_summary_all = plot_iqr_outliers_selected_columns(train_data)<br><br><span class="hljs-comment"># 2. 检测指定列的异常值</span><br><span class="hljs-comment"># selected_columns = [&#x27;temp&#x27;, &#x27;atemp&#x27;, &#x27;humidity&#x27;, &#x27;windspeed&#x27;, &#x27;count&#x27;]</span><br><span class="hljs-comment"># outliers_summary_selected = plot_iqr_outliers_selected_columns(</span><br><span class="hljs-comment">#     data=train_data,</span><br><span class="hljs-comment">#     columns=selected_columns,</span><br><span class="hljs-comment">#     threshold=1.5</span><br><span class="hljs-comment"># )</span><br><br><br></code></pre></td></tr></table></figure><pre><code class="hljs">==================== IQR异常值检测报告 ====================

列名: season
Q1: 2.00
Q3: 4.00
IQR: 2.00
下界: -1.00
上界: 7.00
异常值数量: 0
异常值占比: 0.00%

列名: holiday
Q1: 0.00
Q3: 0.00
IQR: 0.00
下界: 0.00
上界: 0.00
异常值数量: 311
异常值占比: 2.86%

列名: workingday
Q1: 0.00
Q3: 1.00
IQR: 1.00
下界: -1.50
上界: 2.50
异常值数量: 0
异常值占比: 0.00%

列名: weather
Q1: 1.00
Q3: 2.00
IQR: 1.00
下界: -0.50
上界: 3.50
异常值数量: 1
异常值占比: 0.01%

列名: temp
Q1: 13.94
Q3: 26.24
IQR: 12.30
下界: -4.51
上界: 44.69
异常值数量: 0
异常值占比: 0.00%

列名: atemp
Q1: 16.66
Q3: 31.06
IQR: 14.39
下界: -4.93
上界: 52.65
异常值数量: 0
异常值占比: 0.00%

列名: humidity
Q1: 47.00
Q3: 77.00
IQR: 30.00
下界: 2.00
上界: 122.00
异常值数量: 22
异常值占比: 0.20%

列名: windspeed
Q1: 9.00
Q3: 19.00
IQR: 10.00
下界: -6.01
上界: 34.01
异常值数量: 147
异常值占比: 1.35%

列名: casual
Q1: 4.00
Q3: 49.00
IQR: 45.00
下界: -63.50
上界: 116.50
异常值数量: 749
异常值占比: 6.88%

列名: registered
Q1: 36.00
Q3: 222.00
IQR: 186.00
下界: -243.00
上界: 501.00
异常值数量: 423
异常值占比: 3.89%

列名: count
Q1: 42.00
Q3: 284.00
IQR: 242.00
下界: -321.00
上界: 647.00
异常值数量: 300
异常值占比: 2.76%</code></pre><figure><img src="/img/EDA-stacking_files/EDA-stacking_72_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_column_outliers</span>(<span class="hljs-params">outliers_summary, column_name, data, save_csv=<span class="hljs-literal">True</span>, output_dir=<span class="hljs-string">&#x27;./outliers&#x27;</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取指定列的异常值详情，并可选择保存完整样本数据为CSV文件</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - outliers_summary: dict, 异常值检测结果字典</span><br><span class="hljs-string">    - column_name: str, 列名</span><br><span class="hljs-string">    - data: DataFrame, 原始数据集</span><br><span class="hljs-string">    - save_csv: bool, 是否保存为CSV文件，默认为True</span><br><span class="hljs-string">    - output_dir: str, CSV文件输出目录，默认为&#x27;./outliers&#x27;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    返回:</span><br><span class="hljs-string">    - DataFrame: 包含异常值的完整样本数据</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 检查列名是否存在</span><br>    <span class="hljs-keyword">if</span> column_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> outliers_summary:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;列 &#x27;<span class="hljs-subst">&#123;column_name&#125;</span>&#x27; 不在异常值检测结果中&quot;</span>)<br>    <br>    <span class="hljs-comment"># 获取异常值信息</span><br>    outliers_info = outliers_summary[column_name]<br>    <br>    <span class="hljs-comment"># 打印异常值统计信息</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">20</span>&#125;</span> <span class="hljs-subst">&#123;column_name&#125;</span> 异常值详情 <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">20</span>&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;异常值数量: <span class="hljs-subst">&#123;outliers_info[<span class="hljs-string">&#x27;outliers_count&#x27;</span>]&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;异常值占比: <span class="hljs-subst">&#123;outliers_info[<span class="hljs-string">&#x27;outliers_percentage&#x27;</span>]:<span class="hljs-number">.2</span>f&#125;</span>%&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n异常值分布:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;最小值: <span class="hljs-subst">&#123;outliers_info[<span class="hljs-string">&#x27;outliers_values&#x27;</span>].<span class="hljs-built_in">min</span>():<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;最大值: <span class="hljs-subst">&#123;outliers_info[<span class="hljs-string">&#x27;outliers_values&#x27;</span>].<span class="hljs-built_in">max</span>():<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;均值: <span class="hljs-subst">&#123;outliers_info[<span class="hljs-string">&#x27;outliers_values&#x27;</span>].mean():<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;标准差: <span class="hljs-subst">&#123;outliers_info[<span class="hljs-string">&#x27;outliers_values&#x27;</span>].std():<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 获取包含异常值的完整样本数据</span><br>    outliers_data = data.loc[outliers_info[<span class="hljs-string">&#x27;outliers_index&#x27;</span>]].copy()<br>    <br>    <span class="hljs-comment"># 添加一列标记这是异常值</span><br>    outliers_data[<span class="hljs-string">&#x27;is_outlier&#x27;</span>] = <span class="hljs-literal">True</span><br>    outliers_data[<span class="hljs-string">&#x27;outlier_value&#x27;</span>] = outliers_info[<span class="hljs-string">&#x27;outliers_values&#x27;</span>]<br>    <br>    <span class="hljs-comment"># 保存为CSV文件</span><br>    <span class="hljs-keyword">if</span> save_csv:<br>        <span class="hljs-comment"># 创建输出目录</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(output_dir):<br>            os.makedirs(output_dir)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n创建输出目录: <span class="hljs-subst">&#123;output_dir&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-comment"># 生成文件名</span><br>        timestamp = datetime.now().strftime(<span class="hljs-string">&#x27;%Y%m%d_%H%M%S&#x27;</span>)<br>        filename = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;column_name&#125;</span>_outliers_samples_<span class="hljs-subst">&#123;timestamp&#125;</span>.csv&quot;</span><br>        filepath = os.path.join(output_dir, filename)<br>        <br>        <span class="hljs-comment"># 保存CSV文件</span><br>        outliers_data.to_csv(filepath, index=<span class="hljs-literal">True</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n异常值完整样本数据已保存至: <span class="hljs-subst">&#123;filepath&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-keyword">return</span> outliers_data<br><br><span class="hljs-comment"># 使用示例</span><br>selected_columns_detail = [<span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;windspeed&#x27;</span>]<br><span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> selected_columns_detail:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span>)<br>    outliers_data = get_column_outliers(<br>        outliers_summary_all, <span class="hljs-comment"># plot_iqr_outliers_selected_columns()函数返回结果</span><br>        column,<br>        data=train_data,  <span class="hljs-comment"># 传入原始数据集</span><br>        save_csv=<span class="hljs-literal">True</span>,    <span class="hljs-comment"># 保存为CSV</span><br>        output_dir=<span class="hljs-string">&#x27;./outliers&#x27;</span>  <span class="hljs-comment"># 指定输出目录</span><br>    )<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n异常值样本预览:&quot;</span>)<br>    display(outliers_data.head())<br></code></pre></td></tr></table></figure><p>​<br>​<br>​ ==================== humidity 异常值详情 ==================== ​ 异常值数量: 22 ​ 异常值占比: 0.20% ​</p><pre><code class="hljs">异常值分布:
最小值: 0.00
最大值: 0.00
均值: 0.00
标准差: 0.00

异常值完整样本数据已保存至: ./outliers\humidity_outliers_samples_20250224_181014.csv

异常值样本预览:</code></pre><div><style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style><table border="1" class="dataframe"><thead><tr style="text-align:right"><th></th><th>datetime</th><th>season</th><th>holiday</th><th>workingday</th><th>weather</th><th>temp</th><th>atemp</th><th>humidity</th><th>windspeed</th><th>casual</th><th>...</th><th>year</th><th>month</th><th>day</th><th>hour</th><th>minute</th><th>weekday</th><th>quarter</th><th>is_weekend</th><th>is_outlier</th><th>outlier_value</th></tr></thead><tbody><tr><th>1091</th><td>2011-03-10 00:00:00</td><td>1</td><td>0</td><td>1</td><td>3</td><td>13.94</td><td>15.910</td><td>0</td><td>16.9979</td><td>3</td><td>...</td><td>2011</td><td>3</td><td>10</td><td>0</td><td>0</td><td>3</td><td>1</td><td>0</td><td>True</td><td>0</td></tr><tr><th>1092</th><td>2011-03-10 01:00:00</td><td>1</td><td>0</td><td>1</td><td>3</td><td>13.94</td><td>15.910</td><td>0</td><td>16.9979</td><td>0</td><td>...</td><td>2011</td><td>3</td><td>10</td><td>1</td><td>0</td><td>3</td><td>1</td><td>0</td><td>True</td><td>0</td></tr><tr><th>1093</th><td>2011-03-10 02:00:00</td><td>1</td><td>0</td><td>1</td><td>3</td><td>13.94</td><td>15.910</td><td>0</td><td>16.9979</td><td>0</td><td>...</td><td>2011</td><td>3</td><td>10</td><td>2</td><td>0</td><td>3</td><td>1</td><td>0</td><td>True</td><td>0</td></tr><tr><th>1094</th><td>2011-03-10 05:00:00</td><td>1</td><td>0</td><td>1</td><td>3</td><td>14.76</td><td>17.425</td><td>0</td><td>12.9980</td><td>1</td><td>...</td><td>2011</td><td>3</td><td>10</td><td>5</td><td>0</td><td>3</td><td>1</td><td>0</td><td>True</td><td>0</td></tr><tr><th>1095</th><td>2011-03-10 06:00:00</td><td>1</td><td>0</td><td>1</td><td>3</td><td>14.76</td><td>16.665</td><td>0</td><td>22.0028</td><td>0</td><td>...</td><td>2011</td><td>3</td><td>10</td><td>6</td><td>0</td><td>3</td><td>1</td><td>0</td><td>True</td><td>0</td></tr></tbody></table><p>5 rows × 23 columns</p></div><p>​<br>​<br>​<br>​ ==================== windspeed 异常值详情 ==================== ​ 异常值数量: 147 ​ 异常值占比: 1.35% ​</p><pre><code class="hljs">异常值分布:
最小值: 35.00
最大值: 57.00
均值: 38.54
标准差: 4.27

异常值完整样本数据已保存至: ./outliers\windspeed_outliers_samples_20250224_181015.csv

异常值样本预览:</code></pre><div><style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style><table border="1" class="dataframe"><thead><tr style="text-align:right"><th></th><th>datetime</th><th>season</th><th>holiday</th><th>workingday</th><th>weather</th><th>temp</th><th>atemp</th><th>humidity</th><th>windspeed</th><th>casual</th><th>...</th><th>year</th><th>month</th><th>day</th><th>hour</th><th>minute</th><th>weekday</th><th>quarter</th><th>is_weekend</th><th>is_outlier</th><th>outlier_value</th></tr></thead><tbody><tr><th>178</th><td>2011-01-08 17:00:00</td><td>1</td><td>0</td><td>0</td><td>1</td><td>6.56</td><td>6.060</td><td>37</td><td>36.9974</td><td>5</td><td>...</td><td>2011</td><td>1</td><td>8</td><td>17</td><td>0</td><td>5</td><td>1</td><td>1</td><td>True</td><td>36.9974</td></tr><tr><th>194</th><td>2011-01-09 09:00:00</td><td>1</td><td>0</td><td>0</td><td>1</td><td>4.92</td><td>3.790</td><td>46</td><td>35.0008</td><td>0</td><td>...</td><td>2011</td><td>1</td><td>9</td><td>9</td><td>0</td><td>6</td><td>1</td><td>1</td><td>True</td><td>35.0008</td></tr><tr><th>196</th><td>2011-01-09 11:00:00</td><td>1</td><td>0</td><td>0</td><td>1</td><td>6.56</td><td>6.060</td><td>40</td><td>35.0008</td><td>2</td><td>...</td><td>2011</td><td>1</td><td>9</td><td>11</td><td>0</td><td>6</td><td>1</td><td>1</td><td>True</td><td>35.0008</td></tr><tr><th>265</th><td>2011-01-12 12:00:00</td><td>1</td><td>0</td><td>1</td><td>1</td><td>8.20</td><td>7.575</td><td>47</td><td>39.0007</td><td>3</td><td>...</td><td>2011</td><td>1</td><td>12</td><td>12</td><td>0</td><td>2</td><td>1</td><td>0</td><td>True</td><td>39.0007</td></tr><tr><th>271</th><td>2011-01-12 18:00:00</td><td>1</td><td>0</td><td>1</td><td>1</td><td>8.20</td><td>7.575</td><td>47</td><td>35.0008</td><td>2</td><td>...</td><td>2011</td><td>1</td><td>12</td><td>18</td><td>0</td><td>2</td><td>1</td><td>0</td><td>True</td><td>35.0008</td></tr></tbody></table><p>5 rows × 23 columns</p></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><br></code></pre></td></tr></table></figure><h5 id="基于模型检测目标变量异常值">基于模型检测目标变量异常值</h5><p><strong>代码整体思路：</strong></p><p>通过计算模型预测值和真实y值之间的残差，并利用残差的均值和标准差来计算z值。然后，根据设定的sigma阈值，将绝对值大于sigma的z值作为异常值进行检测和标记。最后，通过打印输出和可视化子图展示异常值的相关信息。目的是识别和理解模型中的异常值，以便进一步进行数据处理或模型调整。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rmse</span>(<span class="hljs-params">y_true, y_pred</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;均方根误差&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> np.sqrt(mean_squared_error(y_true, y_pred))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_outliers</span>(<span class="hljs-params">model, data, feature_columns, target=<span class="hljs-string">&#x27;count&#x27;</span>, sigma=<span class="hljs-number">3</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    检测数据集中的异常值。</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - model: 用于预测的模型对象</span><br><span class="hljs-string">    - data: DataFrame, 包含特征和目标变量的数据集</span><br><span class="hljs-string">    - feature_columns: list, 用于预测的特征列名列表</span><br><span class="hljs-string">    - target: str, 目标变量列名，默认为&#x27;count&#x27;</span><br><span class="hljs-string">    - sigma: float, 标准差倍数阈值，默认为3</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    返回:</span><br><span class="hljs-string">    - outliers: 异常值的索引</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 准备数据</span><br>    X = data[feature_columns]<br>    y = data[target]<br>    <br>    <span class="hljs-comment"># 使用模型预测y值</span><br>    <span class="hljs-keyword">try</span>:<br>        y_pred = pd.Series(model.predict(X), index=y.index)<br>    <span class="hljs-keyword">except</span>:<br>        model.fit(X, y)<br>        y_pred = pd.Series(model.predict(X), index=y.index)<br>        <br>    <span class="hljs-comment"># 计算残差统计量</span><br>    resid = y - y_pred     <br>    mean_resid = resid.mean()  <br>    std_resid = resid.std()    <br><br>    <span class="hljs-comment"># 计算z统计量，标记异常值</span><br>    z = (resid - mean_resid)/std_resid    <br>    outliers = z[<span class="hljs-built_in">abs</span>(z) &gt; sigma].index<br>    <br>    <span class="hljs-comment"># 打印分析结果</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">20</span>&#125;</span> 异常值检测报告 <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">20</span>&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 1. 模型性能指标</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n1. 模型性能指标:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;R² score: <span class="hljs-subst">&#123;model.score(X,y):<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;RMSE: <span class="hljs-subst">&#123;rmse(y, y_pred):<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;MSE: <span class="hljs-subst">&#123;mean_squared_error(y,y_pred):<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 2. 残差统计信息</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n2. 残差统计信息:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;残差均值: <span class="hljs-subst">&#123;mean_resid:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;残差标准差: <span class="hljs-subst">&#123;std_resid:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 3. 异常值统计</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n3. 异常值统计:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;检测到的异常值数量: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(outliers)&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;异常值占比: <span class="hljs-subst">&#123;(<span class="hljs-built_in">len</span>(outliers)/<span class="hljs-built_in">len</span>(data))*<span class="hljs-number">100</span>:<span class="hljs-number">.2</span>f&#125;</span>%&quot;</span>)<br>    <br>    <span class="hljs-comment"># 4. 可视化分析</span><br>    plt.style.use(<span class="hljs-string">&#x27;seaborn&#x27;</span>)<br>    fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">20</span>, <span class="hljs-number">6</span>))<br>    <br>    <span class="hljs-comment"># 4.1 真实值vs预测值的散点图</span><br>    axes[<span class="hljs-number">0</span>].scatter(y, y_pred, c=<span class="hljs-string">&#x27;blue&#x27;</span>, alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">&#x27;Normal&#x27;</span>)<br>    axes[<span class="hljs-number">0</span>].scatter(y.loc[outliers], y_pred.loc[outliers], <br>                   c=<span class="hljs-string">&#x27;red&#x27;</span>, alpha=<span class="hljs-number">0.7</span>, label=<span class="hljs-string">&#x27;Outlier&#x27;</span>)<br>    axes[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">&#x27;True vs Predicted Values&#x27;</span>, pad=<span class="hljs-number">15</span>)<br>    axes[<span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">&#x27;True Values&#x27;</span>)<br>    axes[<span class="hljs-number">0</span>].set_ylabel(<span class="hljs-string">&#x27;Predicted Values&#x27;</span>)<br>    axes[<span class="hljs-number">0</span>].legend()<br>    axes[<span class="hljs-number">0</span>].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br><br>    <span class="hljs-comment"># 4.2 真实值vs残差的散点图</span><br>    axes[<span class="hljs-number">1</span>].scatter(y, y-y_pred, c=<span class="hljs-string">&#x27;blue&#x27;</span>, alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">&#x27;Normal&#x27;</span>)<br>    axes[<span class="hljs-number">1</span>].scatter(y.loc[outliers], y.loc[outliers]-y_pred.loc[outliers], <br>                   c=<span class="hljs-string">&#x27;red&#x27;</span>, alpha=<span class="hljs-number">0.7</span>, label=<span class="hljs-string">&#x27;Outlier&#x27;</span>)<br>    axes[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">&#x27;Residuals vs True Values&#x27;</span>, pad=<span class="hljs-number">15</span>)<br>    axes[<span class="hljs-number">1</span>].set_xlabel(<span class="hljs-string">&#x27;True Values&#x27;</span>)<br>    axes[<span class="hljs-number">1</span>].set_ylabel(<span class="hljs-string">&#x27;Residuals&#x27;</span>)<br>    axes[<span class="hljs-number">1</span>].legend()<br>    axes[<span class="hljs-number">1</span>].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br><br>    <span class="hljs-comment"># 4.3 z统计量的直方图</span><br>    sns.histplot(z, bins=<span class="hljs-number">50</span>, ax=axes[<span class="hljs-number">2</span>], color=<span class="hljs-string">&#x27;blue&#x27;</span>, <br>                alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">&#x27;Normal&#x27;</span>)<br>    sns.histplot(z[outliers], bins=<span class="hljs-number">50</span>, ax=axes[<span class="hljs-number">2</span>], <br>                color=<span class="hljs-string">&#x27;red&#x27;</span>, alpha=<span class="hljs-number">0.7</span>, label=<span class="hljs-string">&#x27;Outlier&#x27;</span>)<br>    axes[<span class="hljs-number">2</span>].set_title(<span class="hljs-string">&#x27;Distribution of Z-scores&#x27;</span>, pad=<span class="hljs-number">15</span>)<br>    axes[<span class="hljs-number">2</span>].set_xlabel(<span class="hljs-string">&#x27;Z-score&#x27;</span>)<br>    axes[<span class="hljs-number">2</span>].set_ylabel(<span class="hljs-string">&#x27;Count&#x27;</span>)<br>    axes[<span class="hljs-number">2</span>].legend()<br>    axes[<span class="hljs-number">2</span>].grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, alpha=<span class="hljs-number">0.7</span>)<br><br>    plt.tight_layout()<br>    <span class="hljs-comment">#plt.savefig(&#x27;outliers_analysis.png&#x27;, dpi=300, bbox_inches=&#x27;tight&#x27;)</span><br>    plt.show()<br>    <br>    <span class="hljs-keyword">return</span> outliers<br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-comment"># 定义特征列</span><br>feature_columns = [<br>    <span class="hljs-string">&#x27;season&#x27;</span>, <span class="hljs-string">&#x27;weather&#x27;</span>, <span class="hljs-string">&#x27;temp&#x27;</span>, <span class="hljs-string">&#x27;atemp&#x27;</span>, <br>    <span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;windspeed&#x27;</span>, <span class="hljs-string">&#x27;year&#x27;</span>, <span class="hljs-string">&#x27;month&#x27;</span>, <br>    <span class="hljs-string">&#x27;hour&#x27;</span>, <span class="hljs-string">&#x27;weekday&#x27;</span><br>]<br><br><span class="hljs-comment"># 使用随机森林模型检测异常值</span><br>rf_model = RandomForestRegressor(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>)<br>outliers = find_outliers(<br>    model=rf_model,<br>    data=train_data,<br>    feature_columns=feature_columns,<br>    target=<span class="hljs-string">&#x27;count&#x27;</span>,<br>    sigma=<span class="hljs-number">3</span><br>)<br><br><span class="hljs-comment">#train_data_outliers=train_data.loc[outliers]</span><br><br></code></pre></td></tr></table></figure><pre><code class="hljs">==================== 异常值检测报告 ====================

1. 模型性能指标:
R² score: 0.9920
RMSE: 16.2065
MSE: 262.6518

2. 残差统计信息:
残差均值: -0.5107
残差标准差: 16.1992

3. 异常值统计:
检测到的异常值数量: 213
异常值占比: 1.96%</code></pre><figure><img src="/img/EDA-stacking_files/EDA-stacking_77_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data.loc[outliers]<br></code></pre></td></tr></table></figure><div><style scoped>.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style><table border="1" class="dataframe"><thead><tr style="text-align:right"><th></th><th>datetime</th><th>season</th><th>holiday</th><th>workingday</th><th>weather</th><th>temp</th><th>atemp</th><th>humidity</th><th>windspeed</th><th>casual</th><th>...</th><th>count</th><th>date</th><th>year</th><th>month</th><th>day</th><th>hour</th><th>minute</th><th>weekday</th><th>quarter</th><th>is_weekend</th></tr></thead><tbody><tr><th>380</th><td>2011-01-17 08:00:00</td><td>1</td><td>1</td><td>0</td><td>2</td><td>6.56</td><td>7.575</td><td>47</td><td>15.001300</td><td>3</td><td>...</td><td>33</td><td>2011-01-17</td><td>2011</td><td>1</td><td>17</td><td>8</td><td>0</td><td>0</td><td>1</td><td>0</td></tr><tr><th>1699</th><td>2011-04-16 17:00:00</td><td>2</td><td>0</td><td>0</td><td>3</td><td>20.50</td><td>24.240</td><td>88</td><td>39.000700</td><td>1</td><td>...</td><td>15</td><td>2011-04-16</td><td>2011</td><td>4</td><td>16</td><td>17</td><td>0</td><td>5</td><td>2</td><td>1</td></tr><tr><th>1802</th><td>2011-05-02 00:00:00</td><td>2</td><td>0</td><td>1</td><td>1</td><td>18.86</td><td>22.725</td><td>72</td><td>8.998100</td><td>68</td><td>...</td><td>177</td><td>2011-05-02</td><td>2011</td><td>5</td><td>2</td><td>0</td><td>0</td><td>0</td><td>2</td><td>0</td></tr><tr><th>2035</th><td>2011-05-11 17:00:00</td><td>2</td><td>0</td><td>1</td><td>1</td><td>26.24</td><td>31.060</td><td>47</td><td>7.001500</td><td>17</td><td>...</td><td>259</td><td>2011-05-11</td><td>2011</td><td>5</td><td>11</td><td>17</td><td>0</td><td>2</td><td>2</td><td>0</td></tr><tr><th>2036</th><td>2011-05-11 18:00:00</td><td>2</td><td>0</td><td>1</td><td>1</td><td>25.42</td><td>31.060</td><td>50</td><td>19.999500</td><td>40</td><td>...</td><td>274</td><td>2011-05-11</td><td>2011</td><td>5</td><td>11</td><td>18</td><td>0</td><td>2</td><td>2</td><td>0</td></tr><tr><th>...</th><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><th>10271</th><td>2012-11-13 09:00:00</td><td>4</td><td>0</td><td>1</td><td>3</td><td>13.12</td><td>15.150</td><td>81</td><td>22.002800</td><td>1</td><td>...</td><td>110</td><td>2012-11-13</td><td>2012</td><td>11</td><td>13</td><td>9</td><td>0</td><td>1</td><td>4</td><td>0</td></tr><tr><th>10466</th><td>2012-12-02 12:00:00</td><td>4</td><td>0</td><td>0</td><td>2</td><td>13.94</td><td>16.665</td><td>81</td><td>11.001400</td><td>111</td><td>...</td><td>520</td><td>2012-12-02</td><td>2012</td><td>12</td><td>2</td><td>12</td><td>0</td><td>6</td><td>4</td><td>1</td></tr><tr><th>10486</th><td>2012-12-03 08:00:00</td><td>4</td><td>0</td><td>1</td><td>1</td><td>14.76</td><td>18.940</td><td>93</td><td>7.776656</td><td>19</td><td>...</td><td>731</td><td>2012-12-03</td><td>2012</td><td>12</td><td>3</td><td>8</td><td>0</td><td>0</td><td>4</td><td>0</td></tr><tr><th>10533</th><td>2012-12-05 07:00:00</td><td>4</td><td>0</td><td>1</td><td>3</td><td>18.86</td><td>22.725</td><td>59</td><td>19.999500</td><td>9</td><td>...</td><td>398</td><td>2012-12-05</td><td>2012</td><td>12</td><td>5</td><td>7</td><td>0</td><td>2</td><td>4</td><td>0</td></tr><tr><th>10582</th><td>2012-12-07 08:00:00</td><td>4</td><td>0</td><td>1</td><td>2</td><td>12.30</td><td>14.395</td><td>75</td><td>12.998000</td><td>11</td><td>...</td><td>441</td><td>2012-12-07</td><td>2012</td><td>12</td><td>7</td><td>8</td><td>0</td><td>4</td><td>4</td><td>0</td></tr></tbody></table><p>213 rows × 21 columns</p></div><h5 id="iqr与模型方法对比分析">IQR与模型方法对比分析</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> matplotlib_venn <span class="hljs-keyword">import</span> venn2<br>plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]  <span class="hljs-comment"># 用来正常显示中文标签</span><br>plt.rcParams[<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="hljs-literal">False</span>    <span class="hljs-comment"># 用来正常显示负号</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_outlier_methods</span>(<span class="hljs-params">data, feature_columns, target=<span class="hljs-string">&#x27;count&#x27;</span>, </span><br><span class="hljs-params">                          iqr_threshold=<span class="hljs-number">1.5</span>, model_sigma=<span class="hljs-number">3</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    比较IQR方法和基于模型的异常值检测方法</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - feature_columns: list, 用于检测target变量的特征</span><br><span class="hljs-string">    - target: str, 待检测变量列名</span><br><span class="hljs-string">    - iqr_threshold: float, IQR方法的阈值</span><br><span class="hljs-string">    - model_sigma: float, 模型方法的sigma阈值</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 1. IQR方法检测</span><br>    Q1 = data[target].quantile(<span class="hljs-number">0.25</span>)<br>    Q3 = data[target].quantile(<span class="hljs-number">0.75</span>)<br>    IQR = Q3 - Q1<br>    iqr_outliers = data[<br>        (data[target] &lt; Q1 - iqr_threshold * IQR) | <br>        (data[target] &gt; Q3 + iqr_threshold * IQR)<br>    ].index<br>    <br>    <span class="hljs-comment"># 2. 模型方法检测</span><br>    rf_model = RandomForestRegressor(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>)<br>    model_outliers = find_outliers(<br>        model=rf_model,<br>        data=data,<br>        feature_columns=feature_columns,<br>        target=target,<br>        sigma=model_sigma<br>    )<br>    <br>    <span class="hljs-comment"># 3. 比较结果</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n比较结果:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;IQR方法检测到的异常值数量: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(iqr_outliers)&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;模型方法检测到的异常值数量: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(model_outliers)&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 计算重叠部分</span><br>    common_outliers = <span class="hljs-built_in">set</span>(iqr_outliers) &amp; <span class="hljs-built_in">set</span>(model_outliers)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;两种方法共同检测到的异常值数量: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(common_outliers)&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 可视化比较</span><br>    plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">6</span>))<br>    venn2([<span class="hljs-built_in">set</span>(iqr_outliers), <span class="hljs-built_in">set</span>(model_outliers)], <br>          set_labels=(<span class="hljs-string">&#x27;IQR Method&#x27;</span>, <span class="hljs-string">&#x27;Model Method&#x27;</span>))<br>    plt.title(<span class="hljs-string">&#x27;Comparison of Outlier Detection Methods&#x27;</span>)<br>    plt.show()<br>    <br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&#x27;iqr_outliers&#x27;</span>: iqr_outliers,<br>        <span class="hljs-string">&#x27;model_outliers&#x27;</span>: model_outliers,<br>        <span class="hljs-string">&#x27;common_outliers&#x27;</span>: common_outliers<br>    &#125;<br><br><span class="hljs-comment"># 使用示例</span><br>feature_columns = [<br>    <span class="hljs-string">&#x27;season&#x27;</span>, <span class="hljs-string">&#x27;weather&#x27;</span>, <span class="hljs-string">&#x27;temp&#x27;</span>, <span class="hljs-string">&#x27;atemp&#x27;</span>, <br>    <span class="hljs-string">&#x27;humidity&#x27;</span>, <span class="hljs-string">&#x27;year&#x27;</span>, <span class="hljs-string">&#x27;month&#x27;</span>, <br>    <span class="hljs-string">&#x27;hour&#x27;</span><br>]<br>comparison_results = compare_outlier_methods(<br>    data=train_data,<br>    feature_columns=feature_columns,<br>    target=<span class="hljs-string">&#x27;windspeed&#x27;</span>,<br>    iqr_threshold=<span class="hljs-number">1.5</span>,<br>    model_sigma=<span class="hljs-number">3</span><br>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">==================== 异常值检测报告 ====================

1. 模型性能指标:
R² score: 0.9188
RMSE: 1.9433
MSE: 3.7765

2. 残差统计信息:
残差均值: -0.0311
残差标准差: 1.9432

3. 异常值统计:
检测到的异常值数量: 204
异常值占比: 1.87%</code></pre><figure><img src="/img/EDA-stacking_files/EDA-stacking_80_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><p>​<br>​ 比较结果: ​ IQR方法检测到的异常值数量: 147 ​ 模型方法检测到的异常值数量: 204 ​ 两种方法共同检测到的异常值数量: 50</p><figure><img src="/img/EDA-stacking_files/EDA-stacking_80_3.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><br>&#123;<br>    <span class="hljs-string">&quot;IQR方法&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;优点&quot;</span>: [<br>            <span class="hljs-string">&quot;无需模型训练，计算简单快速&quot;</span>,<br>            <span class="hljs-string">&quot;基于数据分布特征，不受模型影响&quot;</span>,<br>            <span class="hljs-string">&quot;适用于单变量分析&quot;</span>,<br>            <span class="hljs-string">&quot;容易理解和解释&quot;</span>,<br>            <span class="hljs-string">&quot;对数据分布假设较少&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;缺点&quot;</span>: [<br>            <span class="hljs-string">&quot;无法考虑特征之间的关系&quot;</span>,<br>            <span class="hljs-string">&quot;可能忽略多维数据中的复杂异常模式&quot;</span>,<br>            <span class="hljs-string">&quot;对多变量异常值检测效果不佳&quot;</span>,<br>            <span class="hljs-string">&quot;固定的阈值(1.5*IQR)可能不适合所有场景&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;适用场景&quot;</span>: [<br>            <span class="hljs-string">&quot;数据预处理初期的快速异常检测&quot;</span>,<br>            <span class="hljs-string">&quot;单变量异常值分析&quot;</span>,<br>            <span class="hljs-string">&quot;数据分布较为对称的情况&quot;</span>,<br>            <span class="hljs-string">&quot;需要快速获得数据质量概览&quot;</span><br>        ]<br>    &#125;,<br>    <br>    <span class="hljs-string">&quot;基于模型的方法(find_outliers)&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;优点&quot;</span>: [<br>            <span class="hljs-string">&quot;考虑了特征间的相互关系&quot;</span>,<br>            <span class="hljs-string">&quot;可以发现复杂的异常模式&quot;</span>,<br>            <span class="hljs-string">&quot;基于预测残差，更符合业务逻辑&quot;</span>,<br>            <span class="hljs-string">&quot;可以根据模型预测效果动态调整&quot;</span>,<br>            <span class="hljs-string">&quot;适合处理多维特征的异常值&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;缺点&quot;</span>: [<br>            <span class="hljs-string">&quot;需要训练模型，计算成本较高&quot;</span>,<br>            <span class="hljs-string">&quot;依赖模型的质量和选择&quot;</span>,<br>            <span class="hljs-string">&quot;可能受到模型过拟合的影响&quot;</span>,<br>            <span class="hljs-string">&quot;参数调整较为复杂&quot;</span><br>        ],<br>        <span class="hljs-string">&quot;适用场景&quot;</span>: [<br>            <span class="hljs-string">&quot;多变量异常值检测&quot;</span>,<br>            <span class="hljs-string">&quot;需要考虑特征关联性的场景&quot;</span>,<br>            <span class="hljs-string">&quot;有明确的预测目标&quot;</span>,<br>            <span class="hljs-string">&quot;数据量较大且特征较多的情况&quot;</span><br>        ]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>建议:</p><ol type="1"><li><p>对于自行车租赁需求预测这个场景,我建议使用基 于模型的方法(find_outliers),原因是:</p><ul><li>需求预测涉及多个特征的交互作用</li><li>异常值可能与多个因素相关(如天气、温度、时间等)</li><li>预测目标明确,适合使用模型方法</li><li>数据量较大,特征较多</li></ul></li><li><p>最佳实践:</p><ul><li>可以先用IQR方法进行初步筛查</li><li>再使用模型方法进行深入分析</li><li>重点关注两种方法都检测出的异常值</li><li>结合业务逻辑判断是否需要处理这些异常值</li></ul></li><li><p>处理建议:</p><ul><li><p>对于共同检测出的异常值,优先考虑处理</p></li><li><p>仅被单个方法检测出的异常值需要进一步分析</p></li><li><p>结合业务场景判断是否为真实异常</p></li><li><p>可以考虑对异常值进行分类处理而不是简单删除</p></li></ul></li><li><p>参数调整:</p></li></ol><ul><li><p>IQR方法的threshold可以根据数据分布调整(1.5是常用值)</p></li><li><p>模型方法的sigma可以根据业务容忍度调整(3是常用值)</p></li><li><p>可以尝试不同的参数组合找到最适合的阈值</p></li></ul><hr><p>主要区别:</p><ol type="1"><li>IQR方法（plot_iqr_outliers_all_columns）：</li></ol><ul><li><p>检测所有数值列的异常值</p></li><li><p>基于每列自身的分布特征（Q1, Q3, IQR）</p></li><li><p>不考虑特征之间的关系</p></li><li><p>适合单变量分析</p></li></ul><ol start="2" type="1"><li>基于模型的方法（find_outliers）：</li></ol><ul><li><p>只检测目标变量 'count' 的异常值</p></li><li><p>基于所有特征列预测 'count' 的结果</p></li><li><p>考虑了特征与目标变量之间的关系</p></li><li><p>适合多变量分析</p></li></ul><p>这个改进版本的主要特点：</p><ol type="1"><li><p>迭代处理：</p><ul><li>每轮迭代先处理特征列的异常值</li><li>再检测目标变量的异常值</li><li>合并两种方法检测到的异常值</li></ul></li><li><p>双重检测：</p><ul><li>使用IQR方法检测特征列异常值</li><li>使用基于模型的方法检测目标变量异常值</li></ul></li><li><p>异常值处理：</p><ul><li>使用中位数替换检测到的异常值</li><li>下一轮迭代使用处理后的数据继续检测</li></ul></li><li><p>终止条件：</p><ul><li>达到最大迭代次数</li><li>或没有检测到新的异常值</li></ul></li><li><p>结果可视化：</p><ul><li>展示每轮迭代检测到的异常值数量</li><li>帮助理解异常值检测的收敛过程</li></ul></li></ol><p>这种方法的优势：</p><ol type="1"><li>更全面：同时考虑特征列和目标变量的异常值</li><li>更稳健：通过迭代方式逐步处理异常值</li><li>更可靠：结合多种检测方法，互相验证</li><li>可追踪：记录每轮迭代的检测结果</li></ol><p>使用建议：</p><ol type="1"><li>根据数据特点调整 <span class="math inline">\(sigma\)</span> 和 <span class="math inline">\(max\_iterations\)</span> 参数</li><li>观察迭代过程中异常值数量的变化</li><li>结合业务逻辑判断是否需要处理所有检测到的异常值</li><li>可以尝试不同的异常值替换方法（如均值、插值等）</li></ol><h5 id="异常值处理策略">异常值处理策略</h5><p>outlier_handling_methods = { "1. 保留异常值": { "方法描述": [ "不对异常值进行处理", "保持数据的原始分布", "适用于异常值包含重要信息的场景" ], "优点": [ "保持数据的真实性", "不损失信息", "适合非参数模型" ], "缺点": [ "可能影响模型训练", "可能降低预测准确性", "可能导致模型偏差" ], "适用性评分": "中等", "适用场景": [ "使用树模型等对异常值不敏感的模型", "异常值代表真实的业务场景", "数据量较大时" ] },</p><pre><code class="hljs">&quot;2. 删除异常值&quot;: &#123;
    &quot;方法描述&quot;: [
        &quot;直接删除被识别为异常的样本&quot;,
        &quot;清理数据集&quot;,
        &quot;适用于异常值明显错误的场景&quot;
    ],
    &quot;优点&quot;: [
        &quot;处理方法简单直接&quot;,
        &quot;可以提高数据质量&quot;,
        &quot;减少噪声影响&quot;
    ],
    &quot;缺点&quot;: [
        &quot;可能丢失有用信息&quot;,
        &quot;减少样本量&quot;,
        &quot;可能引入选择偏差&quot;
    ],
    &quot;适用性评分&quot;: &quot;低&quot;,
    &quot;适用场景&quot;: [
        &quot;异常值明显是错误数据&quot;,
        &quot;样本量充足&quot;,
        &quot;异常值比例较小&quot;
    ]
&#125;,

&quot;3. 替换异常值&quot;: &#123;
    &quot;统计替换&quot;: &#123;
        &quot;方法描述&quot;: [
            &quot;使用统计量替换异常值&quot;,
            &quot;常用统计量：均值、中位数、众数&quot;,
            &quot;可以按分组进行替换&quot;
        ],
        &quot;优点&quot;: [
            &quot;实现简单&quot;,
            &quot;保持数据量&quot;,
            &quot;不改变整体分布&quot;
        ],
        &quot;缺点&quot;: [
            &quot;可能降低数据方差&quot;,
            &quot;可能忽略特征关系&quot;,
            &quot;替换值可能不符合实际&quot;
        ],
        &quot;适用性评分&quot;: &quot;中等&quot;,
        &quot;适用场景&quot;: [
            &quot;异常值分布较随机&quot;,
            &quot;特征间相关性不强&quot;,
            &quot;需要快速处理&quot;
        ]
    &#125;,
    
    &quot;插值替换&quot;: &#123;
        &quot;方法描述&quot;: [
            &quot;使用相邻值进行插值&quot;,
            &quot;可以是线性插值或更复杂的插值方法&quot;,
            &quot;考虑数据的时间序列特性&quot;
        ],
        &quot;优点&quot;: [
            &quot;保持数据的连续性&quot;,
            &quot;考虑时间序列特征&quot;,
            &quot;更符合实际变化&quot;
        ],
        &quot;缺点&quot;: [
            &quot;计算复杂度较高&quot;,
            &quot;需要合适的时间窗口&quot;,
            &quot;可能受噪声影响&quot;
        ],
        &quot;适用性评分&quot;: &quot;高&quot;,
        &quot;适用场景&quot;: [
            &quot;时间序列数据&quot;,
            &quot;数据具有连续性&quot;,
            &quot;异常值周围有可靠数据&quot;
        ]
    &#125;,
    
    &quot;模型预测替换&quot;: &#123;
        &quot;方法描述&quot;: [
            &quot;使用模型预测值替换异常值&quot;,
            &quot;可以考虑多个特征的关系&quot;,
            &quot;适合复杂的数据关系&quot;
        ],
        &quot;优点&quot;: [
            &quot;考虑特征间关系&quot;,
            &quot;预测值更准确&quot;,
            &quot;适应性强&quot;
        ],
        &quot;缺点&quot;: [
            &quot;计算成本高&quot;,
            &quot;依赖模型质量&quot;,
            &quot;可能过度平滑&quot;
        ],
        &quot;适用性评分&quot;: &quot;高&quot;,
        &quot;适用场景&quot;: [
            &quot;特征间有强相关性&quot;,
            &quot;有足够训练数据&quot;,
            &quot;需要高精度替换&quot;
        ]
    &#125;
&#125;,

&quot;4. 分箱处理&quot;: &#123;
    &quot;方法描述&quot;: [
        &quot;将异常值映射到合适的分箱中&quot;,
        &quot;可以是等宽分箱或等频分箱&quot;,
        &quot;处理极端值&quot;
    ],
    &quot;优点&quot;: [
        &quot;保持数据的相对关系&quot;,
        &quot;减少极端值影响&quot;,
        &quot;便于特征工程&quot;
    ],
    &quot;缺点&quot;: [
        &quot;损失精确信息&quot;,
        &quot;需要合理的分箱策略&quot;,
        &quot;可能影响预测精度&quot;
    ],
    &quot;适用性评分&quot;: &quot;中等&quot;,
    &quot;适用场景&quot;: [
        &quot;处理极端值&quot;,
        &quot;特征工程需要&quot;,
        &quot;类别化处理&quot;
    ]
&#125;</code></pre><p>}</p><p>针对自行车租赁需求预测项目的建议处理方案： "主要处理方法": "组合策略", "具体步骤": [ { "步骤1": "时间序列特征异常值处理", "方法": "插值替换", "原因": [ "租赁需求具有时间连续性", "可以利用相邻时间点的信息", "保持数据的时序特性" ] }, { "步骤2": "天气相关特征异常值处理", "方法": "模型预测替换", "原因": [ "天气特征间存在相关性", "可以利用多个特征的关系", "提高替换值的准确性" ] }, { "步骤3": "极端需求值处理", "方法": "条件替换", "原因": [ "考虑特殊事件（节假日、活动等）", "保留合理的高需求值", "替换明显错误的异常值" ] } ],</p><h3 id="数据集成">数据集成</h3><h3 id="数据重采样">数据重采样</h3><h3 id="数据变换--连续变量离散化-分箱">数据变换- 连续变量离散化 (分箱)</h3><h3 id="数据变换--长尾分布处理">数据变换- 长尾分布处理</h3><p>长尾分布更多出现在以下两类场景中：</p><ol type="1"><li><p>多类别场景的类别分布： 在多分类任务或推荐系统、自然语言处理等场景下，可能发生极少数类别（或词汇、商品）出现频率远高于其余多数类别的现象。此时如果画出类别的频次直方图，会发现前几个“头部类别”占据了数据集绝大部分样本，而后续大量“尾部类别”则频次极低，但数目繁多，这种现象常被称为“长尾分布”或“帕累托分布”。</p></li><li><p>某一离散特征的取值分布： 如果数据集中某个离散或类别型特征具有数百乃至上千种取值，并且取值频次分布极其不平衡（少数取值出现次数非常多，绝大多数取值仅出现极少量样本），这同样是长尾分布。典型例子包括： 词频统计：少数“高频词”占据文本大部分词汇量，而大部分“低频词”仅出现很少次数； 产品销量：少数“热销商品”卖得很好，而众多“冷门商品”销量极低。</p></li></ol><p><strong>偏度调整</strong></p><blockquote><p>根据直方图和Q-Q图考虑是否对数据进行变换，使之符合正态分布</p></blockquote><p>Box-Cox变换 由于线性回归是基于正态分布的，因此在进行统计分析时，需要转换数据使其符合正态分布。</p><p>Box-Cox 变换是一种常见的数据转换技术，用于将非正态分布的数据<strong>转换为近似正态分布</strong>的数据。这一变换可以使线性回归模型在满足线性、正态性、独立性及方差齐性的同时，又不丢失信息。在对数据做Box-Cox变换之后，可以在一定程度上减小不可观测的误差和预测变量的相关性，这有<strong>利于线性模型的拟合及分析出特征的相关性</strong>。</p><p><strong>先归一化还是先转换？</strong></p><p>在做Box-Cox变换之前，需要对数据做归一化预处理。在归一化时，对数据进行合并操作可以使训练数据和测试数据一致。这种方式可以在线下分析建模中使用，而线上部署只需采用训练数据的归一化即可。</p><p>1.一般情况下，先Box-Cox后归一化</p><p>2.有负值时，考虑先归一化后Box-Cox</p><p>3.还原时顺序要与转换顺序相反</p><p>4.建议先检查数据特征再决定处理顺序</p><p>5.保持转换顶序的一致性和可追踪性</p><p><strong>对特征变量进行转换吗？</strong></p><p>是否需要对特征变量和目标变量都进行转换，取决于数据的分布、模型的要求以及你希望达成的目标。通常情况下，对目标变量进行转换更为常见，因为这有助于满足许多统计模型的假设。但是，在某些情况下，对特征变量进行转换也是有益的。最佳做法是尝试不同的转换方法，并根据模型的性能进行选择。</p><p>Box-Cox转换 = { "适用场景": [ "数据明显右偏", "需要满足线性模型假设", "方差不稳定" ], "不适用场景": [ "分类变量", "已经接近正态分布", "有明确的物理意义需要保持" ], "注意事项": [ "转换可能影响解释性", "需要考虑逆转换的需求", "注意保存转换参数" ] }</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BoxCoxPipeline</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Box-Cox转换通用流程</span><br><span class="hljs-string">    支持:</span><br><span class="hljs-string">    1. 同时转换特征列和目标变量列</span><br><span class="hljs-string">    2. 对测试集进行相同的转换</span><br><span class="hljs-string">    3. 智能处理测试集中不存在的目标变量列</span><br><span class="hljs-string"></span><br><span class="hljs-string">    1. 支持同时转换特征列和目标变量:</span><br><span class="hljs-string">    * 通过`columns`参数指定特征列</span><br><span class="hljs-string">    * 通过`target_col`参数指定目标变量</span><br><span class="hljs-string">    * 内部分别存储特征列和目标变量信息</span><br><span class="hljs-string"></span><br><span class="hljs-string">2. 测试集转换:</span><br><span class="hljs-string">    * `transform`方法会自动检查哪些列存在于测试集中</span><br><span class="hljs-string">    * 只对存在的列进行转换</span><br><span class="hljs-string">    * 提供警告信息说明转换了哪些列</span><br><span class="hljs-string"></span><br><span class="hljs-string">3. 处理测试集中不存在的目标变量列:</span><br><span class="hljs-string">    * `transform`方法会跳过不存在的列</span><br><span class="hljs-string">    * `inverse_transform`方法默认还原目标变量</span><br><span class="hljs-string">    * 可以通过`columns`参数指定要还原的列</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, visualization=<span class="hljs-literal">False</span></span>):<br>        self.lambda_params = &#123;&#125;  <span class="hljs-comment"># 存储lambda参数</span><br>        self.shifts = &#123;&#125;        <span class="hljs-comment"># 存储偏移量</span><br>        self.visualization = visualization<br>        self.transformed_columns = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 所有需要转换的列</span><br>        self.feature_columns = <span class="hljs-literal">None</span>     <span class="hljs-comment"># 特征列</span><br>        self.target_column = <span class="hljs-literal">None</span>       <span class="hljs-comment"># 目标变量列</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_numeric_columns</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;获取数值型列名&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> data.select_dtypes(include=[<span class="hljs-string">&#x27;int64&#x27;</span>, <span class="hljs-string">&#x27;float64&#x27;</span>]).columns.tolist()<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_non_positive</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;处理非正值&quot;&quot;&quot;</span><br>        min_val = x.<span class="hljs-built_in">min</span>()<br>        <span class="hljs-keyword">if</span> min_val &lt;= <span class="hljs-number">0</span>:<br>            shift = <span class="hljs-built_in">abs</span>(min_val) + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> x + shift, shift<br>        <span class="hljs-keyword">return</span> x, <span class="hljs-number">0</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_transformation</span>(<span class="hljs-params">self, original, transformed, col_name</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;可视化转换效果&quot;&quot;&quot;</span><br>        fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))<br>        fig.suptitle(<span class="hljs-string">f&#x27;Box-Cox Transformation for <span class="hljs-subst">&#123;col_name&#125;</span>&#x27;</span>)<br>        <br>        <span class="hljs-comment"># 原始数据分布</span><br>        sns.histplot(original, ax=axes[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>], kde=<span class="hljs-literal">True</span>)<br>        axes[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>].set_title(<span class="hljs-string">&#x27;Original Distribution&#x27;</span>)<br>        <br>        stats.probplot(original, plot=axes[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>])<br>        axes[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>].set_title(<span class="hljs-string">f&#x27;Original Q-Q Plot\nskew=<span class="hljs-subst">&#123;stats.skew(original):<span class="hljs-number">.4</span>f&#125;</span>&#x27;</span>)<br>        <br>        <span class="hljs-comment"># 转换后数据分布</span><br>        sns.histplot(transformed, ax=axes[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>], kde=<span class="hljs-literal">True</span>)<br>        axes[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>].set_title(<span class="hljs-string">&#x27;Transformed Distribution&#x27;</span>)<br>        <br>        stats.probplot(transformed, plot=axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>])<br>        axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].set_title(<span class="hljs-string">f&#x27;Transformed Q-Q Plot\nskew=<span class="hljs-subst">&#123;stats.skew(transformed):<span class="hljs-number">.4</span>f&#125;</span>&#x27;</span>)<br>        <br>        plt.tight_layout()<br>        plt.show()<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit_transform</span>(<span class="hljs-params">self, data, columns=<span class="hljs-literal">None</span>, target_col=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        拟合并转换数据</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - data: DataFrame, 输入数据</span><br><span class="hljs-string">        - columns: list or str, 需要转换的特征列名列表或单个列名</span><br><span class="hljs-string">        - target_col: str, 目标变量列名</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - DataFrame: 转换后的数据</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        result = data.copy()<br>        <br>        <span class="hljs-comment"># 1. 确定需要转换的列</span><br>        feature_cols = []<br>        <span class="hljs-keyword">if</span> columns <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            feature_cols = [columns] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(columns, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">list</span>(columns)<br>            <br>        <span class="hljs-comment"># 验证列名</span><br>        all_cols = feature_cols + ([target_col] <span class="hljs-keyword">if</span> target_col <span class="hljs-keyword">else</span> [])<br>        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> all_cols:<br>            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;列 <span class="hljs-subst">&#123;col&#125;</span> 不存在于数据中&quot;</span>)<br>            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self._get_numeric_columns(data):<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;列 <span class="hljs-subst">&#123;col&#125;</span> 不是数值型&quot;</span>)<br>        <br>        <span class="hljs-comment"># 保存转换信息</span><br>        self.feature_columns = feature_cols<br>        self.target_column = target_col<br>        self.transformed_columns = all_cols<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;将进行以下转换:&quot;</span>)<br>        <span class="hljs-keyword">if</span> feature_cols:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 特征列: <span class="hljs-subst">&#123;feature_cols&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">if</span> target_col:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 目标变量: <span class="hljs-subst">&#123;target_col&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-comment"># 2. 执行转换</span><br>        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> self.transformed_columns:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-comment"># 处理非正值</span><br>                x, shift = self._handle_non_positive(data[col].values)<br>                self.shifts[col] = shift<br>                <br>                <span class="hljs-comment"># 应用Box-Cox转换</span><br>                transformed_x, lambda_param = stats.boxcox(x)<br>                self.lambda_params[col] = lambda_param<br>                <br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n列 <span class="hljs-subst">&#123;col&#125;</span> 转换结果:&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- Lambda参数: <span class="hljs-subst">&#123;lambda_param:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 偏移量: <span class="hljs-subst">&#123;shift&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 偏度变化: <span class="hljs-subst">&#123;stats.skew(data[col]):<span class="hljs-number">.4</span>f&#125;</span> -&gt; <span class="hljs-subst">&#123;stats.skew(transformed_x):<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>                <br>                <span class="hljs-comment"># 可视化</span><br>                <span class="hljs-keyword">if</span> self.visualization:<br>                    self._plot_transformation(data[col].values, transformed_x, col)<br>                <br>                result[col] = transformed_x<br>                <br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 列 <span class="hljs-subst">&#123;col&#125;</span> 转换失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>                <span class="hljs-keyword">continue</span><br>                <br>        <span class="hljs-keyword">return</span> result<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        使用已有参数转换新数据</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - data: DataFrame, 需要转换的数据</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - DataFrame: 转换后的数据</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.lambda_params:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;请先调用fit_transform&quot;</span>)<br>            <br>        result = data.copy()<br>        <br>        <span class="hljs-comment"># 只转换在数据中存在的列</span><br>        columns_to_transform = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> self.transformed_columns <br>                              <span class="hljs-keyword">if</span> col <span class="hljs-keyword">in</span> data.columns]<br>        <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> columns_to_transform:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;警告: 没有需要转换的列&quot;</span>)<br>            <span class="hljs-keyword">return</span> result<br>            <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;对以下列进行转换: <span class="hljs-subst">&#123;columns_to_transform&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns_to_transform:<br>            <span class="hljs-comment"># 应用偏移和转换</span><br>            x = data[col].values + self.shifts[col]<br>            lambda_param = self.lambda_params[col]<br>            <br>            <span class="hljs-keyword">if</span> lambda_param == <span class="hljs-number">0</span>:<br>                result[col] = np.log(x)<br>            <span class="hljs-keyword">else</span>:<br>                result[col] = (np.power(x, lambda_param) - <span class="hljs-number">1</span>) / lambda_param<br>                <br>        <span class="hljs-keyword">return</span> result<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inverse_transform</span>(<span class="hljs-params">self, data, columns=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        逆转换回原始尺度</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - data: DataFrame或array-like, 需要还原的数据</span><br><span class="hljs-string">        - columns: list or str, 需要还原的列名(如果data是DataFrame)</span><br><span class="hljs-string">                  如果data是array-like且未指定columns，默认还原目标变量</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - DataFrame或array: 还原后的数据</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.lambda_params:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;请先调用fit_transform&quot;</span>)<br>            <br>        <span class="hljs-comment"># 处理单列数组数据</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, (pd.Series, <span class="hljs-built_in">list</span>, np.ndarray)):<br>            <span class="hljs-keyword">if</span> columns <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-comment"># 如果未指定列名，默认还原目标变量</span><br>                <span class="hljs-keyword">if</span> self.target_column:<br>                    col = self.target_column<br>                <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(self.transformed_columns) == <span class="hljs-number">1</span>:<br>                    col = self.transformed_columns[<span class="hljs-number">0</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;无法确定要还原的列,请指定columns参数&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                col = columns[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(columns, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">else</span> columns<br>                <br>            x = np.array(data)<br>            <span class="hljs-comment"># 执行逆变换</span><br>            <span class="hljs-keyword">if</span> self.lambda_params[col] == <span class="hljs-number">0</span>:<br>                restored = np.exp(x)<br>            <span class="hljs-keyword">else</span>:<br>                restored = np.power(self.lambda_params[col] * x + <span class="hljs-number">1</span>, <br>                                  <span class="hljs-number">1</span>/self.lambda_params[col])<br>            <span class="hljs-comment"># 还原偏移并处理负值    </span><br>            restored = np.maximum(restored - self.shifts[col], <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> restored<br>                <br>        <span class="hljs-comment"># DataFrame的情况</span><br>        result = data.copy()<br>        columns_to_restore = columns <span class="hljs-keyword">or</span> self.transformed_columns<br>        <br>        <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns_to_restore:<br>            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.lambda_params <span class="hljs-keyword">or</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data.columns:<br>                <span class="hljs-keyword">continue</span><br>                <br>            x = data[col].values<br>            lambda_param = self.lambda_params[col]<br>            <br>            <span class="hljs-keyword">if</span> lambda_param == <span class="hljs-number">0</span>:<br>                result[col] = np.exp(x)<br>            <span class="hljs-keyword">else</span>:<br>                result[col] = np.power(lambda_param * x + <span class="hljs-number">1</span>, <span class="hljs-number">1</span>/lambda_param)<br>                <br>            result[col] = np.maximum(result[col] - self.shifts[col], <span class="hljs-number">0</span>)<br>                <br>        <span class="hljs-keyword">return</span> result<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1. 初始化转换器</span><br>transformer = BoxCoxPipeline(visualization=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 2. 同时转换特征列和目标变量</span><br>train_data = transformer.fit_transform(<br>    data=train_data,<br>    columns=[],  <span class="hljs-comment"># 特征列</span><br>    target_col=<span class="hljs-string">&#x27;count&#x27;</span>            <span class="hljs-comment"># 目标变量</span><br>)<br><br><span class="hljs-comment"># 3. 转换测试集(自动处理不存在的目标变量列)</span><br><span class="hljs-comment">#transformed_submit = transformer.transform(submit_data)</span><br><br><span class="hljs-comment"># 4. 还原预测结果</span><br><span class="hljs-comment"># 不指定列名时默认还原目标变量</span><br><span class="hljs-comment">#restored_predictions = transformer.inverse_transform(stacking_predictions)</span><br></code></pre></td></tr></table></figure><pre><code class="hljs">将进行以下转换:
- 目标变量: count

列 count 转换结果:
- Lambda参数: 0.3157
- 偏移量: 0
- 偏度变化: 1.2419 -&gt; -0.1539</code></pre><figure><img src="/img/EDA-stacking_files/EDA-stacking_97_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><h2 id="特征构造">3.2 特征构造</h2><p>特征组合： 将多个特征进行组合，例如加减乘除、交叉组合等，以创建新的特征。</p><p>多项式特征： 创建原始特征的多项式组合，例如平方、立方等。</p><p>基于业务逻辑的特征： 根据业务逻辑和领域知识，设计新的特征。例如，在电商场景中，可以构建“最近一个月购买次数”等特征。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> LabelEncoder, StandardScaler<br><span class="hljs-keyword">from</span> sklearn.base <span class="hljs-keyword">import</span> BaseEstimator, TransformerMixin<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BikeShareFeatureEngineering</span>(BaseEstimator, TransformerMixin):<br>    <span class="hljs-string">&quot;&quot;&quot;自行车共享系统的特征工程类&quot;&quot;&quot;</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.scaler = StandardScaler()<br>        self.label_encoders = &#123;&#125;<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit</span>(<span class="hljs-params">self, X, y=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-keyword">return</span> self<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self, df</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;转换数据&quot;&quot;&quot;</span><br>        df = df.copy()<br>        <br>        <span class="hljs-comment"># 1. 时间特征处理</span><br>        df = self._create_time_features(df)<br>        <br>        <span class="hljs-comment"># 2. 天气特征处理</span><br>        df = self._process_weather_features(df)<br>        <br>        <span class="hljs-comment"># 3. 温度特征处理</span><br>        df = self._process_temperature_features(df)<br>        <br>        <span class="hljs-comment"># 4. 流量特征处理</span><br>        <span class="hljs-comment">#df = self._create_demand_features(df)</span><br>        <br>        <span class="hljs-comment"># 5. 特征交互</span><br>        df = self._create_interaction_features(df)<br>        <br>        <span class="hljs-comment"># 6. 特征选择</span><br>        df = self._select_features(df)<br>        <br>        <span class="hljs-keyword">return</span> df<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_time_features</span>(<span class="hljs-params">self, df</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;创建时间特征&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 解析datetime</span><br>        df[<span class="hljs-string">&#x27;datetime&#x27;</span>] = pd.to_datetime(df[<span class="hljs-string">&#x27;datetime&#x27;</span>])<br>        <br>        <span class="hljs-comment"># 基础时间特征</span><br>        <span class="hljs-comment">#df[&#x27;year&#x27;] = df[&#x27;datetime&#x27;].dt.year</span><br>        <span class="hljs-comment">#df[&#x27;month&#x27;] = df[&#x27;datetime&#x27;].dt.month</span><br>        <span class="hljs-comment">#df[&#x27;day&#x27;] = df[&#x27;datetime&#x27;].dt.day</span><br>        <span class="hljs-comment">#df[&#x27;hour&#x27;] = df[&#x27;datetime&#x27;].dt.hour</span><br>        df[<span class="hljs-string">&#x27;dayofweek&#x27;</span>] = df[<span class="hljs-string">&#x27;datetime&#x27;</span>].dt.dayofweek<br>        <br>        <span class="hljs-comment"># 周期性编码</span><br>        df[<span class="hljs-string">&#x27;hour_sin&#x27;</span>] = np.sin(<span class="hljs-number">2</span> * np.pi * df[<span class="hljs-string">&#x27;hour&#x27;</span>]/<span class="hljs-number">24</span>)<br>        df[<span class="hljs-string">&#x27;hour_cos&#x27;</span>] = np.cos(<span class="hljs-number">2</span> * np.pi * df[<span class="hljs-string">&#x27;hour&#x27;</span>]/<span class="hljs-number">24</span>)<br>        df[<span class="hljs-string">&#x27;month_sin&#x27;</span>] = np.sin(<span class="hljs-number">2</span> * np.pi * (df[<span class="hljs-string">&#x27;month&#x27;</span>]-<span class="hljs-number">1</span>)/<span class="hljs-number">12</span>)<br>        df[<span class="hljs-string">&#x27;month_cos&#x27;</span>] = np.cos(<span class="hljs-number">2</span> * np.pi * (df[<span class="hljs-string">&#x27;month&#x27;</span>]-<span class="hljs-number">1</span>)/<span class="hljs-number">12</span>)<br>        <br>        <span class="hljs-comment"># 工作日/周末时段</span><br>        df[<span class="hljs-string">&#x27;workday_hour&#x27;</span>] = df[<span class="hljs-string">&#x27;hour&#x27;</span>] * df[<span class="hljs-string">&#x27;workingday&#x27;</span>]<br>        df[<span class="hljs-string">&#x27;weekend_hour&#x27;</span>] = df[<span class="hljs-string">&#x27;hour&#x27;</span>] * (<span class="hljs-number">1</span> - df[<span class="hljs-string">&#x27;workingday&#x27;</span>])<br>        <br>        <span class="hljs-comment"># 通勤高峰时段</span><br>        df[<span class="hljs-string">&#x27;rush_hour&#x27;</span>] = ((df[<span class="hljs-string">&#x27;hour&#x27;</span>].between(<span class="hljs-number">7</span>,<span class="hljs-number">9</span>) | <br>                           df[<span class="hljs-string">&#x27;hour&#x27;</span>].between(<span class="hljs-number">17</span>,<span class="hljs-number">19</span>)) &amp; <br>                          (df[<span class="hljs-string">&#x27;workingday&#x27;</span>] == <span class="hljs-number">1</span>)).astype(<span class="hljs-built_in">int</span>)<br>        <br>        <span class="hljs-keyword">return</span> df<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_process_weather_features</span>(<span class="hljs-params">self, df</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;处理天气特征&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 天气分组</span><br>        df[<span class="hljs-string">&#x27;weather_group&#x27;</span>] = np.where(df[<span class="hljs-string">&#x27;weather&#x27;</span>].isin([<span class="hljs-number">3</span>, <span class="hljs-number">4</span>]), <span class="hljs-string">&#x27;bad&#x27;</span>, <span class="hljs-string">&#x27;good&#x27;</span>)<br>        <br>        <span class="hljs-comment"># 复合天气指数</span><br>        df[<span class="hljs-string">&#x27;weather_index&#x27;</span>] = (<span class="hljs-number">0.6</span> * (df[<span class="hljs-string">&#x27;weather&#x27;</span>]/<span class="hljs-number">4</span>) + <br>                             <span class="hljs-number">0.3</span> * (df[<span class="hljs-string">&#x27;humidity&#x27;</span>]/<span class="hljs-number">100</span>) + <br>                             <span class="hljs-number">0.1</span> * (df[<span class="hljs-string">&#x27;windspeed&#x27;</span>]/<span class="hljs-number">50</span>))<br>        <br>        <span class="hljs-comment"># 极端天气标记</span><br>        df[<span class="hljs-string">&#x27;extreme_weather&#x27;</span>] = (df[<span class="hljs-string">&#x27;weather&#x27;</span>] == <span class="hljs-number">4</span>).astype(<span class="hljs-built_in">int</span>)<br>        <br>        <span class="hljs-comment"># 天气-时段交互</span><br>        df[<span class="hljs-string">&#x27;bad_weather_rush&#x27;</span>] = ((df[<span class="hljs-string">&#x27;weather_group&#x27;</span>] == <span class="hljs-string">&#x27;bad&#x27;</span>) &amp; <br>                                 (df[<span class="hljs-string">&#x27;rush_hour&#x27;</span>] == <span class="hljs-number">1</span>)).astype(<span class="hljs-built_in">int</span>)<br>        <br>        <span class="hljs-keyword">return</span> df<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_process_temperature_features</span>(<span class="hljs-params">self, df</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;处理温度特征&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 保留atemp，删除temp（高度相关）</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;temp&#x27;</span> <span class="hljs-keyword">in</span> df.columns:<br>            df = df.drop(<span class="hljs-string">&#x27;temp&#x27;</span>, axis=<span class="hljs-number">1</span>)<br>        <br>        <span class="hljs-comment"># # 温度分箱</span><br>        <span class="hljs-comment"># df[&#x27;temp_bin&#x27;] = pd.cut(df[&#x27;atemp&#x27;], </span><br>        <span class="hljs-comment">#                        bins=[-np.inf, 0, 15, 25, 35, np.inf],</span><br>        <span class="hljs-comment">#                        labels=[&#x27;very_cold&#x27;, &#x27;cold&#x27;, &#x27;mild&#x27;, &#x27;warm&#x27;, &#x27;hot&#x27;])</span><br>        <br>        <span class="hljs-comment"># 修改温度分箱的边界值，确保所有数据都能被正确分类，测试集中有0，训练集中无0</span><br>        df[<span class="hljs-string">&#x27;temp_bin&#x27;</span>] = pd.cut(df[<span class="hljs-string">&#x27;atemp&#x27;</span>], <br>                           bins=[-np.inf, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, np.inf],<br>                           labels=[<span class="hljs-string">&#x27;cold&#x27;</span>, <span class="hljs-string">&#x27;mild&#x27;</span>, <span class="hljs-string">&#x27;warm&#x27;</span>, <span class="hljs-string">&#x27;hot&#x27;</span>])<br>    <br>        <span class="hljs-comment"># 最适温度区间</span><br>        df[<span class="hljs-string">&#x27;optimal_temp&#x27;</span>] = df[<span class="hljs-string">&#x27;atemp&#x27;</span>].between(<span class="hljs-number">15</span>, <span class="hljs-number">25</span>).astype(<span class="hljs-built_in">int</span>)<br>        <br>        <span class="hljs-comment"># 温度趋势（如果是时序数据）</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(df) &gt; <span class="hljs-number">3</span>:<br>            df[<span class="hljs-string">&#x27;temp_trend&#x27;</span>] = df[<span class="hljs-string">&#x27;atemp&#x27;</span>].rolling(<span class="hljs-number">3</span>).mean()<br>            df[<span class="hljs-string">&#x27;temp_trend&#x27;</span>] = df[<span class="hljs-string">&#x27;temp_trend&#x27;</span>].fillna(method=<span class="hljs-string">&#x27;bfill&#x27;</span>)<br>        <br>        <span class="hljs-keyword">return</span> df<br>    <br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    def _create_demand_features(self, df):</span><br><span class="hljs-string">        &quot;&quot;&quot;创建需求特征&quot;&quot;&quot;</span><br><span class="hljs-string">        if &#x27;count&#x27; in df.columns:  # 只在训练集上创建</span><br><span class="hljs-string">            # 历史需求</span><br><span class="hljs-string">            df[&#x27;last_3h_demand&#x27;] = df[&#x27;count&#x27;].shift(3)</span><br><span class="hljs-string">            df[&#x27;same_hour_last_day&#x27;] = df[&#x27;count&#x27;].shift(24)</span><br><span class="hljs-string">            </span><br><span class="hljs-string">            # 填充缺失值</span><br><span class="hljs-string">            df[&#x27;last_3h_demand&#x27;] = df[&#x27;last_3h_demand&#x27;].fillna(df[&#x27;count&#x27;].mean())</span><br><span class="hljs-string">            df[&#x27;same_hour_last_day&#x27;] = df[&#x27;same_hour_last_day&#x27;].fillna(df[&#x27;count&#x27;].mean())</span><br><span class="hljs-string">            </span><br><span class="hljs-string">            # 需求变化率</span><br><span class="hljs-string">            df[&#x27;demand_change&#x27;] = df[&#x27;count&#x27;].pct_change()</span><br><span class="hljs-string">            df[&#x27;demand_change&#x27;] = df[&#x27;demand_change&#x27;].fillna(0)</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        return df</span><br><span class="hljs-string">     &#x27;&#x27;&#x27;</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_demand_features</span>(<span class="hljs-params">self, df</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;创建需求特征</span><br><span class="hljs-string">        改进说明:</span><br><span class="hljs-string">        1. 特征设计思路:</span><br><span class="hljs-string">        不再使用基于实际需求的滞后特征</span><br><span class="hljs-string">        改用基于统计信息的特征(均值、标准差等)</span><br><span class="hljs-string">        这些统计特征可以在训练集和测试集中保持一致</span><br><span class="hljs-string">        2. 主要特征:</span><br><span class="hljs-string">        时间特征: 每个小时的平均需求和波动</span><br><span class="hljs-string">        天气特征: 不同天气条件下的需求特征</span><br><span class="hljs-string">        工作日特征: 工作日/非工作日的需求特征</span><br><span class="hljs-string">        复合特征: 综合考虑多个因素的期望需求</span><br><span class="hljs-string">        3. 实现机制:</span><br><span class="hljs-string">        在训练集上计算统计值并保存</span><br><span class="hljs-string">        在测试集上使用保存的统计值</span><br><span class="hljs-string">        确保特征的一致性</span><br><span class="hljs-string">        4. 优点:</span><br><span class="hljs-string">        训练集和测试集特征保持一致</span><br><span class="hljs-string">        捕捉了不同条件下的需求模式</span><br><span class="hljs-string">        提供了需求预测的基准信息</span><br><span class="hljs-string">        5. 这种方法更适合实际预测场景，因为它:</span><br><span class="hljs-string">        1. 保证了训练和预测时特征的一致性</span><br><span class="hljs-string">        2. 利用了历史统计信息而不是实时数据</span><br><span class="hljs-string">        3. 考虑了多个影响因素的组合效应</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;datetime&#x27;</span> <span class="hljs-keyword">in</span> df.columns:<br>            <span class="hljs-comment"># 1. 基于时间的特征</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;count&#x27;</span> <span class="hljs-keyword">in</span> df.columns:  <span class="hljs-comment"># 训练集</span><br>                hour_stats = df.groupby(<span class="hljs-string">&#x27;hour&#x27;</span>).agg(&#123;<br>                    <span class="hljs-string">&#x27;count&#x27;</span>: [<span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;std&#x27;</span>]<br>                &#125;).reset_index()<br>                self.hour_means = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(hour_stats[<span class="hljs-string">&#x27;hour&#x27;</span>], hour_stats[<span class="hljs-string">&#x27;count&#x27;</span>][<span class="hljs-string">&#x27;mean&#x27;</span>]))<br>                self.hour_stds = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(hour_stats[<span class="hljs-string">&#x27;hour&#x27;</span>], hour_stats[<span class="hljs-string">&#x27;count&#x27;</span>][<span class="hljs-string">&#x27;std&#x27;</span>]))<br>            <br>            <span class="hljs-comment"># 使用get方法设置默认值，避免KeyError</span><br>            df[<span class="hljs-string">&#x27;hour_avg_demand&#x27;</span>] = df[<span class="hljs-string">&#x27;hour&#x27;</span>].<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: self.hour_means.get(x, <span class="hljs-number">0</span>)) <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;hour_means&#x27;</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>            df[<span class="hljs-string">&#x27;hour_std_demand&#x27;</span>] = df[<span class="hljs-string">&#x27;hour&#x27;</span>].<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: self.hour_stds.get(x, <span class="hljs-number">0</span>)) <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;hour_stds&#x27;</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>            <br>            <span class="hljs-comment"># 2. 基于天气的需求特征</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;count&#x27;</span> <span class="hljs-keyword">in</span> df.columns:  <span class="hljs-comment"># 训练集</span><br>                <span class="hljs-comment"># 先打印天气类型的分布情况</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;训练集天气类型分布：&quot;</span>)<br>                <span class="hljs-built_in">print</span>(df[<span class="hljs-string">&#x27;weather&#x27;</span>].value_counts())<br>                <br>                weather_stats = df.groupby(<span class="hljs-string">&#x27;weather&#x27;</span>).agg(&#123;<br>                    <span class="hljs-string">&#x27;count&#x27;</span>: [<span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;std&#x27;</span>]<br>                &#125;).reset_index()<br>                self.weather_means = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(weather_stats[<span class="hljs-string">&#x27;weather&#x27;</span>], weather_stats[<span class="hljs-string">&#x27;count&#x27;</span>][<span class="hljs-string">&#x27;mean&#x27;</span>]))<br>                self.weather_stds = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(weather_stats[<span class="hljs-string">&#x27;weather&#x27;</span>], weather_stats[<span class="hljs-string">&#x27;count&#x27;</span>][<span class="hljs-string">&#x27;std&#x27;</span>]))<br>            <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 测试集</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;测试集天气类型分布：&quot;</span>)<br>                <span class="hljs-built_in">print</span>(df[<span class="hljs-string">&#x27;weather&#x27;</span>].value_counts())<br>            <br>            <span class="hljs-comment"># 使用get方法设置默认值，对于未见过的天气类型使用所有天气类型的平均值</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;weather_means&#x27;</span>):<br>                default_mean = np.mean(<span class="hljs-built_in">list</span>(self.weather_means.values()))<br>                default_std = np.mean(<span class="hljs-built_in">list</span>(self.weather_stds.values()))<br>                df[<span class="hljs-string">&#x27;weather_avg_demand&#x27;</span>] = df[<span class="hljs-string">&#x27;weather&#x27;</span>].<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: self.weather_means.get(x, default_mean))<br>                df[<span class="hljs-string">&#x27;weather_std_demand&#x27;</span>] = df[<span class="hljs-string">&#x27;weather&#x27;</span>].<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: self.weather_stds.get(x, default_std))<br>            <span class="hljs-keyword">else</span>:<br>                df[<span class="hljs-string">&#x27;weather_avg_demand&#x27;</span>] = <span class="hljs-number">0</span><br>                df[<span class="hljs-string">&#x27;weather_std_demand&#x27;</span>] = <span class="hljs-number">0</span><br>            <br>            <span class="hljs-comment"># 3. 基于工作日的需求特征</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;count&#x27;</span> <span class="hljs-keyword">in</span> df.columns:  <span class="hljs-comment"># 训练集</span><br>                workingday_stats = df.groupby(<span class="hljs-string">&#x27;workingday&#x27;</span>).agg(&#123;<br>                    <span class="hljs-string">&#x27;count&#x27;</span>: [<span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;std&#x27;</span>]<br>                &#125;).reset_index()<br>                self.workingday_means = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(workingday_stats[<span class="hljs-string">&#x27;workingday&#x27;</span>], workingday_stats[<span class="hljs-string">&#x27;count&#x27;</span>][<span class="hljs-string">&#x27;mean&#x27;</span>]))<br>                self.workingday_stds = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(workingday_stats[<span class="hljs-string">&#x27;workingday&#x27;</span>], workingday_stats[<span class="hljs-string">&#x27;count&#x27;</span>][<span class="hljs-string">&#x27;std&#x27;</span>]))<br>            <br>            <span class="hljs-comment"># 使用get方法设置默认值</span><br>            df[<span class="hljs-string">&#x27;workingday_avg_demand&#x27;</span>] = df[<span class="hljs-string">&#x27;workingday&#x27;</span>].<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: self.workingday_means.get(x, <span class="hljs-number">0</span>)) <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;workingday_means&#x27;</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>            df[<span class="hljs-string">&#x27;workingday_std_demand&#x27;</span>] = df[<span class="hljs-string">&#x27;workingday&#x27;</span>].<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: self.workingday_stds.get(x, <span class="hljs-number">0</span>)) <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;workingday_stds&#x27;</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>            <br>            <span class="hljs-comment"># 4. 复合特征</span><br>            df[<span class="hljs-string">&#x27;expected_demand&#x27;</span>] = (<br>                df[<span class="hljs-string">&#x27;hour_avg_demand&#x27;</span>] * <span class="hljs-number">0.5</span> + <br>                df[<span class="hljs-string">&#x27;weather_avg_demand&#x27;</span>] * <span class="hljs-number">0.3</span> + <br>                df[<span class="hljs-string">&#x27;workingday_avg_demand&#x27;</span>] * <span class="hljs-number">0.2</span><br>            )<br>            <br>            df[<span class="hljs-string">&#x27;demand_volatility&#x27;</span>] = (<br>                df[<span class="hljs-string">&#x27;hour_std_demand&#x27;</span>] * <span class="hljs-number">0.5</span> + <br>                df[<span class="hljs-string">&#x27;weather_std_demand&#x27;</span>] * <span class="hljs-number">0.3</span> + <br>                df[<span class="hljs-string">&#x27;workingday_std_demand&#x27;</span>] * <span class="hljs-number">0.2</span><br>            )<br>            <br>            <span class="hljs-comment"># 5. 验证没有NaN值</span><br>            nan_cols = df.columns[df.isna().<span class="hljs-built_in">any</span>()].tolist()<br>            <span class="hljs-keyword">if</span> nan_cols:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;警告：以下列存在NaN值：&quot;</span>, nan_cols)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;NaN值数量：&quot;</span>)<br>                <span class="hljs-built_in">print</span>(df[nan_cols].isna().<span class="hljs-built_in">sum</span>())<br>        <br>        <span class="hljs-keyword">return</span> df<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_interaction_features</span>(<span class="hljs-params">self, df</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;创建交互特征&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 温度-时段交互</span><br>        df[<span class="hljs-string">&#x27;warm_rush&#x27;</span>] = ((df[<span class="hljs-string">&#x27;temp_bin&#x27;</span>].isin([<span class="hljs-string">&#x27;mild&#x27;</span>, <span class="hljs-string">&#x27;warm&#x27;</span>])) &amp; <br>                          (df[<span class="hljs-string">&#x27;rush_hour&#x27;</span>] == <span class="hljs-number">1</span>)).astype(<span class="hljs-built_in">int</span>)<br>        <br>        <span class="hljs-comment"># 天气-周末交互</span><br>        df[<span class="hljs-string">&#x27;good_weather_weekend&#x27;</span>] = ((df[<span class="hljs-string">&#x27;weather_group&#x27;</span>] == <span class="hljs-string">&#x27;good&#x27;</span>) &amp; <br>                                    (df[<span class="hljs-string">&#x27;workingday&#x27;</span>] == <span class="hljs-number">0</span>)).astype(<span class="hljs-built_in">int</span>)<br>        <br>        <span class="hljs-comment"># 季节-时段交互</span><br>        df[<span class="hljs-string">&#x27;summer_evening&#x27;</span>] = ((df[<span class="hljs-string">&#x27;season&#x27;</span>] == <span class="hljs-number">2</span>) &amp; <br>                              (df[<span class="hljs-string">&#x27;hour&#x27;</span>].between(<span class="hljs-number">17</span>, <span class="hljs-number">20</span>))).astype(<span class="hljs-built_in">int</span>)<br>        <br>        <span class="hljs-keyword">return</span> df<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_select_features</span>(<span class="hljs-params">self, df</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;特征选择&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 删除不需要的特征</span><br>        drops = [<span class="hljs-string">&#x27;datetime&#x27;</span>, <span class="hljs-string">&#x27;date&#x27;</span>,<span class="hljs-string">&#x27;casual&#x27;</span>, <span class="hljs-string">&#x27;registered&#x27;</span>, <span class="hljs-string">&#x27;holiday&#x27;</span>, <br>                <span class="hljs-string">&#x27;is_month_start&#x27;</span>, <span class="hljs-string">&#x27;is_month_end&#x27;</span>]<br>        <br>        <span class="hljs-comment"># 只删除存在的列</span><br>        drops = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> drops <span class="hljs-keyword">if</span> col <span class="hljs-keyword">in</span> df.columns]<br>        df = df.drop(drops, axis=<span class="hljs-number">1</span>)<br>        <br>        <span class="hljs-comment"># 类别特征编码</span><br>        cat_features = [<span class="hljs-string">&#x27;weather&#x27;</span>,<span class="hljs-string">&#x27;weather_group&#x27;</span>, <span class="hljs-string">&#x27;temp_bin&#x27;</span>, <span class="hljs-string">&#x27;season&#x27;</span>]<br>        <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> cat_features:<br>            <span class="hljs-keyword">if</span> feature <span class="hljs-keyword">in</span> df.columns:<br>                <span class="hljs-keyword">if</span> feature <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.label_encoders:<br>                    self.label_encoders[feature] = LabelEncoder()<br>                    df[feature] = self.label_encoders[feature].fit_transform(df[feature])<br>                <span class="hljs-keyword">else</span>:<br>                    df[feature] = self.label_encoders[feature].transform(df[feature])<br>        <br>        <span class="hljs-keyword">return</span> df<br><br><span class="hljs-comment"># 使用示例</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_features</span>(<span class="hljs-params">train_data, test_data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;准备特征&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 初始化特征工程类</span><br>    feature_engineering = BikeShareFeatureEngineering()<br>    <br>    <span class="hljs-comment"># 转换训练集和测试集</span><br>    train_features = feature_engineering.transform(train_data)<br>    test_features = feature_engineering.transform(test_data)<br>    <br>    <span class="hljs-keyword">return</span> train_features, test_features<br><br><br><br><br><br><span class="hljs-comment">## 使用示例</span><br><span class="hljs-comment"># 读取数据</span><br><br><br><span class="hljs-comment"># 特征工程</span><br>train_data, submit_data = prepare_features(train_data, submit_data)<br><br><br><br><span class="hljs-comment"># 查看结果</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;训练集特征:&quot;</span>, train_data.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;测试集特征:&quot;</span>, submit_data.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n特征列表:&quot;</span>, train_data.columns.tolist())<br><br></code></pre></td></tr></table></figure><pre><code class="hljs">训练集特征: (10886, 33)
测试集特征: (6493, 32)

特征列表: [&#39;season&#39;, &#39;workingday&#39;, &#39;weather&#39;, &#39;atemp&#39;, &#39;humidity&#39;, &#39;windspeed&#39;, &#39;count&#39;, &#39;year&#39;, &#39;month&#39;, &#39;day&#39;, &#39;hour&#39;, &#39;minute&#39;, &#39;weekday&#39;, &#39;quarter&#39;, &#39;is_weekend&#39;, &#39;dayofweek&#39;, &#39;hour_sin&#39;, &#39;hour_cos&#39;, &#39;month_sin&#39;, &#39;month_cos&#39;, &#39;workday_hour&#39;, &#39;weekend_hour&#39;, &#39;rush_hour&#39;, &#39;weather_group&#39;, &#39;weather_index&#39;, &#39;extreme_weather&#39;, &#39;bad_weather_rush&#39;, &#39;temp_bin&#39;, &#39;optimal_temp&#39;, &#39;temp_trend&#39;, &#39;warm_rush&#39;, &#39;good_weather_weekend&#39;, &#39;summer_evening&#39;]</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_data.info()<br></code></pre></td></tr></table></figure><pre><code class="hljs">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 10886 entries, 0 to 10885
Data columns (total 33 columns):
 #   Column                Non-Null Count  Dtype  
---  ------                --------------  -----  
 0   season                10886 non-null  int64  
 1   workingday            10886 non-null  int64  
 2   weather               10886 non-null  int64  
 3   atemp                 10886 non-null  float64
 4   humidity              10886 non-null  int64  
 5   windspeed             10886 non-null  float64
 6   count                 10886 non-null  float64
 7   year                  10886 non-null  int32  
 8   month                 10886 non-null  int32  
 9   day                   10886 non-null  int32  
 10  hour                  10886 non-null  int32  
 11  minute                10886 non-null  int32  
 12  weekday               10886 non-null  int32  
 13  quarter               10886 non-null  int32  
 14  is_weekend            10886 non-null  int32  
 15  dayofweek             10886 non-null  int64  
 16  hour_sin              10886 non-null  float64
 17  hour_cos              10886 non-null  float64
 18  month_sin             10886 non-null  float64
 19  month_cos             10886 non-null  float64
 20  workday_hour          10886 non-null  int64  
 21  weekend_hour          10886 non-null  int64  
 22  rush_hour             10886 non-null  int32  
 23  weather_group         10886 non-null  int32  
 24  weather_index         10886 non-null  float64
 25  extreme_weather       10886 non-null  int32  
 26  bad_weather_rush      10886 non-null  int32  
 27  temp_bin              10886 non-null  int32  
 28  optimal_temp          10886 non-null  int32  
 29  temp_trend            10886 non-null  float64
 30  warm_rush             10886 non-null  int32  
 31  good_weather_weekend  10886 non-null  int32  
 32  summer_evening        10886 non-null  int32  
dtypes: float64(9), int32(17), int64(7)
memory usage: 2.0 MB</code></pre><h2 id="特征选择">3.3 特征选择</h2><blockquote><p>根据热力图和多重共线性分析选择特征</p></blockquote><p>过滤法 (Filter)： 根据特征的统计指标（例如方差、相关系数、互信息等）进行特征选择，与模型无关。</p><p>包裹法 (Wrapper)： 将特征选择视为一个搜索问题，使用模型性能作为评价指标，例如递归特征消除 (RFE)。</p><p>嵌入法 (Embedded)： 将特征选择嵌入到模型训练过程中，例如 Lasso 回归、决策树等。 基于树模型的特征重要性： 使用随机森林或 XGBoost 等树模型，根据特征在模型中的重要性进行选择。</p><p>目标： 选择对目标变量最有预测能力的特征，减少特征数量，降低模型复杂度，防止过拟合，提高模型性能和训练速度。</p><p>先归一化、编码在选择特征，还是反之：</p><p>一般情况： 通常推荐 先选择特征，再归一化和编码 的方法。 这样可以显著减少计算量，并避免对无用特征进行不必要的操作，提高效率。 对于大多数问题，这种方法在效率和性能之间取得了较好的平衡。 特殊情况： 如果你的特征集不大，或者你认为特征之间的相互作用非常重要，可以考虑 先归一化和编码，再选择特征。 在使用某些依赖距离度量的特征选择方法（如基于 KNN 的方法）时，可能需要先对特征进行归一化。 在使用某些模型时，例如 SVM，特征的缩放非常重要，应该先进行归一化。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 选择特征</span><br><span class="hljs-comment"># train_features_to_keep=[&#x27;season&#x27;,&#x27;holiday&#x27;,&#x27;workingday&#x27;,&#x27;weather&#x27;,&#x27;temp&#x27;,&#x27;humidity&#x27;,&#x27;windspeed&#x27;,&#x27;count&#x27;,&#x27;year&#x27;,&#x27;month&#x27;,&#x27;day&#x27;,&#x27;hour&#x27;,&#x27;weekday&#x27;]</span><br><span class="hljs-comment"># train_data=train_data[train_features_to_keep]</span><br><span class="hljs-comment"># submit_features_to_keep=[&#x27;season&#x27;,&#x27;holiday&#x27;,&#x27;workingday&#x27;,&#x27;weather&#x27;,&#x27;temp&#x27;,&#x27;humidity&#x27;,&#x27;windspeed&#x27;,&#x27;year&#x27;,&#x27;month&#x27;,&#x27;day&#x27;,&#x27;hour&#x27;,&#x27;weekday&#x27;]</span><br><span class="hljs-comment"># submit_data=submit_data[submit_features_to_keep]</span><br><br></code></pre></td></tr></table></figure><h2 id="特征提取">3.4 特征提取</h2><p>领域知识： 利用领域知识，从原始数据中提取有意义的特征。例如，在自然语言处理中，可以提取文本长度、词频等特征；在图像处理中，可以提取颜色直方图、纹理特征等。</p><p>自动特征提取： 使用自动化的方法提取特征，例如主成分分析 (PCA)、独立成分分析 (ICA)、线性判别分析 (LDA) 等降维技术，以及深度学习方法（如自编码器）来学习数据的低维表示。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><br></code></pre></td></tr></table></figure><h2 id="数据变换-数据规范化">数据变换-数据规范化</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NormalizationPipeline</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    归一化处理通用流程</span><br><span class="hljs-string">    1. 支持对不同列使用不同的归一化方法</span><br><span class="hljs-string">    2. 对目标变量以外的特征进行合并归一化，目标变量仅使用训练集归一化</span><br><span class="hljs-string">    3. 根据原始列名选择对应的还原方法还原数据</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.scalers = &#123;&#125;  <span class="hljs-comment"># 存储每个列的归一化器</span><br>        self.normalized_columns = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 记录已归一化的列</span><br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_check_data_characteristics</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                    data[&#x27;train&#x27;][feature_cols], </span><br><span class="hljs-string">                    data[&#x27;test&#x27;][feature_cols]</span><br><span class="hljs-string">                ])</span><br><span class="hljs-string">            </span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - str: 建议使用的归一化方法名称</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 转换为numpy数组进行统计分析</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, pd.DataFrame):<br>            X = data.values<br>        <span class="hljs-keyword">else</span>:<br>            X = data<br>            <br>        <span class="hljs-comment"># 1. 检查是否存在异常值</span><br>        z_scores = np.<span class="hljs-built_in">abs</span>((X - np.mean(X, axis=<span class="hljs-number">0</span>)) / np.std(X, axis=<span class="hljs-number">0</span>))<br>        has_outliers = np.<span class="hljs-built_in">any</span>(z_scores &gt; <span class="hljs-number">3</span>)<br>        <br>        <span class="hljs-comment"># 2. 检查数据分布是否接近正态</span><br>        <span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats<br>        _, p_value = stats.normaltest(X.flatten())<br>        is_normal = p_value &gt; <span class="hljs-number">0.05</span><br>        <br>        <span class="hljs-comment"># 3. 检查是否为稀疏矩阵</span><br>        sparsity = <span class="hljs-number">1.0</span> - (np.count_nonzero(X) / <span class="hljs-built_in">float</span>(X.size))<br>        is_sparse = sparsity &gt; <span class="hljs-number">0.5</span><br>        <br>        <span class="hljs-comment"># 根据特征选择归一化方法</span><br>        <span class="hljs-keyword">if</span> has_outliers:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;robust&#x27;</span> <span class="hljs-comment"># 基于四分位数（IQR）的范围</span><br>        <span class="hljs-keyword">elif</span> is_normal:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;standard&#x27;</span> <span class="hljs-comment"># 均值为 0，标准差为 1的范围</span><br>        <span class="hljs-keyword">elif</span> is_sparse:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;maxabs&#x27;</span> <span class="hljs-comment"># [-1, 1]</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;minmax&#x27;</span> <span class="hljs-comment"># [0,1]</span><br>            <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_scaler</span>(<span class="hljs-params">self, method</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;根据方法名获取对应的归一化器&quot;&quot;&quot;</span><br>        scalers = &#123;<br>            <span class="hljs-string">&#x27;minmax&#x27;</span>: MinMaxScaler(),<br>            <span class="hljs-string">&#x27;standard&#x27;</span>: StandardScaler(),<br>            <span class="hljs-string">&#x27;robust&#x27;</span>: RobustScaler(),<br>            <span class="hljs-string">&#x27;maxabs&#x27;</span>: MaxAbsScaler()<br>        &#125;<br>        <span class="hljs-keyword">return</span> scalers.get(method, MinMaxScaler())<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fit_transform</span>(<span class="hljs-params">self, data, method=<span class="hljs-literal">None</span>, combined=<span class="hljs-literal">True</span>, columns=<span class="hljs-literal">None</span>, target_col=<span class="hljs-string">&#x27;count&#x27;</span></span>):   <br><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        拟合并转换数据</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - data: DataFrame或dict, 输入数据</span><br><span class="hljs-string">        - method: str, 归一化方法，默认为None(自动选择)</span><br><span class="hljs-string">        - combined: bool, 是否采用合并归一化，默认为True</span><br><span class="hljs-string">        - columns: list, 指定需要归一化的列，默认为None(所有数值列)</span><br><span class="hljs-string">        - target_col: str, 目标变量列名，默认为&#x27;count&#x27;</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - DataFrame或dict: 归一化后的数据</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        <span class="hljs-keyword">if</span> combined:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">dict</span>):<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;combined=True时,data应为包含train和test的字典&quot;</span>)<br>        <br>            <span class="hljs-comment"># 分离目标变量和特征列</span><br>            feature_cols = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns <span class="hljs-keyword">if</span> col != target_col]<br>        <br>            <span class="hljs-comment"># 初始化结果字典</span><br>            normalized_data = &#123;<span class="hljs-string">&#x27;train&#x27;</span>: data[<span class="hljs-string">&#x27;train&#x27;</span>].copy(), <span class="hljs-string">&#x27;test&#x27;</span>: data[<span class="hljs-string">&#x27;test&#x27;</span>].copy()&#125;<br>        <br>            <span class="hljs-comment"># 1. 对特征列进行合并归一化</span><br>            <span class="hljs-keyword">if</span> feature_cols:<br>                <span class="hljs-comment"># 合并特征数据</span><br>                combined_features = pd.concat([<br>                    data[<span class="hljs-string">&#x27;train&#x27;</span>][feature_cols], <br>                    data[<span class="hljs-string">&#x27;test&#x27;</span>][feature_cols]<br>                ])<br>            <br>                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> feature_cols:<br>                    <span class="hljs-keyword">if</span> method <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                        col_method = self._check_data_characteristics(combined_features[[col]])<br>                    <span class="hljs-keyword">else</span>:<br>                        col_method = method<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;特征列 <span class="hljs-subst">&#123;col&#125;</span> 使用 <span class="hljs-subst">&#123;col_method&#125;</span> 归一化方法&quot;</span>)<br>                <br>                    self.scalers[col] = self._get_scaler(col_method)<br>                    normalized_values = self.scalers[col].fit_transform(<br>                        combined_features[[col]]<br>                    ).ravel()<br>                <br>                    <span class="hljs-comment"># 分别更新训练集和测试集</span><br>                    normalized_data[<span class="hljs-string">&#x27;train&#x27;</span>][col] = normalized_values[:<span class="hljs-built_in">len</span>(data[<span class="hljs-string">&#x27;train&#x27;</span>])]<br>                    normalized_data[<span class="hljs-string">&#x27;test&#x27;</span>][col] = normalized_values[<span class="hljs-built_in">len</span>(data[<span class="hljs-string">&#x27;train&#x27;</span>]):]<br>        <br>        <span class="hljs-comment"># 2. 单独处理目标变量(仅在训练集上)</span><br>            <span class="hljs-keyword">if</span> target_col <span class="hljs-keyword">in</span> columns:<br>                target_method = method <span class="hljs-keyword">or</span> self._check_data_characteristics(<br>                    data[<span class="hljs-string">&#x27;train&#x27;</span>][[target_col]]<br>                )<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;目标变量 <span class="hljs-subst">&#123;target_col&#125;</span> 使用 <span class="hljs-subst">&#123;target_method&#125;</span> 归一化方法&quot;</span>)<br>            <br>                self.scalers[target_col] = self._get_scaler(target_method)<br>                normalized_data[<span class="hljs-string">&#x27;train&#x27;</span>][target_col] = self.scalers[target_col].fit_transform(<br>                    data[<span class="hljs-string">&#x27;train&#x27;</span>][[target_col]]<br>                ).ravel()<br>        <br>            <span class="hljs-keyword">return</span> normalized_data<br>    <br>          <br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 分开归一化</span><br>            self.normalized_columns = self._get_columns_to_normalize(<br>                data, columns<br>            )<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;将对以下列进行归一化: <span class="hljs-subst">&#123;self.normalized_columns&#125;</span>&quot;</span>)<br>            <br>            normalized_data = data.copy()<br>            <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> self.normalized_columns:<br>                <span class="hljs-keyword">if</span> method <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    col_method = self._check_data_characteristics(<br>                        data[[col]]<br>                    )<br>                <span class="hljs-keyword">else</span>:<br>                    col_method = method<br>                    <br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;列 <span class="hljs-subst">&#123;col&#125;</span> 使用 <span class="hljs-subst">&#123;col_method&#125;</span> 归一化方法&quot;</span>)<br>                <br>                self.scalers[col] = self._get_scaler(col_method)<br>                normalized_data[col] = self.scalers[col].fit_transform(<br>                    data[[col]]<br>                ).ravel()<br>            <br>            <span class="hljs-keyword">return</span> normalized_data<br>            <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;使用已拟合的归一化器转换新数据&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.scalers:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;请先调用fit_transform&quot;</span>)<br>            <br>        normalized_data = data.copy()<br>        <span class="hljs-keyword">for</span> col, scaler <span class="hljs-keyword">in</span> self.scalers.items():<br>            <span class="hljs-keyword">if</span> col <span class="hljs-keyword">in</span> data.columns:<br>                normalized_data[col] = scaler.transform(<br>                    data[[col]]<br>                ).ravel()<br>        <span class="hljs-keyword">return</span> normalized_data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">restore_predictions</span>(<span class="hljs-params">self, predictions, source_column=<span class="hljs-string">&#x27;count&#x27;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        还原预测结果到原始尺度</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - predictions: array或DataFrame, 归一化尺度的预测结果</span><br><span class="hljs-string">        - source_column: str, 对应的原始列名，默认为&#x27;count&#x27;</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - array: 原始尺度的预测结果</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.scalers <span class="hljs-keyword">or</span> source_column <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.scalers:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;没有找到列 <span class="hljs-subst">&#123;source_column&#125;</span> 的归一化器&quot;</span>)<br>            <br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 转换输入格式为二维数组</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(predictions, (pd.Series, <span class="hljs-built_in">list</span>, np.ndarray)):<br>                predictions = np.array(predictions).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(predictions, pd.DataFrame):<br>                predictions = predictions.values.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>                <br>            <span class="hljs-comment"># 使用对应列的归一化器进行还原</span><br>            restored_values = self.scalers[source_column].inverse_transform(predictions).ravel()<br>            <br>            <span class="hljs-comment"># 处理负值</span><br>            restored_values = np.maximum(restored_values, <span class="hljs-number">0</span>)<br>            <br>            <span class="hljs-keyword">return</span> restored_values<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;还原预测结果时出错: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><span class="hljs-comment"># 使用示例：</span><br><br><span class="hljs-comment"># 1. 初始化归一化器</span><br>normalizer = NormalizationPipeline()<br><br><span class="hljs-comment"># 2. 对数据进行归一化</span><br>normalized_data = normalizer.fit_transform(<br>    data=&#123;<span class="hljs-string">&#x27;train&#x27;</span>: train_data, <span class="hljs-string">&#x27;test&#x27;</span>: submit_data&#125;,<br>    columns=[<span class="hljs-string">&#x27;count&#x27;</span>],  <span class="hljs-comment"># 指定所有需要归一化的列，若归一化目标变量则需要包含</span><br>    target_col=<span class="hljs-string">&#x27;count&#x27;</span>,  <span class="hljs-comment"># 指定目标变量</span><br>    <span class="hljs-comment">#method=&#x27;minmax&#x27;,</span><br>    combined=<span class="hljs-literal">True</span><br>)<br><br><span class="hljs-comment"># 3. 获取归一化后的数据</span><br>train_data = normalized_data[<span class="hljs-string">&#x27;train&#x27;</span>]<br>submit_data = normalized_data[<span class="hljs-string">&#x27;test&#x27;</span>]<br><br><span class="hljs-comment"># 4. 训练模型并预测</span><br><span class="hljs-comment">#predictions = pipeline.predict(submit_data_normalized)</span><br><br><span class="hljs-comment"># 5. 还原预测结果</span><br><span class="hljs-comment">#restored_predictions = normalizer.restore_predictions(predictions, source_column=&#x27;count&#x27;)</span><br><br><span class="hljs-comment"># 6. 保存结果</span><br><span class="hljs-comment"># submission = pd.DataFrame(&#123;</span><br><span class="hljs-comment">#     &#x27;datetime&#x27;: submit_data.index,</span><br><span class="hljs-comment">#     &#x27;count&#x27;: restored_predictions</span><br><span class="hljs-comment"># &#125;)</span><br><span class="hljs-comment"># submission.to_csv(&#x27;submission.csv&#x27;, index=False)</span><br><br></code></pre></td></tr></table></figure><pre><code class="hljs">目标变量 count 使用 minmax 归一化方法</code></pre><h2 id="数据变换--离散变量编码">数据变换- 离散变量编码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string"># 强制转换为类别类型</span><br><span class="hljs-string">from sklearn.preprocessing import LabelEncoder</span><br><span class="hljs-string">def convert_to_category(data, category_columns=None):</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><span class="hljs-string">    将指定列转换为分类(category)类型</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: DataFrame, 输入数据</span><br><span class="hljs-string">    - category_columns: list, 需要转换的列名列表</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    返回:</span><br><span class="hljs-string">    - DataFrame: 转换后的数据框</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><span class="hljs-string">    if category_columns is None:</span><br><span class="hljs-string">        print(&quot;category_columns is none&quot;)</span><br><span class="hljs-string">        return</span><br><span class="hljs-string">        </span><br><span class="hljs-string">    df = data.copy()</span><br><span class="hljs-string">    for col in category_columns:</span><br><span class="hljs-string">        if col in df.columns:</span><br><span class="hljs-string">            df[col] = df[col].astype(&quot;category&quot;)</span><br><span class="hljs-string">        else:</span><br><span class="hljs-string">            print(f&quot;警告: 列 &#123;col&#125; 不存在于数据中&quot;)</span><br><span class="hljs-string">        </span><br><span class="hljs-string">    return df</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 转换数据类型</span><br><span class="hljs-string">#train_data = convert_to_category(train_data,</span><br><span class="hljs-string">#                                 category_columns=[&quot;season&quot;,&quot;holiday&quot;,&quot;workingday&quot;,&quot;weather&quot;,&quot;weekday&quot;,&quot;month&quot;,&quot;year&quot;,&quot;hour&quot;])</span><br><span class="hljs-string"></span><br><span class="hljs-string">## 分类特征编码</span><br><span class="hljs-string">class CategoryEncoder:</span><br><span class="hljs-string">    &quot;&quot;&quot;分类特征编码器&quot;&quot;&quot;</span><br><span class="hljs-string">    def __init__(self):</span><br><span class="hljs-string">        self.label_encoders = &#123;&#125;  # 存储每个特征的LabelEncoder</span><br><span class="hljs-string">        self.feature_columns = &#123;&#125;  # 存储One-Hot编码后的列名</span><br><span class="hljs-string"></span><br><span class="hljs-string">    def fit_transform(self, data, ordinal_features=None, nominal_features=None):</span><br><span class="hljs-string">        &quot;&quot;&quot;拟合并转换训练数据&quot;&quot;&quot;</span><br><span class="hljs-string">        df = data.copy()</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        # 1. 处理有序特征(Label Encoding)</span><br><span class="hljs-string">        if ordinal_features:</span><br><span class="hljs-string">            for col in ordinal_features:</span><br><span class="hljs-string">                if col in df.columns:</span><br><span class="hljs-string">                    le = LabelEncoder()</span><br><span class="hljs-string">                    df[col] = le.fit_transform(df[col].astype(str))</span><br><span class="hljs-string">                    self.label_encoders[col] = le</span><br><span class="hljs-string">                else:</span><br><span class="hljs-string">                    print(f&quot;警告: 列 &#123;col&#125; 不存在于数据中&quot;)</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        # 2. 处理无序特征(One-Hot Encoding)</span><br><span class="hljs-string">        if nominal_features:</span><br><span class="hljs-string">            df = pd.get_dummies(df, </span><br><span class="hljs-string">                              columns=nominal_features,</span><br><span class="hljs-string">                              prefix=nominal_features)</span><br><span class="hljs-string">            # 保存生成的One-Hot列名</span><br><span class="hljs-string">            for col in nominal_features:</span><br><span class="hljs-string">                self.feature_columns[col] = [c for c in df.columns if c.startswith(f&quot;&#123;col&#125;_&quot;)]</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        return df</span><br><span class="hljs-string"></span><br><span class="hljs-string">    def transform(self, data):</span><br><span class="hljs-string">        &quot;&quot;&quot;转换测试数据&quot;&quot;&quot;</span><br><span class="hljs-string">        df = data.copy()</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        # 1. 使用已拟合的LabelEncoder转换有序特征</span><br><span class="hljs-string">        for col, le in self.label_encoders.items():</span><br><span class="hljs-string">            if col in df.columns:</span><br><span class="hljs-string">                # 处理测试集中的未知类别</span><br><span class="hljs-string">                df[col] = df[col].astype(str)</span><br><span class="hljs-string">                for val in df[col].unique():</span><br><span class="hljs-string">                    if val not in le.classes_:</span><br><span class="hljs-string">                        print(f&quot;警告: 特征 &#123;col&#125; 中发现新类别 &#123;val&#125;，将其替换为最频繁类别&quot;)</span><br><span class="hljs-string">                df[col] = df[col].map(lambda x: x if x in le.classes_ else le.classes_[0])</span><br><span class="hljs-string">                df[col] = le.transform(df[col])</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        # 2. 处理无序特征的One-Hot编码</span><br><span class="hljs-string">        for col, columns in self.feature_columns.items():</span><br><span class="hljs-string">            if col in df.columns:</span><br><span class="hljs-string">                # 创建One-Hot编码</span><br><span class="hljs-string">                temp_df = pd.get_dummies(df[col], prefix=col)</span><br><span class="hljs-string">                # 确保所有训练集中的列都存在</span><br><span class="hljs-string">                for column in columns:</span><br><span class="hljs-string">                    if column not in temp_df.columns:</span><br><span class="hljs-string">                        temp_df[column] = 0</span><br><span class="hljs-string">                # 删除多余的列</span><br><span class="hljs-string">                temp_df = temp_df[columns]</span><br><span class="hljs-string">                # 替换原始列</span><br><span class="hljs-string">                df = df.drop(col, axis=1)</span><br><span class="hljs-string">                df = pd.concat([df, temp_df], axis=1)</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        return df</span><br><span class="hljs-string"></span><br><span class="hljs-string"># # 1. 先转换为category类型（如果需要）</span><br><span class="hljs-string"># train_data = convert_to_category(</span><br><span class="hljs-string">#     train_data,</span><br><span class="hljs-string">#     category_columns=[&quot;season&quot;, &quot;holiday&quot;, &quot;weather&quot;]</span><br><span class="hljs-string"># )</span><br><span class="hljs-string"># submit_data = convert_to_category(</span><br><span class="hljs-string">#     submit_data,</span><br><span class="hljs-string">#     category_columns=[&quot;season&quot;, &quot;holiday&quot;, &quot;weather&quot;]</span><br><span class="hljs-string"># )</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 2. 使用编码器进行特征编码</span><br><span class="hljs-string">encoder = CategoryEncoder()</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 拟合并转换训练集</span><br><span class="hljs-string">train_data = encoder.fit_transform(</span><br><span class="hljs-string">    train_data,</span><br><span class="hljs-string">    ordinal_features=[&#x27;season&#x27;],</span><br><span class="hljs-string">    nominal_features=[&#x27;weather&#x27;, &#x27;holiday&#x27;]</span><br><span class="hljs-string">)</span><br><span class="hljs-string"></span><br><span class="hljs-string"># 使用相同的编码器转换测试集</span><br><span class="hljs-string">submit_data = encoder.transform(submit_data)</span><br><span class="hljs-string"> &#x27;&#x27;&#x27;</span><br><br></code></pre></td></tr></table></figure><pre><code class="hljs">&#39;\n# 强制转换为类别类型\nfrom sklearn.preprocessing import LabelEncoder\ndef convert_to_category(data, category_columns=None):\n    &quot;&quot;&quot;\n    将指定列转换为分类(category)类型\n    \n    参数:\n    - data: DataFrame, 输入数据\n    - category_columns: list, 需要转换的列名列表\n    \n    返回:\n    - DataFrame: 转换后的数据框\n    &quot;&quot;&quot;\n    if category_columns is None:\n        print(&quot;category_columns is none&quot;)\n        return\n        \n    df = data.copy()\n    for col in category_columns:\n        if col in df.columns:\n            df[col] = df[col].astype(&quot;category&quot;)\n        else:\n            print(f&quot;警告: 列 &#123;col&#125; 不存在于数据中&quot;)\n        \n    return df\n\n# 转换数据类型\n#train_data = convert_to_category(train_data,\n#                                 category_columns=[&quot;season&quot;,&quot;holiday&quot;,&quot;workingday&quot;,&quot;weather&quot;,&quot;weekday&quot;,&quot;month&quot;,&quot;year&quot;,&quot;hour&quot;])\n\n## 分类特征编码\nclass CategoryEncoder:\n    &quot;&quot;&quot;分类特征编码器&quot;&quot;&quot;\n    def __init__(self):\n        self.label_encoders = &#123;&#125;  # 存储每个特征的LabelEncoder\n        self.feature_columns = &#123;&#125;  # 存储One-Hot编码后的列名\n\n    def fit_transform(self, data, ordinal_features=None, nominal_features=None):\n        &quot;&quot;&quot;拟合并转换训练数据&quot;&quot;&quot;\n        df = data.copy()\n        \n        # 1. 处理有序特征(Label Encoding)\n        if ordinal_features:\n            for col in ordinal_features:\n                if col in df.columns:\n                    le = LabelEncoder()\n                    df[col] = le.fit_transform(df[col].astype(str))\n                    self.label_encoders[col] = le\n                else:\n                    print(f&quot;警告: 列 &#123;col&#125; 不存在于数据中&quot;)\n        \n        # 2. 处理无序特征(One-Hot Encoding)\n        if nominal_features:\n            df = pd.get_dummies(df, \n                              columns=nominal_features,\n                              prefix=nominal_features)\n            # 保存生成的One-Hot列名\n            for col in nominal_features:\n                self.feature_columns[col] = [c for c in df.columns if c.startswith(f&quot;&#123;col&#125;_&quot;)]\n        \n        return df\n\n    def transform(self, data):\n        &quot;&quot;&quot;转换测试数据&quot;&quot;&quot;\n        df = data.copy()\n        \n        # 1. 使用已拟合的LabelEncoder转换有序特征\n        for col, le in self.label_encoders.items():\n            if col in df.columns:\n                # 处理测试集中的未知类别\n                df[col] = df[col].astype(str)\n                for val in df[col].unique():\n                    if val not in le.classes_:\n                        print(f&quot;警告: 特征 &#123;col&#125; 中发现新类别 &#123;val&#125;，将其替换为最频繁类别&quot;)\n                df[col] = df[col].map(lambda x: x if x in le.classes_ else le.classes_[0])\n                df[col] = le.transform(df[col])\n        \n        # 2. 处理无序特征的One-Hot编码\n        for col, columns in self.feature_columns.items():\n            if col in df.columns:\n                # 创建One-Hot编码\n                temp_df = pd.get_dummies(df[col], prefix=col)\n                # 确保所有训练集中的列都存在\n                for column in columns:\n                    if column not in temp_df.columns:\n                        temp_df[column] = 0\n                # 删除多余的列\n                temp_df = temp_df[columns]\n                # 替换原始列\n                df = df.drop(col, axis=1)\n                df = pd.concat([df, temp_df], axis=1)\n        \n        return df\n\n# # 1. 先转换为category类型（如果需要）\n# train_data = convert_to_category(\n#     train_data,\n#     category_columns=[&quot;season&quot;, &quot;holiday&quot;, &quot;weather&quot;]\n# )\n# submit_data = convert_to_category(\n#     submit_data,\n#     category_columns=[&quot;season&quot;, &quot;holiday&quot;, &quot;weather&quot;]\n# )\n\n# 2. 使用编码器进行特征编码\nencoder = CategoryEncoder()\n\n# 拟合并转换训练集\ntrain_data = encoder.fit_transform(\n    train_data,\n    ordinal_features=[\&#39;season\&#39;],\n    nominal_features=[\&#39;weather\&#39;, \&#39;holiday\&#39;]\n)\n\n# 使用相同的编码器转换测试集\nsubmit_data = encoder.transform(submit_data)\n &#39;</code></pre><p>对于时间特征：</p><ol type="1"><li>周期性特征(hour,month,weekday)-&gt;倾向转分类</li><li>顺序性特征(year,day)-&gt;倾向保持数值</li></ol><p>选择建议:</p><ol type="1"><li>使用Label Encoding:</li></ol><ul><li>特征有明显的顺序关系</li><li>使用树模型</li><li>特征的唯一值较多</li><li>需要保持特征维度不变</li></ul><ol start="2" type="1"><li>使用One-Hot Encoding:</li></ol><ul><li>特征无顺序关系</li><li>使用线性模型</li><li>特征的唯一值较少</li><li>需要避免数值大小带来的影响</li></ul><h1 id="模型训练">4 模型训练</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 忽略警告信息</span><br><span class="hljs-keyword">import</span> warnings<br>warnings.filterwarnings(<span class="hljs-string">&quot;ignore&quot;</span>)<br><br><span class="hljs-comment"># 绘图相关</span><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br>plt.rcParams.update(&#123;<span class="hljs-string">&#x27;figure.max_open_warning&#x27;</span>: <span class="hljs-number">0</span>&#125;)<br><br><span class="hljs-comment"># 数据处理</span><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># 模型选择与评估</span><br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> (<br>    train_test_split,<br>    GridSearchCV,<br>    cross_val_score,<br>    cross_val_predict,<br>    KFold,<br>    RepeatedKFold,<br>    TimeSeriesSplit,<br>    StratifiedKFold <br>)<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> (<br>    make_scorer,<br>    mean_squared_error,<br>    r2_score,f1_score, <br>    precision_score, <br>    recall_score, <br>    roc_auc_score<br>)<br><br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score<br><br><br><span class="hljs-comment"># 线性模型</span><br><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Lasso, Ridge, ElasticNet<br><br><span class="hljs-comment"># 支持向量机</span><br><span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> LinearSVR, SVR<br><br><span class="hljs-comment"># 最近邻模型</span><br><span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsRegressor<br><br><span class="hljs-comment"># 集成学习模型</span><br><span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> (<br>    RandomForestRegressor,<br>    GradientBoostingRegressor,<br>    AdaBoostRegressor,<br>    ExtraTreesRegressor<br>)<br><br><span class="hljs-comment">#  XGBoost 和 LightGBM 模型</span><br><span class="hljs-keyword">import</span> xgboost <span class="hljs-keyword">as</span> xgb<br><span class="hljs-keyword">import</span> lightgbm <span class="hljs-keyword">as</span> lgb<br><br><span class="hljs-comment"># 抽象基类 (虽然这里没有使用，但被引入了，保留)</span><br><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">rmse</span>(<span class="hljs-params">y_true, y_pred</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;均方根误差&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> np.sqrt(mean_squared_error(y_true, y_pred))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rmsle</span>(<span class="hljs-params">y_true, y_pred</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    计算RMSLE (Root Mean Squared Logarithmic Error)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 确保预测值和真实值都是正数</span><br>    y_true = np.maximum(<span class="hljs-number">0</span>, np.array(y_true))  <span class="hljs-comment"># 将负值截断为0</span><br>    y_pred = np.maximum(<span class="hljs-number">0</span>, np.array(y_pred))  <span class="hljs-comment"># 将负值截断为0</span><br>    <br>    <span class="hljs-comment"># 计算RMSLE</span><br>    log_true = np.log1p(y_true)<br>    log_pred = np.log1p(y_pred)<br>    squared_errors = np.square(log_pred - log_true)<br>    mean_squared_errors = np.mean(squared_errors)<br>    rmsle_score = np.sqrt(mean_squared_errors)<br>    <br>    <span class="hljs-keyword">return</span> rmsle_score<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDataSplitter</span>(<span class="hljs-title class_ inherited__">ABC</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    数据分割器的抽象基类</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><span class="hljs-meta">    @abstractmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split</span>(<span class="hljs-params">self, data, target_col=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将数据分割成训练集和验证集。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - data: 数据集</span><br><span class="hljs-string">        - target_col: 目标列名</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - X_train, X_val, y_train, y_val</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-meta">    @abstractmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cv</span>(<span class="hljs-params">self, data, n_splits=<span class="hljs-number">5</span>, *args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取交叉验证迭代器。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - data: 数据集</span><br><span class="hljs-string">        - n_splits: 交叉验证折数</span><br><span class="hljs-string">        - *args, **kwargs: 其他参数</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - 交叉验证迭代器</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RegressionSplitter</span>(<span class="hljs-title class_ inherited__">BaseDataSplitter</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    用于回归任务的数据分割器</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span></span>):<br>        self.test_size = test_size<br>        self.random_state = random_state<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split</span>(<span class="hljs-params">self, data, target_col=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-keyword">if</span> target_col <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;target_col must be specified for regression tasks.&quot;</span>)<br>        X = data.drop(target_col, axis=<span class="hljs-number">1</span>)<br>        y = data[target_col]<br>        <span class="hljs-keyword">return</span> train_test_split(X, y, test_size=self.test_size, random_state=self.random_state)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cv</span>(<span class="hljs-params">self, data, n_splits=<span class="hljs-number">5</span>, *args, **kwargs</span>):<br>        <span class="hljs-keyword">return</span> KFold(n_splits=n_splits, shuffle=<span class="hljs-literal">True</span>, random_state=self.random_state)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassificationSplitter</span>(<span class="hljs-title class_ inherited__">BaseDataSplitter</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    用于分类任务的数据分割器</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>, stratify=<span class="hljs-literal">True</span></span>):<br>        self.test_size = test_size<br>        self.random_state = random_state<br>        self.stratify = stratify<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split</span>(<span class="hljs-params">self, data, target_col=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-keyword">if</span> target_col <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;target_col must be specified for classification tasks.&quot;</span>)<br>        X = data.drop(target_col, axis=<span class="hljs-number">1</span>)<br>        y = data[target_col]<br>        <span class="hljs-keyword">if</span> self.stratify:<br>            <span class="hljs-keyword">return</span> train_test_split(X, y, test_size=self.test_size, random_state=self.random_state, stratify=y)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> train_test_split(X, y, test_size=self.test_size, random_state=self.random_state)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cv</span>(<span class="hljs-params">self, data, n_splits=<span class="hljs-number">5</span>, *args, **kwargs</span>):<br>        target_col = kwargs.get(<span class="hljs-string">&#x27;target_col&#x27;</span>, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">if</span> target_col <span class="hljs-keyword">and</span> self.stratify:<br>             y = data[target_col]<br>             <span class="hljs-keyword">return</span> StratifiedKFold(n_splits=n_splits, shuffle=<span class="hljs-literal">True</span>, random_state=self.random_state)<br>        <span class="hljs-keyword">else</span>:<br>             <span class="hljs-keyword">return</span> KFold(n_splits=n_splits, shuffle=<span class="hljs-literal">True</span>, random_state=self.random_state)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeSeriesSplitter</span>(<span class="hljs-title class_ inherited__">BaseDataSplitter</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    用于时间序列任务的数据分割器</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, test_size=<span class="hljs-number">0.2</span></span>):<br>        self.test_size = test_size<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split</span>(<span class="hljs-params">self, data, target_col=<span class="hljs-literal">None</span></span>):<br>        data = data.sort_index()<br>        n_samples = <span class="hljs-built_in">len</span>(data)<br>        test_samples = <span class="hljs-built_in">int</span>(n_samples * self.test_size)<br>        train_samples = n_samples - test_samples<br><br>        train = data.iloc[:train_samples]<br>        test = data.iloc[train_samples:]<br><br>        <span class="hljs-keyword">if</span> target_col <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            X_train = train.drop(target_col, axis=<span class="hljs-number">1</span>)<br>            y_train = train[target_col]<br>            X_test = test.drop(target_col, axis=<span class="hljs-number">1</span>)<br>            y_test = test[target_col]<br>            <span class="hljs-keyword">return</span> X_train, X_test, y_train, y_test<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> train, test<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cv</span>(<span class="hljs-params">self, data, n_splits=<span class="hljs-number">5</span>, gap=<span class="hljs-number">0</span>, *args, **kwargs</span>):<br>        test_size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(data) * self.test_size)<br>        max_splits = (<span class="hljs-built_in">len</span>(data) - gap) // test_size - <span class="hljs-number">1</span><br>        n_splits = <span class="hljs-built_in">min</span>(n_splits, max_splits)<br>        <span class="hljs-keyword">if</span> n_splits &lt; <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;数据量不足以进行<span class="hljs-subst">&#123;n_splits&#125;</span>折交叉验证&quot;</span>)<br>                  <br>        <span class="hljs-keyword">return</span> TimeSeriesSplit(n_splits=n_splits, gap=gap, test_size=test_size)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSplitterFactory</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    数据分割器的工厂类</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self._splitters = &#123;&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_splitter</span>(<span class="hljs-params">self, name, splitter</span>):<br>        self._splitters[name] = splitter<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_splitter</span>(<span class="hljs-params">self, name, **kwargs</span>):<br>        splitter = self._splitters.get(name)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> splitter:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Unknown splitter type: <span class="hljs-subst">&#123;name&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> splitter(**kwargs)<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> gc<br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> KFold<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error, r2_score, accuracy_score, f1_score, precision_score, recall_score, roc_auc_score<br><br><span class="hljs-comment"># Assuming these are defined elsewhere in your code</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rmse</span>(<span class="hljs-params">y_true, y_pred</span>):<br>    <span class="hljs-keyword">return</span> np.sqrt(mean_squared_error(y_true, y_pred))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rmsle</span>(<span class="hljs-params">y_true, y_pred</span>):<br>    <span class="hljs-keyword">return</span> np.sqrt(mean_squared_error(np.log1p(y_true), np.log1p(y_pred)))<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelFactory</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Model factory class for creating model instances</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self._models = &#123;&#125;<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_model</span>(<span class="hljs-params">self, name, model</span>):<br>        self._models[name] = model<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_model</span>(<span class="hljs-params">self, name, **kwargs</span>):<br>        model = self._models.get(name)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> model:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Unknown model type: <span class="hljs-subst">&#123;name&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> model(**kwargs)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelTrainingPipeline</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Model training pipeline class with enhanced stacking</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_factory, param_optimizer=<span class="hljs-literal">None</span>, metrics=<span class="hljs-literal">None</span>, primary_metric=<span class="hljs-string">&#x27;rmse&#x27;</span>, model_fusion=<span class="hljs-literal">None</span>, meta_model=<span class="hljs-literal">None</span>, n_folds=<span class="hljs-number">5</span></span>):<br>        self.model_factory = model_factory<br>        self.models = &#123;&#125;<br>        self.param_optimizer = param_optimizer<br>        self.meta_model = meta_model<br>        self.n_folds = n_folds  <span class="hljs-comment"># Number of folds for stacking CV</span><br><br>        <span class="hljs-comment"># Metrics setup (unchanged)</span><br>        self.available_metrics = &#123;<br>            <span class="hljs-string">&#x27;mse&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: mean_squared_error, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">False</span>&#125;,<br>            <span class="hljs-string">&#x27;rmse&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: rmse, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">False</span>&#125;,<br>            <span class="hljs-string">&#x27;rmsle&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: rmsle, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">False</span>&#125;,<br>            <span class="hljs-string">&#x27;r2&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: r2_score, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">True</span>&#125;,<br>            <span class="hljs-string">&#x27;accuracy&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: accuracy_score, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">True</span>&#125;,<br>            <span class="hljs-string">&#x27;f1&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: f1_score, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">True</span>&#125;,<br>            <span class="hljs-string">&#x27;precision&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: precision_score, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">True</span>&#125;,<br>            <span class="hljs-string">&#x27;recall&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: recall_score, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">True</span>&#125;,<br>            <span class="hljs-string">&#x27;auc&#x27;</span>: &#123;<span class="hljs-string">&#x27;func&#x27;</span>: roc_auc_score, <span class="hljs-string">&#x27;greater_is_better&#x27;</span>: <span class="hljs-literal">True</span>&#125;<br>        &#125;<br>        self.metrics = self.available_metrics <span class="hljs-keyword">if</span> metrics <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> &#123;<br>            name: self.available_metrics[name] <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> metrics <span class="hljs-keyword">if</span> name <span class="hljs-keyword">in</span> self.available_metrics<br>        &#125;<br>        <span class="hljs-keyword">if</span> primary_metric <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.metrics:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Primary metric <span class="hljs-subst">&#123;primary_metric&#125;</span> not in defined metrics&quot;</span>)<br>        self.primary_metric = primary_metric<br>        <br>        self.model_fusion = model_fusion <span class="hljs-keyword">if</span> model_fusion <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> self.simple_average_fusion<br>        self.model_scores = &#123;&#125;<br>        self.train_results = &#123;&#125;<br>        self.X_train = <span class="hljs-literal">None</span><br>        self.y_train = <span class="hljs-literal">None</span><br>        self.X_val = <span class="hljs-literal">None</span><br>        self.y_val = <span class="hljs-literal">None</span><br>        self.training_history = &#123;&#125;<br>        self.feature_importance = &#123;&#125;<br>        self.optimization_history = &#123;&#125;<br>        self.prediction_history = &#123;&#125;<br>        self.stacking_features = <span class="hljs-literal">None</span>  <span class="hljs-comment"># Store stacking features for prediction</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_model</span>(<span class="hljs-params">self, name, model, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Register a model to the pipeline&quot;&quot;&quot;</span><br>        self.models[name] = self.model_factory.create_model(model, **kwargs)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_train_model</span>(<span class="hljs-params">self, model_name, X_train, y_train, X_val, y_val, param_grid=<span class="hljs-literal">None</span>, cv=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Train a single model (unchanged)&quot;&quot;&quot;</span><br>        model = self.models[model_name]<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> param_grid <span class="hljs-keyword">and</span> self.param_optimizer:<br>                metric_info = self.metrics[self.primary_metric]<br>                optimized_model = self.param_optimizer(<br>                    model, param_grid, X_train, y_train, cv,<br>                    metric_info[<span class="hljs-string">&#x27;func&#x27;</span>], metric_info[<span class="hljs-string">&#x27;greater_is_better&#x27;</span>],<br>                    callback=self._update_optimization_history<br>                )<br>                self.models[model_name] = optimized_model<br>                model = optimized_model<br>            <span class="hljs-keyword">else</span>:<br>                model.fit(X_train, y_train)<br>            val_pred = model.predict(X_val)<br>            model_scores = self._calculate_metrics(y_val, val_pred)<br>            model_scores[<span class="hljs-string">&#x27;model&#x27;</span>] = model<br>            self.model_scores[model_name] = model_scores<br>            self.train_results[model_name] = val_pred<br>            <span class="hljs-keyword">return</span> val_pred<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Warning: Model <span class="hljs-subst">&#123;model_name&#125;</span> training failed: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_metrics</span>(<span class="hljs-params">self, y_true, y_pred</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Calculate evaluation metrics (unchanged)&quot;&quot;&quot;</span><br>        scores = &#123;&#125;<br>        <span class="hljs-keyword">for</span> metric_name, metric_info <span class="hljs-keyword">in</span> self.metrics.items():<br>            <span class="hljs-keyword">try</span>:<br>                scores[metric_name] = metric_info[<span class="hljs-string">&#x27;func&#x27;</span>](y_true, y_pred)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Warning: Metric <span class="hljs-subst">&#123;metric_name&#125;</span> calculation failed: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> scores<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train_and_evaluate</span>(<span class="hljs-params">self, X_train, y_train, X_val, y_val, param_grids=<span class="hljs-literal">None</span>, cv=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Train and evaluate all models, including stacking&quot;&quot;&quot;</span><br>        self.X_train = X_train<br>        self.y_train = y_train<br>        self.X_val = X_val<br>        self.y_val = y_val<br><br>        <span class="hljs-keyword">if</span> param_grids <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            param_grids = &#123;&#125;<br>        predictions = &#123;&#125;<br><br>        <span class="hljs-comment"># Train base models</span><br>        <span class="hljs-keyword">for</span> model_name <span class="hljs-keyword">in</span> self.models:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nStarting training model: <span class="hljs-subst">&#123;model_name&#125;</span>&quot;</span>)<br>            param_grid = param_grids.get(model_name, <span class="hljs-literal">None</span>)<br>            val_pred = self._train_model(model_name, X_train, y_train, X_val, y_val, param_grid, cv)<br>            <span class="hljs-keyword">if</span> val_pred <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                predictions[model_name] = val_pred<br>        <br>        <span class="hljs-comment"># Simple average fusion</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(predictions) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> self.model_fusion:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Performing simple average fusion...&quot;</span>)<br>            fusion_pred = self.model_fusion(<span class="hljs-built_in">list</span>(predictions.values()))<br>            fusion_scores = self._calculate_metrics(y_val, fusion_pred)<br>            self.model_scores[<span class="hljs-string">&quot;fusion&quot;</span>] = fusion_scores<br>            self.train_results[<span class="hljs-string">&quot;fusion&quot;</span>] = fusion_pred<br>        <br>        <span class="hljs-comment"># Perform stacking with k-fold CV</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(predictions) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> self.meta_model <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Performing Stacking fusion...&quot;</span>)<br>            <span class="hljs-comment"># Combine train and validation sets for full stacking</span><br>            X_full = np.vstack([X_train, X_val])<br>            y_full = np.concatenate([y_train, y_val])<br>            stacking_pred = self.perform_stacking(X_full, y_full, X_val)<br>            <span class="hljs-keyword">if</span> stacking_pred <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                self.train_results[<span class="hljs-string">&quot;stacking&quot;</span>] = stacking_pred<br>        <br>        self._analyze_performance()<br>        <span class="hljs-keyword">return</span> self.model_scores<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_analyze_performance</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Analyze and print model performance (unchanged)&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nModel performance comparison:&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br>        sorted_models = <span class="hljs-built_in">sorted</span>(<br>            self.model_scores.items(),<br>            key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>].get(self.primary_metric, <span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;inf&#x27;</span>))<br>        )<br>        <span class="hljs-keyword">for</span> name, scores <span class="hljs-keyword">in</span> sorted_models:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span>:&quot;</span>)<br>            <span class="hljs-keyword">for</span> metric_name, score <span class="hljs-keyword">in</span> scores.items():<br>                <span class="hljs-keyword">if</span> metric_name != <span class="hljs-string">&#x27;model&#x27;</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">&#123;metric_name&#125;</span>: <span class="hljs-subst">&#123;score:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># def predict(self, X_test, method=&#x27;stacking&#x27;):</span><br>    <span class="hljs-comment">#     &quot;&quot;&quot;Generate predictions with enhanced stacking support&quot;&quot;&quot;</span><br>    <span class="hljs-comment">#     try:</span><br>    <span class="hljs-comment">#         if method in self.models:</span><br>    <span class="hljs-comment">#             return self.models[method].predict(X_test)</span><br>    <span class="hljs-comment">#         elif method == &#x27;fusion&#x27;:</span><br>    <span class="hljs-comment">#             predictions = [self.models[name].predict(X_test) for name in self.models]</span><br>    <span class="hljs-comment">#             return self.model_fusion(predictions)</span><br>    <span class="hljs-comment">#         elif method == &#x27;stacking&#x27; and self.meta_model is not None:</span><br>    <span class="hljs-comment">#             if not hasattr(self.meta_model, &#x27;fitted_&#x27;) or self.stacking_features is None:</span><br>    <span class="hljs-comment">#                 raise ValueError(&quot;Meta-model not trained or stacking features not prepared. Run train_and_evaluate first.&quot;)</span><br>    <span class="hljs-comment">#             # Generate base model predictions on test data</span><br>    <span class="hljs-comment">#             base_predictions = [self.models[name].predict(X_test) for name in self.models]</span><br>    <span class="hljs-comment">#             stacking_features = np.column_stack(base_predictions)</span><br>    <span class="hljs-comment">#             predictions = self.meta_model.predict(stacking_features)</span><br>    <span class="hljs-comment">#             if predictions.ndim == 1:</span><br>    <span class="hljs-comment">#                 predictions = predictions.reshape(-1, 1)</span><br>    <span class="hljs-comment">#             return predictions</span><br>    <span class="hljs-comment">#         else:</span><br>    <span class="hljs-comment">#             raise ValueError(f&quot;Unknown prediction method: &#123;method&#125;&quot;)</span><br>    <span class="hljs-comment">#     except Exception as e:</span><br>    <span class="hljs-comment">#         print(f&quot;Prediction failed: &#123;str(e)&#125;&quot;)</span><br>    <span class="hljs-comment">#         return None</span><br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self, X_test, method=<span class="hljs-string">&#x27;stacking&#x27;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Generate predictions with enhanced stacking support&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> self.models:<br>                <span class="hljs-keyword">return</span> self.models[method].predict(X_test)<br>            <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&#x27;fusion&#x27;</span>:<br>                predictions = [self.models[name].predict(X_test) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self.models]<br>                <span class="hljs-keyword">return</span> self.model_fusion(predictions)<br>            <span class="hljs-keyword">elif</span> method == <span class="hljs-string">&#x27;stacking&#x27;</span> <span class="hljs-keyword">and</span> self.meta_model <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(self.meta_model, <span class="hljs-string">&#x27;fitted_&#x27;</span>) <span class="hljs-keyword">or</span> self.stacking_features <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Meta-model not trained or stacking features not prepared. Run train_and_evaluate first.&quot;</span>)<br>                <br>                <span class="hljs-comment"># Generate base model predictions on test data</span><br>                base_predictions = [self.models[name].predict(X_test) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self.models]<br>                stacking_features = np.column_stack(base_predictions)<br>                <br>                <span class="hljs-comment"># 如果训练时使用了原始特征，预测时也需要使用</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;concat_original_features&#x27;</span>) <span class="hljs-keyword">and</span> self.concat_original_features:<br>                    stacking_features = np.column_stack([stacking_features, X_test])<br>                    <br>                predictions = self.meta_model.predict(stacking_features)<br>                <span class="hljs-keyword">if</span> predictions.ndim == <span class="hljs-number">1</span>:<br>                    predictions = predictions.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>                <span class="hljs-keyword">return</span> predictions<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Unknown prediction method: <span class="hljs-subst">&#123;method&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Prediction failed: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_average_fusion</span>(<span class="hljs-params">self, predictions</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;Simple average fusion method (unchanged)&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> np.mean(predictions, axis=<span class="hljs-number">0</span>)<br><br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">perform_stacking</span>(<span class="hljs-params">self, X_full, y_full, X_val, concat_original_features=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Perform stacking with k-fold cross-validation for base model predictions</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> self.meta_model <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Meta-model not provided for stacking&quot;</span>)<br>            <br>            <span class="hljs-comment"># 保存concat_original_features设置，以便predict方法使用</span><br>            self.concat_original_features = concat_original_features<br>            <br>            <span class="hljs-comment"># Initialize k-fold cross-validation</span><br>            kf = KFold(n_splits=self.n_folds, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)<br>            base_predictions = &#123;name: np.zeros(<span class="hljs-built_in">len</span>(X_full)) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self.models&#125;<br>            <br>            <span class="hljs-comment"># Generate out-of-fold predictions for base models</span><br>            <span class="hljs-keyword">for</span> train_idx, val_idx <span class="hljs-keyword">in</span> kf.split(X_full):<br>                X_train_fold, X_val_fold = X_full[train_idx], X_full[val_idx]<br>                y_train_fold, y_val_fold = y_full[train_idx], y_full[val_idx]<br>                <br>                <span class="hljs-keyword">for</span> model_name <span class="hljs-keyword">in</span> self.models:<br>                    model = self.models[model_name]<br>                    model.fit(X_train_fold, y_train_fold)<br>                    val_pred = model.predict(X_val_fold)<br>                    base_predictions[model_name][val_idx] = val_pred<br>            <br>            <span class="hljs-comment"># Stack base predictions</span><br>            all_predictions = np.column_stack([base_predictions[name] <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self.models])<br>            <span class="hljs-keyword">if</span> concat_original_features:<br>                all_predictions = np.column_stack([all_predictions, X_full])<br>            <br>            <span class="hljs-comment"># Train meta-model on out-of-fold predictions</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Training stacking meta-model...&quot;</span>)<br>            self.meta_model.fit(all_predictions, y_full)<br>            self.meta_model.fitted_ = <span class="hljs-literal">True</span>  <span class="hljs-comment"># Flag to indicate training</span><br>            <br><br>            <span class="hljs-comment"># Retrain base models on full data</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Retraining base models on full training data...&quot;</span>)<br>            <span class="hljs-keyword">for</span> model_name <span class="hljs-keyword">in</span> self.models:<br>                self.models[model_name].fit(X_full, y_full)<br><br>            <span class="hljs-comment"># Generate stacking predictions on validation set for evaluation</span><br>            val_base_preds = [self.models[name].predict(X_val) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self.models]<br>            val_stacking_features = np.column_stack(val_base_preds)<br>            <span class="hljs-keyword">if</span> concat_original_features:<br>                val_stacking_features = np.column_stack([val_stacking_features, X_val])<br>            stacking_pred = self.meta_model.predict(val_stacking_features)<br>            <br>            <span class="hljs-comment"># Store stacking features structure for prediction</span><br>            self.stacking_features = val_stacking_features<br>            <br>            <span class="hljs-comment"># Calculate and store stacking performance</span><br>            scores = self._calculate_metrics(y_full[-<span class="hljs-built_in">len</span>(X_val):], stacking_pred)<br>            scores[<span class="hljs-string">&#x27;model&#x27;</span>] = self.meta_model<br>            self.model_scores[<span class="hljs-string">&#x27;stacking&#x27;</span>] = scores<br>            <br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nStacking model performance:&quot;</span>)<br>            <span class="hljs-keyword">for</span> metric_name, score <span class="hljs-keyword">in</span> scores.items():<br>                <span class="hljs-keyword">if</span> metric_name != <span class="hljs-string">&#x27;model&#x27;</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">&#123;metric_name&#125;</span>: <span class="hljs-subst">&#123;score:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>            <br>            <span class="hljs-keyword">return</span> stacking_pred<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Warning: Stacking failed: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><br>    <span class="hljs-comment"># 原模型超参数-未调整好</span><br>    <span class="hljs-comment"># def perform_stacking(self, X_full, y_full, X_val, concat_original_features=False, meta_param_grid=None):</span><br>    <span class="hljs-comment">#     &quot;&quot;&quot;</span><br>    <span class="hljs-comment">#     Perform stacking with k-fold cross-validation for base model predictions</span><br>        <br>    <span class="hljs-comment">#     参数:</span><br>    <span class="hljs-comment">#     - X_full: 训练数据特征</span><br>    <span class="hljs-comment">#     - y_full: 训练数据标签</span><br>    <span class="hljs-comment">#     - X_val: 验证数据特征</span><br>    <span class="hljs-comment">#     - concat_original_features: 是否将原始特征与基础模型预测拼接</span><br>    <span class="hljs-comment">#     - meta_param_grid: 元模型的超参数网格，用于网格搜索</span><br>    <span class="hljs-comment">#     &quot;&quot;&quot;</span><br>    <span class="hljs-comment">#     try:</span><br>    <span class="hljs-comment">#         if self.meta_model is None:</span><br>    <span class="hljs-comment">#             raise ValueError(&quot;Meta-model not provided for stacking&quot;)</span><br>            <br>    <span class="hljs-comment">#         # 保存concat_original_features设置，以便predict方法使用</span><br>    <span class="hljs-comment">#         self.concat_original_features = concat_original_features</span><br>            <br>    <span class="hljs-comment">#         # Initialize k-fold cross-validation</span><br>    <span class="hljs-comment">#         kf = KFold(n_splits=self.n_folds, shuffle=True, random_state=42)</span><br>    <span class="hljs-comment">#         base_predictions = &#123;name: np.zeros(len(X_full)) for name in self.models&#125;</span><br>            <br>    <span class="hljs-comment">#         # Generate out-of-fold predictions for base models</span><br>    <span class="hljs-comment">#         for train_idx, val_idx in kf.split(X_full):</span><br>    <span class="hljs-comment">#             X_train_fold, X_val_fold = X_full[train_idx], X_full[val_idx]</span><br>    <span class="hljs-comment">#             y_train_fold, y_val_fold = y_full[train_idx], y_full[val_idx]</span><br>                <br>    <span class="hljs-comment">#             for model_name in self.models:</span><br>    <span class="hljs-comment">#                 model = self.models[model_name]</span><br>    <span class="hljs-comment">#                 model.fit(X_train_fold, y_train_fold)</span><br>    <span class="hljs-comment">#                 val_pred = model.predict(X_val_fold)</span><br>    <span class="hljs-comment">#                 base_predictions[model_name][val_idx] = val_pred</span><br>            <br>    <span class="hljs-comment">#         # Stack base predictions</span><br>    <span class="hljs-comment">#         all_predictions = np.column_stack([base_predictions[name] for name in self.models])</span><br>    <span class="hljs-comment">#         if concat_original_features:</span><br>    <span class="hljs-comment">#             all_predictions = np.column_stack([all_predictions, X_full])</span><br>            <br>    <span class="hljs-comment">#         # 训练meta-model，如果提供了参数网格则进行网格搜索</span><br>    <span class="hljs-comment">#         print(&quot;Training stacking meta-model...&quot;)</span><br>    <span class="hljs-comment">#         if meta_param_grid is not None:</span><br>    <span class="hljs-comment">#             print(f&quot;执行元模型网格搜索，参数网格: &#123;meta_param_grid&#125;&quot;)</span><br>                <br>    <span class="hljs-comment">#             # 创建网格搜索对象</span><br>    <span class="hljs-comment">#             metric_info = self.metrics[self.primary_metric]</span><br>    <span class="hljs-comment">#             meta_cv = KFold(n_splits=min(5, len(X_full) // 3), shuffle=True, random_state=42)</span><br>                <br>    <span class="hljs-comment">#             gsearch = GridSearchCV(</span><br>    <span class="hljs-comment">#                 self.meta_model,</span><br>    <span class="hljs-comment">#                 meta_param_grid,</span><br>    <span class="hljs-comment">#                 cv=meta_cv,</span><br>    <span class="hljs-comment">#                 scoring=make_scorer(</span><br>    <span class="hljs-comment">#                     metric_info[&#x27;func&#x27;],</span><br>    <span class="hljs-comment">#                     greater_is_better=metric_info[&#x27;greater_is_better&#x27;]</span><br>    <span class="hljs-comment">#                 ),</span><br>    <span class="hljs-comment">#                 verbose=1,</span><br>    <span class="hljs-comment">#                 return_train_score=True</span><br>    <span class="hljs-comment">#             )</span><br>                <br>    <span class="hljs-comment">#             # 执行网格搜索</span><br>    <span class="hljs-comment">#             gsearch.fit(all_predictions, y_full)</span><br>                <br>    <span class="hljs-comment">#             # 输出优化结果</span><br>    <span class="hljs-comment">#             metric_name = self.primary_metric.upper()</span><br>    <span class="hljs-comment">#             best_score = abs(gsearch.best_score_) if not metric_info[&#x27;greater_is_better&#x27;] else gsearch.best_score_</span><br>                <br>    <span class="hljs-comment">#             print(f&quot;\n元模型网格搜索结果:&quot;)</span><br>    <span class="hljs-comment">#             print(f&quot;- 最佳参数：&#123;gsearch.best_params_&#125;&quot;)</span><br>    <span class="hljs-comment">#             print(f&quot;- 最佳&#123;metric_name&#125;得分：&#123;best_score:.4f&#125;&quot;)</span><br>    <span class="hljs-comment">#             print(f&quot;- 验证集标准差：&#123;np.mean(gsearch.cv_results_[&#x27;std_test_score&#x27;]):.4f&#125;&quot;)</span><br>                <br>    <span class="hljs-comment">#             # 更新meta_model为最佳模型</span><br>    <span class="hljs-comment">#             self.meta_model = gsearch.best_estimator_</span><br>                <br>    <span class="hljs-comment">#             # 保存优化历史</span><br>    <span class="hljs-comment">#             if &#x27;stacking&#x27; not in self.optimization_history:</span><br>    <span class="hljs-comment">#                 self.optimization_history[&#x27;stacking&#x27;] = &#123;</span><br>    <span class="hljs-comment">#                     &#x27;params&#x27;: [],</span><br>    <span class="hljs-comment">#                     &#x27;scores&#x27;: []</span><br>    <span class="hljs-comment">#                 &#125;</span><br>                <br>    <span class="hljs-comment">#             for i, params in enumerate(gsearch.cv_results_[&#x27;params&#x27;]):</span><br>    <span class="hljs-comment">#                 mean_score = abs(gsearch.cv_results_[&#x27;mean_test_score&#x27;][i]) if not metric_info[&#x27;greater_is_better&#x27;] else gsearch.cv_results_[&#x27;mean_test_score&#x27;][i]</span><br>    <span class="hljs-comment">#                 self.optimization_history[&#x27;stacking&#x27;][&#x27;params&#x27;].append(params)</span><br>    <span class="hljs-comment">#                 self.optimization_history[&#x27;stacking&#x27;][&#x27;scores&#x27;].append(mean_score)</span><br>    <span class="hljs-comment">#         else:</span><br>    <span class="hljs-comment">#             # 直接训练meta_model</span><br>    <span class="hljs-comment">#             self.meta_model.fit(all_predictions, y_full)</span><br>            <br>    <span class="hljs-comment">#         self.meta_model.fitted_ = True  # Flag to indicate training</span><br><br>    <span class="hljs-comment">#         # Retrain base models on full data</span><br>    <span class="hljs-comment">#         print(&quot;Retraining base models on full training data...&quot;)</span><br>    <span class="hljs-comment">#         for model_name in self.models:</span><br>    <span class="hljs-comment">#             self.models[model_name].fit(X_full, y_full)</span><br><br>    <span class="hljs-comment">#         # Generate stacking predictions on validation set for evaluation</span><br>    <span class="hljs-comment">#         val_base_preds = [self.models[name].predict(X_val) for name in self.models]</span><br>    <span class="hljs-comment">#         val_stacking_features = np.column_stack(val_base_preds)</span><br>    <span class="hljs-comment">#         if concat_original_features:</span><br>    <span class="hljs-comment">#             val_stacking_features = np.column_stack([val_stacking_features, X_val])</span><br>    <span class="hljs-comment">#         stacking_pred = self.meta_model.predict(val_stacking_features)</span><br>            <br>    <span class="hljs-comment">#         # Store stacking features structure for prediction</span><br>    <span class="hljs-comment">#         self.stacking_features = val_stacking_features</span><br>            <br>    <span class="hljs-comment">#         # Calculate and store stacking performance</span><br>    <span class="hljs-comment">#         scores = self._calculate_metrics(y_full[-len(X_val):], stacking_pred)</span><br>    <span class="hljs-comment">#         scores[&#x27;model&#x27;] = self.meta_model</span><br>    <span class="hljs-comment">#         self.model_scores[&#x27;stacking&#x27;] = scores</span><br>            <br>    <span class="hljs-comment">#         print(f&quot;\nStacking model performance:&quot;)</span><br>    <span class="hljs-comment">#         for metric_name, score in scores.items():</span><br>    <span class="hljs-comment">#             if metric_name != &#x27;model&#x27;:</span><br>    <span class="hljs-comment">#                 print(f&quot;  &#123;metric_name&#125;: &#123;score:.4f&#125;&quot;)</span><br>            <br>    <span class="hljs-comment">#         return stacking_pred</span><br>            <br>    <span class="hljs-comment">#     except Exception as e:</span><br>    <span class="hljs-comment">#         print(f&quot;Warning: Stacking failed: &#123;str(e)&#125;&quot;)</span><br>    <span class="hljs-comment">#         return None</span><br><br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">visualize_training</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;综合可视化函数&quot;&quot;&quot;</span><br>        self._plot_model_comparison()<br>        self._plot_feature_importance()<br>        self._plot_optimization_history()<br>        self._plot_prediction_vs_actual()<br>        self._plot_residual_analysis()<br>        self._plot_learning_curves()<br>        self._plot_cross_validation_scores()<br>        self._plot_correlation_matrix()<br>        self._plot_error_distribution()<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_model_comparison</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制模型性能对比图&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>                    <span class="hljs-comment"># 设置中文字体</span><br>            plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]  <span class="hljs-comment"># 用来正常显示中文标签</span><br>            plt.rcParams[<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 用来正常显示负号</span><br>            <br>            plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">6</span>))<br>            <br>            <span class="hljs-comment"># 准备数据</span><br>            models = <span class="hljs-built_in">list</span>(self.model_scores.keys())<br>            metrics_data = &#123;<br>                metric: [self.model_scores[model][metric] <br>                        <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> models <span class="hljs-keyword">if</span> metric <span class="hljs-keyword">in</span> self.model_scores[model] <span class="hljs-keyword">and</span> metric != <span class="hljs-string">&#x27;model&#x27;</span>]<br>                <span class="hljs-keyword">for</span> metric <span class="hljs-keyword">in</span> self.metrics.keys()<br>            &#125;<br>            <br>            <span class="hljs-comment"># 绘制柱状图</span><br>            x = np.arange(<span class="hljs-built_in">len</span>(models))<br>            width = <span class="hljs-number">0.8</span> / <span class="hljs-built_in">len</span>(metrics_data)<br>            <br>            <span class="hljs-keyword">for</span> i, (metric, scores) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(metrics_data.items()):<br>                plt.bar(x + i * width, scores, width, label=metric.upper())<br>            <br>            plt.xlabel(<span class="hljs-string">&#x27;模型&#x27;</span>)<br>            plt.ylabel(<span class="hljs-string">&#x27;评分&#x27;</span>)<br>            plt.title(<span class="hljs-string">&#x27;模型性能对比&#x27;</span>)<br>            plt.xticks(x + width * (<span class="hljs-built_in">len</span>(metrics_data) - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>, models, rotation=<span class="hljs-number">45</span>)<br>            plt.legend()<br>            plt.tight_layout()<br>            plt.show()<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制模型对比图失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_feature_importance</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制特征重要性图&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 设置中文字体</span><br>            plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]  <span class="hljs-comment"># 用来正常显示中文标签</span><br>            plt.rcParams[<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 用来正常显示负号</span><br>            <br>            <span class="hljs-keyword">for</span> model_name, model <span class="hljs-keyword">in</span> self.models.items():<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(model, <span class="hljs-string">&#x27;feature_importances_&#x27;</span>):<br>                    plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">6</span>))<br>                    importances = model.feature_importances_<br>                    <br>                    <span class="hljs-comment"># 确保有特征名称</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;feature_names&#x27;</span>):<br>                        features = self.feature_names<br>                    <span class="hljs-keyword">else</span>:<br>                        features = [<span class="hljs-string">f&#x27;特征_<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(importances))]<br>                        <br>                    <span class="hljs-comment"># 创建特征重要性的DataFrame</span><br>                    importance_df = pd.DataFrame(&#123;<br>                        <span class="hljs-string">&#x27;特征&#x27;</span>: features,<br>                        <span class="hljs-string">&#x27;重要性&#x27;</span>: importances<br>                    &#125;)<br>                    <br>                    <span class="hljs-comment"># 按重要性降序排序</span><br>                    importance_df = importance_df.sort_values(<span class="hljs-string">&#x27;重要性&#x27;</span>, ascending=<span class="hljs-literal">False</span>)<br>                    <br>                    <span class="hljs-comment"># 绘制条形图</span><br>                    sns.barplot(data=importance_df, x=<span class="hljs-string">&#x27;特征&#x27;</span>, y=<span class="hljs-string">&#x27;重要性&#x27;</span>)<br>                    <br>                    <span class="hljs-comment"># 设置图表样式</span><br>                    plt.xticks(rotation=<span class="hljs-number">45</span>, ha=<span class="hljs-string">&#x27;right&#x27;</span>)<br>                    plt.xlabel(<span class="hljs-string">&#x27;特征&#x27;</span>)<br>                    plt.ylabel(<span class="hljs-string">&#x27;重要性&#x27;</span>)<br>                    plt.title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;model_name&#125;</span> 特征重要性分析&#x27;</span>)<br>                    <br>                    <span class="hljs-comment"># 调整布局以防止标签被切割</span><br>                    plt.tight_layout()<br>                    plt.show()<br>                    <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制特征重要性图失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_optimization_history</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制参数优化过程图&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 设置中文字体</span><br>            plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]  <br>            plt.rcParams[<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="hljs-literal">False</span>  <br>        <br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&#x27;optimization_history&#x27;</span>):<br>                <span class="hljs-keyword">for</span> model_name, history <span class="hljs-keyword">in</span> self.optimization_history.items():<br>                    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;params&#x27;</span> <span class="hljs-keyword">in</span> history <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;scores&#x27;</span> <span class="hljs-keyword">in</span> history:<br>                        <span class="hljs-comment"># 获取所有参数名</span><br>                        param_names = <span class="hljs-built_in">list</span>(history[<span class="hljs-string">&#x27;params&#x27;</span>][<span class="hljs-number">0</span>].keys())<br>                        n_params = <span class="hljs-built_in">len</span>(param_names)<br>                        <br>                        <span class="hljs-comment"># 创建子图网格</span><br>                        n_rows = (n_params + <span class="hljs-number">1</span>) // <span class="hljs-number">2</span>  <span class="hljs-comment"># 参数图 + 得分图</span><br>                        fig, axes = plt.subplots(n_rows, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">5</span>*n_rows))<br>                        axes = axes.flatten()<br>                        <br>                        <span class="hljs-comment"># 1. 绘制总体优化得分</span><br>                        ax = axes[<span class="hljs-number">0</span>]<br>                        scores = history[<span class="hljs-string">&#x27;scores&#x27;</span>]<br>                        ax.plot(scores, marker=<span class="hljs-string">&#x27;o&#x27;</span>)<br>                        ax.set_xlabel(<span class="hljs-string">&#x27;迭代次数&#x27;</span>)<br>                        ax.set_ylabel(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;self.primary_metric&#125;</span> 分数&#x27;</span>)<br>                        ax.set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;model_name&#125;</span> 整体优化过程&#x27;</span>)<br>                        <br>                        <span class="hljs-comment"># 标注最优点</span><br>                        metric_info = self.metrics[self.primary_metric]<br>                        <span class="hljs-keyword">if</span> metric_info[<span class="hljs-string">&#x27;greater_is_better&#x27;</span>]:<br>                            best_idx = np.argmax(scores)<br>                        <span class="hljs-keyword">else</span>:<br>                            best_idx = np.argmin(scores)<br>                        ax.scatter(best_idx, scores[best_idx], <br>                                color=<span class="hljs-string">&#x27;red&#x27;</span>, s=<span class="hljs-number">100</span>, label=<span class="hljs-string">&#x27;最优点&#x27;</span>)<br>                        ax.legend()<br>                        ax.grid(<span class="hljs-literal">True</span>)<br>                        <br>                        <span class="hljs-comment"># 2. 为每个参数绘制优化轨迹</span><br>                        <span class="hljs-keyword">for</span> i, param_name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(param_names, <span class="hljs-number">1</span>):<br>                            <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(axes):  <span class="hljs-comment"># 确保有足够的子图</span><br>                                ax = axes[i]<br>                                param_values = [params[param_name] <span class="hljs-keyword">for</span> params <span class="hljs-keyword">in</span> history[<span class="hljs-string">&#x27;params&#x27;</span>]]<br>                                <br>                                <span class="hljs-comment"># 绘制参数变化</span><br>                                ax.plot(param_values, marker=<span class="hljs-string">&#x27;o&#x27;</span>)<br>                                ax.set_xlabel(<span class="hljs-string">&#x27;迭代次数&#x27;</span>)<br>                                ax.set_ylabel(param_name)<br>                                ax.set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;param_name&#125;</span> 参数变化&#x27;</span>)<br>                                <br>                                <span class="hljs-comment"># 标注最优点</span><br>                                ax.scatter(best_idx, param_values[best_idx], <br>                                        color=<span class="hljs-string">&#x27;red&#x27;</span>, s=<span class="hljs-number">100</span>, label=<span class="hljs-string">&#x27;最优值&#x27;</span>)<br>                                ax.legend()<br>                                ax.grid(<span class="hljs-literal">True</span>)<br>                        <br>                        <span class="hljs-comment"># 删除多余的子图</span><br>                        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_params + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(axes)):<br>                            fig.delaxes(axes[i])<br>                        <br>                        plt.tight_layout()<br>                        plt.show()<br>                            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制优化过程图失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>          <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_update_optimization_history</span>(<span class="hljs-params">self, model_name, params, score</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;更新优化历史记录&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> model_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.optimization_history:<br>            self.optimization_history[model_name] = &#123;<br>                <span class="hljs-string">&#x27;params&#x27;</span>: [],<br>                <span class="hljs-string">&#x27;scores&#x27;</span>: []<br>            &#125;<br>        self.optimization_history[model_name][<span class="hljs-string">&#x27;params&#x27;</span>].append(params)<br>        self.optimization_history[model_name][<span class="hljs-string">&#x27;scores&#x27;</span>].append(score)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_prediction_vs_actual</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制预测值与实际值对比图&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))<br>            <span class="hljs-keyword">for</span> model_name, pred <span class="hljs-keyword">in</span> self.train_results.items():<br>                plt.scatter(self.y_val, pred, alpha=<span class="hljs-number">0.5</span>, label=model_name)<br>            <br>            <span class="hljs-comment"># 添加对角线</span><br>            min_val = <span class="hljs-built_in">min</span>(plt.xlim()[<span class="hljs-number">0</span>], plt.ylim()[<span class="hljs-number">0</span>])<br>            max_val = <span class="hljs-built_in">max</span>(plt.xlim()[<span class="hljs-number">1</span>], plt.ylim()[<span class="hljs-number">1</span>])<br>            plt.plot([min_val, max_val], [min_val, max_val], <span class="hljs-string">&#x27;r--&#x27;</span>, label=<span class="hljs-string">&#x27;理想预测线&#x27;</span>)<br>            <br>            plt.xlabel(<span class="hljs-string">&#x27;实际值&#x27;</span>)<br>            plt.ylabel(<span class="hljs-string">&#x27;预测值&#x27;</span>)<br>            plt.title(<span class="hljs-string">&#x27;预测值 vs 实际值&#x27;</span>)<br>            plt.legend()<br>            plt.tight_layout()<br>            plt.show()<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制预测对比图失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_residual_analysis</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制残差分析图&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">for</span> model_name, pred <span class="hljs-keyword">in</span> self.train_results.items():<br>                residuals = self.y_val - pred<br>                <br>                fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">5</span>))<br>                <br>                <span class="hljs-comment"># 残差散点图</span><br>                ax1.scatter(pred, residuals, alpha=<span class="hljs-number">0.5</span>)<br>                ax1.axhline(y=<span class="hljs-number">0</span>, color=<span class="hljs-string">&#x27;r&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>)<br>                ax1.set_xlabel(<span class="hljs-string">&#x27;预测值&#x27;</span>)<br>                ax1.set_ylabel(<span class="hljs-string">&#x27;残差&#x27;</span>)<br>                ax1.set_title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;model_name&#125;</span> 残差散点图&#x27;</span>)<br>                <br>                <span class="hljs-comment"># 残差分布图</span><br>                sns.histplot(residuals, kde=<span class="hljs-literal">True</span>, ax=ax2)<br>                ax2.set_xlabel(<span class="hljs-string">&#x27;残差&#x27;</span>)<br>                ax2.set_title(<span class="hljs-string">&#x27;残差分布&#x27;</span>)<br>                <br>                plt.tight_layout()<br>                plt.show()<br>                <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制残差分析图失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_learning_curves</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制学习曲线&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> learning_curve<br><br>            <span class="hljs-comment"># 设置中文字体</span><br>            plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]  <span class="hljs-comment"># 用来正常显示中文标签</span><br>            plt.rcParams[<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 用来正常显示负号</span><br><br>            <span class="hljs-keyword">for</span> model_name, model <span class="hljs-keyword">in</span> self.models.items():<br>                <span class="hljs-keyword">try</span>:<br>                    <span class="hljs-comment"># 1. 样本数设置</span><br>                    total_samples = <span class="hljs-built_in">len</span>(self.X_train)<br>                    max_samples = <span class="hljs-built_in">min</span>(total_samples, <span class="hljs-number">10000</span>)  <span class="hljs-comment"># 限制最大样本数</span><br><br>                    <span class="hljs-comment"># 根据总样本数动态设置点数</span><br>                    n_points = <span class="hljs-number">5</span> <span class="hljs-keyword">if</span> total_samples &lt; <span class="hljs-number">10000</span> <span class="hljs-keyword">else</span> <span class="hljs-number">7</span><br>                    train_sizes = np.linspace(<span class="hljs-number">0.1</span>, <span class="hljs-number">1.0</span>, n_points)<br><br>                    <span class="hljs-comment"># 2. 交叉验证设置</span><br>                    <span class="hljs-comment"># 根据样本数动态调整折数</span><br>                    <span class="hljs-keyword">if</span> total_samples &lt; <span class="hljs-number">1000</span>:<br>                        cv_folds = <span class="hljs-number">3</span>  <span class="hljs-comment"># 小数据集用较少的折数</span><br>                    <span class="hljs-keyword">elif</span> total_samples &lt; <span class="hljs-number">10000</span>:<br>                        cv_folds = <span class="hljs-number">5</span>  <span class="hljs-comment"># 中等数据集用适中的折数</span><br>                    <span class="hljs-keyword">else</span>:<br>                        cv_folds = <span class="hljs-built_in">min</span>(<span class="hljs-number">10</span>, total_samples // <span class="hljs-number">1000</span>)  <span class="hljs-comment"># 大数据集可以用更多折数</span><br><br>                    <span class="hljs-comment"># 3. 计算学习曲线</span><br>                    train_sizes, train_scores, val_scores = learning_curve(<br>                        estimator=model,<br>                        X=self.X_train[:max_samples],  <span class="hljs-comment"># 使用限制后的样本数</span><br>                        y=self.y_train[:max_samples],<br>                        train_sizes=train_sizes,<br>                        cv=cv_folds,<br>                        n_jobs=<span class="hljs-number">1</span>,  <span class="hljs-comment"># 避免并行计算的内存问题</span><br>                        scoring=make_scorer(<br>                            self.metrics[self.primary_metric][<span class="hljs-string">&#x27;func&#x27;</span>],<br>                            greater_is_better=self.metrics[self.primary_metric][<span class="hljs-string">&#x27;greater_is_better&#x27;</span>]<br>                        ),<br>                        verbose=<span class="hljs-number">0</span><br>                    )<br><br>                    <span class="hljs-comment"># 获取 greater_is_better 标志</span><br>                    greater_is_better = self.metrics[self.primary_metric][<span class="hljs-string">&#x27;greater_is_better&#x27;</span>]<br><br>                    <span class="hljs-comment"># 根据 greater_is_better 调整分数</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> greater_is_better:<br>                        train_scores = -train_scores<br>                        val_scores = -val_scores<br><br><br>                    <span class="hljs-comment"># 计算平均值和标准差</span><br>                    train_mean = np.mean(train_scores, axis=<span class="hljs-number">1</span>)<br>                    train_std = np.std(train_scores, axis=<span class="hljs-number">1</span>)<br>                    val_mean = np.mean(val_scores, axis=<span class="hljs-number">1</span>)<br>                    val_std = np.std(val_scores, axis=<span class="hljs-number">1</span>)<br><br>                    <span class="hljs-comment"># 绘制图形</span><br>                    plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))<br><br>                    <span class="hljs-comment"># 绘制训练集得分</span><br>                    plt.plot(train_sizes, train_mean, label=<span class="hljs-string">&#x27;训练集得分&#x27;</span>,<br>                                color=<span class="hljs-string">&#x27;blue&#x27;</span>, marker=<span class="hljs-string">&#x27;o&#x27;</span>)<br>                    plt.fill_between(train_sizes,<br>                                    train_mean - train_std,<br>                                    train_mean + train_std,<br>                                    alpha=<span class="hljs-number">0.15</span>, color=<span class="hljs-string">&#x27;blue&#x27;</span>)<br><br>                    <span class="hljs-comment"># 绘制验证集得分</span><br>                    plt.plot(train_sizes, val_mean, label=<span class="hljs-string">&#x27;验证集得分&#x27;</span>,<br>                                color=<span class="hljs-string">&#x27;green&#x27;</span>, marker=<span class="hljs-string">&#x27;o&#x27;</span>)<br>                    plt.fill_between(train_sizes,<br>                                    val_mean - val_std,<br>                                    val_mean + val_std,<br>                                    alpha=<span class="hljs-number">0.15</span>, color=<span class="hljs-string">&#x27;green&#x27;</span>)<br><br>                    <span class="hljs-comment"># 设置图形属性</span><br>                    plt.xlabel(<span class="hljs-string">&#x27;训练样本数&#x27;</span>)<br>                    plt.ylabel(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;self.primary_metric.upper()&#125;</span> 得分&#x27;</span>)<br>                    plt.title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;model_name&#125;</span> 学习曲线&#x27;</span>)<br>                    plt.grid(<span class="hljs-literal">True</span>)<br>                    plt.legend(loc=<span class="hljs-string">&#x27;lower right&#x27;</span>)<br><br>                    <span class="hljs-comment"># 添加当前性能指标</span><br>                    current_score = self.model_scores[model_name].get(self.primary_metric)<br>                    <span class="hljs-keyword">if</span> current_score <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                        plt.axhline(y=current_score, color=<span class="hljs-string">&#x27;r&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>,<br>                                        label=<span class="hljs-string">f&#x27;当前性能: <span class="hljs-subst">&#123;current_score:<span class="hljs-number">.4</span>f&#125;</span>&#x27;</span>)<br>                        plt.legend()<br><br>                    plt.tight_layout()<br>                    plt.show()<br><br>                    <span class="hljs-comment"># 清理内存</span><br>                    plt.close()<br>                    gc.collect()<br><br>                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> model_error:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 模型 <span class="hljs-subst">&#123;model_name&#125;</span> 的学习曲线绘制失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(model_error)&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;样本总数: <span class="hljs-subst">&#123;total_samples&#125;</span>, 使用样本数: <span class="hljs-subst">&#123;max_samples&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;交叉验证折数: <span class="hljs-subst">&#123;cv_folds&#125;</span>&quot;</span>)<br>                    <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制学习曲线失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_cross_validation_scores</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制交叉验证得分分布&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))<br>            scores_data = []<br>            labels = []<br>            <br>            <span class="hljs-keyword">for</span> model_name <span class="hljs-keyword">in</span> self.model_scores:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(self.model_scores[model_name], <span class="hljs-built_in">dict</span>):<br>                    <span class="hljs-keyword">for</span> metric, score <span class="hljs-keyword">in</span> self.model_scores[model_name].items():<br>                        <span class="hljs-keyword">if</span> metric != <span class="hljs-string">&#x27;model&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(score, (<span class="hljs-built_in">int</span>, <span class="hljs-built_in">float</span>)):  <span class="hljs-comment"># 确保score是数值</span><br>                            scores_data.append([score])  <span class="hljs-comment"># 将单个分数包装成列表</span><br>                            labels.append(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;model_name&#125;</span>-<span class="hljs-subst">&#123;metric&#125;</span>&#x27;</span>)<br>            <br>            <span class="hljs-keyword">if</span> scores_data:  <span class="hljs-comment"># 确保有数据要绘制</span><br>                plt.boxplot(scores_data, labels=labels)<br>                plt.xticks(rotation=<span class="hljs-number">45</span>)<br>                plt.ylabel(<span class="hljs-string">&#x27;得分&#x27;</span>)<br>                plt.title(<span class="hljs-string">&#x27;交叉验证得分分布&#x27;</span>)<br>                plt.tight_layout()<br>                plt.show()<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;没有有效的分数数据用于绘图&quot;</span>)<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制交叉验证得分分布图失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_correlation_matrix</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制特征相关性矩阵&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            corr_matrix = pd.DataFrame(self.X_train).corr()<br>            <br>            plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))<br>            sns.heatmap(corr_matrix, <br>                       annot=<span class="hljs-literal">True</span>, <br>                       cmap=<span class="hljs-string">&#x27;coolwarm&#x27;</span>, <br>                       center=<span class="hljs-number">0</span>,<br>                       fmt=<span class="hljs-string">&#x27;.2f&#x27;</span>)<br>            plt.title(<span class="hljs-string">&#x27;特征相关性矩阵&#x27;</span>)<br>            plt.tight_layout()<br>            plt.show()<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制相关性矩阵失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_plot_error_distribution</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制预测误差分布&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">6</span>))<br>            <span class="hljs-keyword">for</span> model_name, pred <span class="hljs-keyword">in</span> self.train_results.items():<br>                errors = np.<span class="hljs-built_in">abs</span>(self.y_val - pred)<br>                sns.kdeplot(errors, label=model_name)<br>                <br>            plt.xlabel(<span class="hljs-string">&#x27;绝对误差&#x27;</span>)<br>            plt.ylabel(<span class="hljs-string">&#x27;密度&#x27;</span>)<br>            plt.title(<span class="hljs-string">&#x27;预测误差分布&#x27;</span>)<br>            plt.legend()<br>            plt.show()<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;绘制误差分布图失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br><br><br><span class="hljs-comment">####################################################################################################################</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">grid_search_optimizer</span>(<span class="hljs-params">model, param_grid, X_train, y_train, cv, scoring_func, greater_is_better, callback=<span class="hljs-literal">None</span></span>):<br>    <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        网格搜索参数优化</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - scoring_func: 评价指标函数</span><br><span class="hljs-string">        - greater_is_better: 是否越大越好</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 1. 验证输入数据</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(X_train) &lt; cv.n_splits * <span class="hljs-number">2</span>:  <span class="hljs-comment"># 确保每折至少有2个样本</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;警告: 样本量过少(<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(X_train)&#125;</span>)，使用默认参数训练&quot;</span>)<br>                model.fit(X_train, y_train)<br>                <span class="hljs-keyword">return</span> model<br>                <br>            <span class="hljs-comment"># 2. 调整交叉验证参数</span><br>            n_splits = <span class="hljs-built_in">min</span>(cv.n_splits, <span class="hljs-built_in">len</span>(X_train) // <span class="hljs-number">3</span>)  <span class="hljs-comment"># 确保每折至少有3个样本</span><br>            cv.n_splits = n_splits<br>            <br>            <span class="hljs-comment"># 3. 执行网格搜索</span><br>            gsearch = GridSearchCV(<br>                model, <br>                param_grid, <br>                cv=cv,<br>                scoring=make_scorer(scoring_func, greater_is_better=greater_is_better),<br>                verbose=-<span class="hljs-number">1</span>,<br>                return_train_score=<span class="hljs-literal">True</span>,<br>                error_score=<span class="hljs-string">&#x27;raise&#x27;</span><br>            )<br>            <br>            <span class="hljs-comment"># 4. 训练模型</span><br>            gsearch.fit(X_train, y_train)<br>            <br>            <span class="hljs-comment"># 记录优化过程</span><br>            <span class="hljs-keyword">if</span> callback <span class="hljs-keyword">and</span> <span class="hljs-built_in">hasattr</span>(model, <span class="hljs-string">&#x27;__class__&#x27;</span>):<br>                model_name = model.__class__.__name__<br>                <span class="hljs-keyword">for</span> i, params <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(gsearch.cv_results_[<span class="hljs-string">&#x27;params&#x27;</span>]):<br>                    mean_score = <span class="hljs-built_in">abs</span>(gsearch.cv_results_[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>][i]) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> greater_is_better <span class="hljs-keyword">else</span> gsearch.cv_results_[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>][i]<br>                    callback(model_name, params, mean_score)<br>            <br><br>            <span class="hljs-comment"># 5. 输出优化结果时转换分数</span><br>            <span class="hljs-comment"># 注意：当greater_is_better=False时（对于RMSLE这种越小越好的指标），scikit-learn会自动将分数取负数，若不取绝对值则直接输出gsearch.best_score_时为负值</span><br>            metric_name = scoring_func.__name__.upper()<br>            best_score = <span class="hljs-built_in">abs</span>(gsearch.best_score_) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> greater_is_better <span class="hljs-keyword">else</span> gsearch.best_score_<br>            mean_score = <span class="hljs-built_in">abs</span>(np.mean(gsearch.cv_results_[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>])) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> greater_is_better <span class="hljs-keyword">else</span> np.mean(gsearch.cv_results_[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>])<br>            <br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;网格搜索结果:&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 最佳参数：<span class="hljs-subst">&#123;gsearch.best_params_&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 最佳<span class="hljs-subst">&#123;metric_name&#125;</span>得分：<span class="hljs-subst">&#123;best_score:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 验证集平均得分：<span class="hljs-subst">&#123;mean_score:<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;- 验证集标准差：<span class="hljs-subst">&#123;np.mean(gsearch.cv_results_[<span class="hljs-string">&#x27;std_test_score&#x27;</span>]):<span class="hljs-number">.4</span>f&#125;</span>&quot;</span>)<br><br><br>            <span class="hljs-keyword">return</span> gsearch.best_estimator_<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;网格搜索参数优化失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;使用默认参数训练模型&quot;</span>)<br>            model.fit(X_train, y_train)<br>            <span class="hljs-keyword">return</span> model<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_and_evaluate_with_cv</span>(<span class="hljs-params">pipeline, data, splitter, n_splits=<span class="hljs-number">5</span>, target_col=<span class="hljs-string">&#x27;count&#x27;</span>, param_grids=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        使用交叉验证训练和评估模型。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - pipeline: 模型训练管道实例</span><br><span class="hljs-string">        - data: 数据集</span><br><span class="hljs-string">        - splitter: 数据分割器实例</span><br><span class="hljs-string">        - n_splits: 交叉验证折数</span><br><span class="hljs-string">        - target_col: 目标列名</span><br><span class="hljs-string">        - param_grids: 超参数网格字典</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 1. 参数验证</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) &lt; n_splits * <span class="hljs-number">3</span>:<br>                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;数据量(<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data)&#125;</span>)不足以进行<span class="hljs-subst">&#123;n_splits&#125;</span>折交叉验证&quot;</span>)<br>                <br>            <span class="hljs-comment"># 2. 获取交叉验证迭代器</span><br>            cv = splitter.get_cv(<br>                data, <br>                n_splits=<span class="hljs-built_in">min</span>(n_splits, <span class="hljs-built_in">len</span>(data) // <span class="hljs-number">3</span>),<br>                target_col=target_col<br>            )<br>            <br>            <span class="hljs-comment"># 3. 执行交叉验证</span><br>            fold_scores = []<br>            <span class="hljs-keyword">for</span> fold_idx, (train_idx, val_idx) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(cv.split(data)):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n\n执行第 <span class="hljs-subst">&#123;fold_idx + <span class="hljs-number">1</span>&#125;</span> 折交叉验证&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;训练集大小: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(train_idx)&#125;</span>, 验证集大小: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(val_idx)&#125;</span>&quot;</span>)<br>                <br>                <span class="hljs-comment"># 获取当前折数据</span><br>                fold_train = data.iloc[train_idx]<br>                fold_val = data.iloc[val_idx]<br>                <br>                <span class="hljs-comment"># 分割特征和目标</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(splitter, TimeSeriesSplitter):<br>                    fold_X_train, fold_X_val, fold_y_train, fold_y_val = splitter.split(<br>                        fold_train, target_col=target_col<br>                    )<br>                <span class="hljs-keyword">else</span>:<br>                    fold_X_train = fold_train.drop(target_col, axis=<span class="hljs-number">1</span>)<br>                    fold_y_train = fold_train[target_col]<br>                    fold_X_val = fold_val.drop(target_col, axis=<span class="hljs-number">1</span>)<br>                    fold_y_val = fold_val[target_col]<br>                <br>                <span class="hljs-comment"># 训练和评估</span><br>                fold_model_scores = pipeline.train_and_evaluate(<br>                    fold_X_train, fold_y_train,<br>                    fold_X_val, fold_y_val,<br>                    param_grids, cv<br>                )<br>                <br>                fold_scores.append(fold_model_scores)<br>                <br>            <span class="hljs-keyword">return</span> fold_scores<br>            <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;交叉验证训练失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1. 初始化工厂类</span><br>model_factory = ModelFactory()<br><br><span class="hljs-comment"># 基础模型</span><br>model_factory.register_model(<span class="hljs-string">&#x27;ridge&#x27;</span>, Ridge)  <br><br><span class="hljs-comment"># 树模型（主力）</span><br>model_factory.register_model(<span class="hljs-string">&#x27;gbdt&#x27;</span>, GradientBoostingRegressor)  <span class="hljs-comment"># 处理非线性关系</span><br>model_factory.register_model(<span class="hljs-string">&#x27;xgb&#x27;</span>, xgb.XGBRegressor)  <span class="hljs-comment"># 强大的非线性建模能力</span><br>model_factory.register_model(<span class="hljs-string">&#x27;lgb&#x27;</span>, lgb.LGBMRegressor)  <span class="hljs-comment"># 高效处理大规模数据</span><br>model_factory.register_model(<span class="hljs-string">&#x27;rf&#x27;</span>, RandomForestRegressor)  <span class="hljs-comment"># 良好的泛化能力</span><br><br><br><span class="hljs-comment"># 2. 创建数据分割器</span><br>splitter_factory = DataSplitterFactory()<br>splitter_factory.register_splitter(<span class="hljs-string">&#x27;time_series&#x27;</span>, TimeSeriesSplitter)<br>splitter_factory.register_splitter(<span class="hljs-string">&#x27;regression&#x27;</span>, RegressionSplitter)<br>splitter_factory.register_splitter(<span class="hljs-string">&#x27;classification&#x27;</span>, ClassificationSplitter)<br><br><span class="hljs-comment"># 创建meta_model(可以使用任何回归模型)</span><br>meta_model = Ridge(alpha=<span class="hljs-number">1.0</span>)<br><span class="hljs-comment">#推荐方案：LightGBM（平衡方案，在基础模型中表现最佳）</span><br><span class="hljs-comment"># meta_model = lgb.LGBMRegressor(</span><br><span class="hljs-comment">#     # 基础参数</span><br><span class="hljs-comment">#     n_estimators=1000,         # 增加树的数量以提高性能</span><br><span class="hljs-comment">#     max_depth=12,              # 较大的树深度，根据基础模型最佳参数</span><br><span class="hljs-comment">#     learning_rate=0.05,        # 中等学习率，平衡稳定性和性能</span><br>    <br><span class="hljs-comment">#     # 防止过拟合的参数</span><br><span class="hljs-comment">#     min_child_samples=20,      # 每个叶子节点最少样本数</span><br><span class="hljs-comment">#     min_split_gain=1e-3,       # 最小分裂增益</span><br><span class="hljs-comment">#     subsample=0.8,             # 样本采样比例</span><br><span class="hljs-comment">#     colsample_bytree=0.8,      # 特征采样比例</span><br><span class="hljs-comment">#     num_leaves=15,             # 叶子节点数量，根据基础模型最佳参数</span><br>    <br><span class="hljs-comment">#     # 其他优化参数</span><br><span class="hljs-comment">#     n_jobs=-1,                 # 使用所有CPU核心</span><br><span class="hljs-comment">#     verbosity=-1,              # 禁用警告输出</span><br><span class="hljs-comment">#     force_col_wise=True        # 避免自动选择线程方式的警告</span><br><span class="hljs-comment"># )</span><br><br><span class="hljs-comment"># 3. 初始化模型训练管道</span><br>pipeline = ModelTrainingPipeline(<br>    model_factory, <br>    param_optimizer=grid_search_optimizer, <br>    metrics=[<span class="hljs-string">&#x27;rmse&#x27;</span>, <span class="hljs-string">&#x27;rmsle&#x27;</span>, <span class="hljs-string">&#x27;r2&#x27;</span>],  <span class="hljs-comment"># 使用这些评价指标</span><br>    primary_metric=<span class="hljs-string">&#x27;rmsle&#x27;</span>,  <span class="hljs-comment"># Kaggle比赛使用RMSLE</span><br>    meta_model=meta_model<br>)  <br><br><span class="hljs-comment"># 4. 注册模型（设置初始参数）</span><br>pipeline.register_model(<span class="hljs-string">&#x27;ridge&#x27;</span>, <span class="hljs-string">&#x27;ridge&#x27;</span>, alpha=<span class="hljs-number">1.0</span>)<br>pipeline.register_model(<span class="hljs-string">&#x27;gbdt&#x27;</span>, <span class="hljs-string">&#x27;gbdt&#x27;</span>, <br>                       n_estimators=<span class="hljs-number">100</span>,            <span class="hljs-comment"># 树的数量。</span><br>                       max_depth=<span class="hljs-number">5</span>,<br>                       learning_rate=<span class="hljs-number">0.1</span>,<br>                       verbose=<span class="hljs-number">0</span>)<br>pipeline.register_model(<span class="hljs-string">&#x27;xgb&#x27;</span>, <span class="hljs-string">&#x27;xgb&#x27;</span>,<br>                       n_estimators=<span class="hljs-number">100</span>,<br>                       max_depth=<span class="hljs-number">5</span>,<br>                       learning_rate=<span class="hljs-number">0.1</span>,<br>                       objective=<span class="hljs-string">&#x27;reg:squarederror&#x27;</span>,<br>                       verbosity=<span class="hljs-number">0</span>,                 <span class="hljs-comment"># xgb使用verbosity替代verbose</span><br>                       n_jobs=-<span class="hljs-number">1</span>)                   <span class="hljs-comment"># 使用所有CPU核心)</span><br>pipeline.register_model(<span class="hljs-string">&#x27;lgb&#x27;</span>, <span class="hljs-string">&#x27;lgb&#x27;</span>,<br>                       n_estimators=<span class="hljs-number">100</span>,<br>                       max_depth=<span class="hljs-number">5</span>,<br>                       learning_rate=<span class="hljs-number">0.1</span>,<br>                       <span class="hljs-comment"># 其他优化参数</span><br>                       min_child_samples=<span class="hljs-number">20</span>,     <span class="hljs-comment"># 每个叶子节点最少样本数-控制过拟合</span><br>                       min_split_gain=<span class="hljs-number">1e-3</span>,      <span class="hljs-comment"># 最小分裂增益-控制过拟合</span><br>                       subsample=<span class="hljs-number">0.8</span>,            <span class="hljs-comment"># 样本采样比例-增加随机性</span><br>                       colsample_bytree=<span class="hljs-number">0.8</span>,     <span class="hljs-comment"># 特征采样比例-增加随机性</span><br>                       verbosity=-<span class="hljs-number">1</span>,             <span class="hljs-comment"># 禁用警告输出</span><br>                       force_col_wise=<span class="hljs-literal">True</span>,      <span class="hljs-comment"># 避免自动选择线程方式的警告</span><br>                       n_jobs=-<span class="hljs-number">1</span>)<br>pipeline.register_model(<span class="hljs-string">&#x27;rf&#x27;</span>, <span class="hljs-string">&#x27;rf&#x27;</span>,<br>                       n_estimators=<span class="hljs-number">100</span>,<br>                       max_depth=<span class="hljs-number">10</span>,<br>                       verbose=<span class="hljs-number">0</span>,<br>                       n_jobs=-<span class="hljs-number">1</span>,<br>                       warm_start=<span class="hljs-literal">True</span><br>                       )    <br><br><br><span class="hljs-comment"># 5. 定义超参数网格</span><br>param_grids = &#123;<br>    <span class="hljs-string">&#x27;ridge&#x27;</span>: &#123;<span class="hljs-string">&#x27;alpha&#x27;</span>: np.logspace(-<span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">20</span>)&#125;,  <span class="hljs-comment"># 生成一个从 10^-5 到 10^1 的等比数列，包含 20 个元素</span><br>    <span class="hljs-string">&#x27;gbdt&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;n_estimators&#x27;</span>: [<span class="hljs-number">800</span>, <span class="hljs-number">1000</span>],  <span class="hljs-comment"># 增加树的数量</span><br>        <span class="hljs-string">&#x27;max_depth&#x27;</span>: [<span class="hljs-number">8</span>,<span class="hljs-number">10</span>],         <span class="hljs-comment"># 增加树的深度</span><br>        <span class="hljs-string">&#x27;learning_rate&#x27;</span>: [<span class="hljs-number">0.03</span>,<span class="hljs-number">0.05</span>], <br>        <span class="hljs-string">&#x27;min_samples_split&#x27;</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">8</span>],     <span class="hljs-comment"># 降低分裂阈值</span><br>        <span class="hljs-string">&#x27;subsample&#x27;</span>: [<span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>]      <span class="hljs-comment"># 增加采样比例</span><br>    &#125;,<br>    <span class="hljs-string">&#x27;xgb&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;n_estimators&#x27;</span>: [<span class="hljs-number">500</span>, <span class="hljs-number">800</span>],<br>        <span class="hljs-string">&#x27;max_depth&#x27;</span>: [<span class="hljs-number">10</span>,<span class="hljs-number">15</span>,<span class="hljs-number">17</span>],<br>        <span class="hljs-string">&#x27;learning_rate&#x27;</span>: [<span class="hljs-number">0.01</span>,<span class="hljs-number">0.03</span>, <span class="hljs-number">0.1</span>],<br>        <span class="hljs-string">&#x27;min_child_weight&#x27;</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">8</span>,<span class="hljs-number">10</span>],<br>        <span class="hljs-string">&#x27;reg_alpha&#x27;</span>: [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>,<span class="hljs-number">0.5</span>],        <span class="hljs-comment"># 减小L1正则化</span><br>        <span class="hljs-string">&#x27;reg_lambda&#x27;</span>: [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>,<span class="hljs-number">0.5</span>]       <span class="hljs-comment"># 减小L2正则化</span><br>    &#125;,<br>    <span class="hljs-string">&#x27;lgb&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;n_estimators&#x27;</span>: [<span class="hljs-number">1000</span>, <span class="hljs-number">1500</span>],<br>        <span class="hljs-string">&#x27;max_depth&#x27;</span>: [<span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>],<br>        <span class="hljs-string">&#x27;learning_rate&#x27;</span>: [<span class="hljs-number">0.03</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.08</span>],<br>        <span class="hljs-string">&#x27;num_leaves&#x27;</span>: [<span class="hljs-number">15</span>, <span class="hljs-number">20</span>, <span class="hljs-number">31</span>] <br>    &#125;,<br>    <span class="hljs-string">&#x27;rf&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;n_estimators&#x27;</span>: [<span class="hljs-number">800</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1200</span>],<br>        <span class="hljs-string">&#x27;max_depth&#x27;</span>: [<span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>],<br>        <span class="hljs-string">&#x27;min_samples_split&#x27;</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>]<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment"># 6. 选择数据分割器和分割数据</span><br>data_splitter = splitter_factory.create_splitter(<span class="hljs-string">&#x27;time_series&#x27;</span>, test_size=<span class="hljs-number">0.1</span>)<br><span class="hljs-comment"># data_splitter = splitter_factory.create_splitter(&#x27;regression&#x27;, test_size=0.2, random_state = 42)</span><br><br><span class="hljs-comment"># 7. 进行交叉验证和训练</span><br><span class="hljs-comment">#fold_scores = train_and_evaluate_with_cv(pipeline, train_data, data_splitter, n_splits=3, target_col=&#x27;count&#x27;,param_grids=param_grids)</span><br>fold_scores = train_and_evaluate_with_cv(pipeline, train_data, data_splitter, n_splits=<span class="hljs-number">3</span>, target_col=<span class="hljs-string">&#x27;count&#x27;</span>)<br><span class="hljs-comment">#--------------------启动可视化-----------------------</span><br><span class="hljs-comment"># 1. 获取特征名称（需要在数据分割后执行）</span><br><span class="hljs-keyword">try</span>:<br>    X_train, X_val, y_train, y_val = data_splitter.split(train_data, target_col=<span class="hljs-string">&#x27;count&#x27;</span>)<br>    pipeline.feature_names = X_train.columns.tolist()<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;获取特征名称失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># 2. 执行综合可视化（包含所有可视化内容）</span><br><span class="hljs-comment">#pipeline.visualize_training()</span><br><br><span class="hljs-comment"># 3. 或者单独使用某个可视化功能</span><br><span class="hljs-comment"># pipeline._plot_model_comparison()# 查看模型性能对比</span><br><span class="hljs-comment"># pipeline._plot_feature_importance()# 查看特征重要性</span><br><span class="hljs-comment"># pipeline._plot_optimization_history()# 查看参数优化过程</span><br>pipeline._plot_prediction_vs_actual()  <span class="hljs-comment"># 预测值与实际值对比</span><br><span class="hljs-comment"># pipeline._plot_residual_analysis()     # 残差分析</span><br>pipeline._plot_learning_curves()       <span class="hljs-comment"># 学习曲线</span><br><span class="hljs-comment"># pipeline._plot_cross_validation_scores()  # 交叉验证得分分布</span><br><span class="hljs-comment"># pipeline._plot_correlation_matrix()     # 特征相关性矩阵</span><br>pipeline._plot_error_distribution()     <span class="hljs-comment"># 预测误差分布</span><br></code></pre></td></tr></table></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_120_1.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_120_2.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_120_3.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_120_4.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_120_5.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_120_6.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><figure><img src="/img/EDA-stacking_files/EDA-stacking_120_7.png" srcset="/img/loading.gif" lazyload alt="png"><figcaption aria-hidden="true">png</figcaption></figure><p><strong>学习曲线解读：</strong></p><ul><li><p><strong>三条线:</strong></p><ol type="1"><li><p><strong>蓝色实线 (训练集得分):</strong> 表示模型在不同数量的训练数据上的平均性能。每个蓝色的点代表使用特定数量的训练样本训练模型后，在<em>训练集本身</em>上的平均 RMSLE 得分。通常，训练集得分会随着训练样本数的增加而变得更好（或保持不变），因为模型在见过的训练数据上表现通常会更好。</p></li><li><p><strong>绿色实线 (验证集得分):</strong> 表示模型在不同数量的训练数据上的交叉验证性能。每个绿色的点代表使用特定数量的训练样本训练模型后，在<em>验证集</em>（未用于训练的数据）上的平均 RMSLE 得分。这是对模型泛化能力（对未见数据的预测能力）的更可靠的估计。</p></li><li><p><strong>红色虚线 (当前性能):</strong> 表示模型在整个数据集上评估得到的当前性能（RMSLE 得分）。这条线提供了一个参考，用于比较不同训练样本数量下的模型性能与当前模型性能。</p></li></ol></li><li><p><strong>阴影区域:</strong></p><ul><li>蓝色阴影区域表示训练得分的标准差。</li><li>绿色阴影区域表示验证得分的标准差。</li></ul><p>标准差反映了模型性能在不同交叉验证折叠（或不同随机种子）上的波动程度。阴影区域越大，表示模型性能的波动越大，可能存在不稳定性或过拟合。</p></li></ul><p><strong>如何通过学习曲线诊断模型问题：</strong></p><ol type="1"><li><p><strong>高偏差 (欠拟合):</strong></p><ul><li>如果训练集得分和验证集得分都很差，并且两条曲线都收敛到一个较低的水平（即，得分都不理想，且随着训练样本数增加，得分不再显著提高），则模型可能存在高偏差（欠拟合）。</li><li>这意味着模型过于简单，无法捕捉数据中的复杂模式。</li><li><strong>解决办法:</strong> 尝试更复杂的模型、增加特征、减少正则化等。</li></ul></li><li><p><strong>高方差 (过拟合):</strong></p><ul><li>如果训练集得分很好，但验证集得分较差，并且两条曲线之间存在较大差距，则模型可能存在高方差（过拟合）。</li><li>这意味着模型过于复杂，过度拟合了训练数据中的噪声，导致泛化能力差。</li><li><strong>解决办法:</strong> 增加训练数据、使用更简单的模型、增加正则化、特征选择等。</li></ul></li><li><p><strong>理想情况:</strong></p><ul><li>训练集得分和验证集得分都很好，并且两条曲线都收敛到一个较高的水平，且差距较小。</li><li>这意味着模型既能很好地拟合训练数据，又能很好地泛化到未见数据。</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 预测并保存结果</span><br>stacking_predictions = pipeline.predict(submit_data, method=<span class="hljs-string">&#x27;stacking&#x27;</span>)<br><span class="hljs-keyword">if</span> stacking_predictions <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-comment"># 确保预测结果为一维数组</span><br>    <span class="hljs-keyword">if</span> stacking_predictions.ndim &gt; <span class="hljs-number">1</span>:<br>        stacking_predictions = stacking_predictions.ravel()<br>    <br>    <span class="hljs-comment"># 还原预测结果</span><br>    restored_predictions = normalizer.restore_predictions(<br>        stacking_predictions, <br>        source_column=<span class="hljs-string">&#x27;count&#x27;</span><br>    )<br>    <br>    final_predictions = transformer.inverse_transform(restored_predictions)<br>    <br>    <span class="hljs-comment"># 保存结果</span><br>    submission = pd.DataFrame(&#123;<br>        <span class="hljs-string">&#x27;datetime&#x27;</span>: pd.read_csv(<span class="hljs-string">&quot;./data/test.csv&quot;</span>)[<span class="hljs-string">&#x27;datetime&#x27;</span>],<br>        <span class="hljs-string">&#x27;count&#x27;</span>: final_predictions<br>    &#125;)<br>    timestamp = datetime.now().strftime(<span class="hljs-string">&#x27;%Y%m%d_%H%M&#x27;</span>)  <br>    filename = <span class="hljs-string">f&#x27;./output/submission_<span class="hljs-subst">&#123;timestamp&#125;</span>.csv&#x27;</span> <br>    submission.to_csv(filename, index=<span class="hljs-literal">False</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;预测结果已保存至 <span class="hljs-subst">&#123;filename&#125;</span>&quot;</span>) <br><br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;预测失败，请检查错误信息&quot;</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">预测结果已保存至 ./output/submission_20250225_1047.csv</code></pre></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8/" class="category-chain-item">机器学习实战入门</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">#机器学习</a></div></div><div class="license-box my-3"><div class="license-title"><div>基于集成模型的共享单车需求预测</div><div>https://zhou1317fe5.github.io/2025/03/02/基于集成模型的共享单车需求预测/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Zhou1317fe5</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2025年3月2日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2025/03/02/FastGPT-API%E6%96%87%E4%BB%B6%E5%BA%93%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/" title="FastGPT-API文件库接口开发文档"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">FastGPT-API文件库接口开发文档</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/02/26/%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB-%E7%94%B5%E5%BD%B1%E8%AF%84%E8%AE%BA%E6%83%85%E6%84%9F%E5%88%86%E6%9E%90/" title="文本分类-电影评论情感分析"><span class="hidden-mobile">文本分类-电影评论情感分析</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script>window.MathJax?(MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset(),MathJax.typesetPromise()):window.MathJax={tex:{inlineMath:{"[+]":[["$","$"]]}},loader:{load:["ui/lazy"]},options:{renderActions:{insertedScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(t=>{let e=t.parentNode;"li"===e.nodeName.toLowerCase()&&e.parentNode.classList.add("has-jax")})},"",!1]}}},Fluid.events.registerRefreshCallback((function(){"MathJax"in window&&MathJax.startup.document&&"function"==typeof MathJax.startup.document.state&&(MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset(),MathJax.typesetPromise())}))</script><script src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>