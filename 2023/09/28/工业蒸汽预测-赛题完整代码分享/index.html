<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Zhou1317fe5"><meta name="keywords" content=""><meta name="description" content="12345678910111213141516171819import warningswarnings.filterwarnings(&quot;ignore&quot;)import matplotlib.pyplot as pltplt.rcParams.update(&amp;#123;&amp;#x27;figure.max_open_warning&amp;#x27;: 0&amp;#125;)import seab"><meta property="og:type" content="article"><meta property="og:title" content="工业蒸汽预测-赛题完整代码分享"><meta property="og:url" content="http://zhou1317fe5.link/2023/09/28/%E5%B7%A5%E4%B8%9A%E8%92%B8%E6%B1%BD%E9%A2%84%E6%B5%8B-%E8%B5%9B%E9%A2%98%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E5%88%86%E4%BA%AB/index.html"><meta property="og:site_name" content="Zhou1317fe5"><meta property="og:description" content="12345678910111213141516171819import warningswarnings.filterwarnings(&quot;ignore&quot;)import matplotlib.pyplot as pltplt.rcParams.update(&amp;#123;&amp;#x27;figure.max_open_warning&amp;#x27;: 0&amp;#125;)import seab"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-09-28T08:18:33.000Z"><meta property="article:modified_time" content="2023-09-28T08:47:38.526Z"><meta property="article:author" content="Zhou1317fe5"><meta property="article:tag" content="机器学习"><meta name="twitter:card" content="summary_large_image"><meta name="referrer" content="no-referrer-when-downgrade"><title>工业蒸汽预测-赛题完整代码分享 - Zhou1317fe5</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/iconfont_csdn/iconfont.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"zhou1317fe5.link",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Zhou1317fe5</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/Post_banner_img.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="工业蒸汽预测-赛题完整代码分享"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-09-28 16:18" pubdate>2023年9月28日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 22k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 182 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">工业蒸汽预测-赛题完整代码分享</h1><div class="markdown-body"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> warnings<br>warnings.filterwarnings(<span class="hljs-string">&quot;ignore&quot;</span>)<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br>plt.rcParams.update(&#123;<span class="hljs-string">&#x27;figure.max_open_warning&#x27;</span>: <span class="hljs-number">0</span>&#125;)<br><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns<br><br><span class="hljs-comment"># modelling</span><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats<br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<br><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> GridSearchCV, RepeatedKFold, cross_val_score,cross_val_predict,KFold<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> make_scorer,mean_squared_error<br><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Lasso, Ridge, ElasticNet<br><span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> LinearSVR, SVR<br><span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsRegressor<br><span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestRegressor, GradientBoostingRegressor,AdaBoostRegressor<br><span class="hljs-keyword">from</span> xgboost <span class="hljs-keyword">import</span> XGBRegressor<br><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> PolynomialFeatures,MinMaxScaler,StandardScaler<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#load_dataset</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/kaggle/input/industrial-steam/zhengqi_train.txt&quot;</span>)  <span class="hljs-keyword">as</span> fr: <span class="hljs-comment"># /kaggle/input/industrial-steam/zhengqi_train.txt</span><br>    data_train=pd.read_table(fr,sep=<span class="hljs-string">&quot;\t&quot;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/kaggle/input/industrial-steam/zhengqi_test.txt&quot;</span>) <span class="hljs-keyword">as</span> fr_test:<br>    data_test=pd.read_table(fr_test,sep=<span class="hljs-string">&quot;\t&quot;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#merge train_set and test_set</span><br>data_train[<span class="hljs-string">&quot;oringin&quot;</span>]=<span class="hljs-string">&quot;train&quot;</span><br>data_test[<span class="hljs-string">&quot;oringin&quot;</span>]=<span class="hljs-string">&quot;test&quot;</span><br>data_all=pd.concat([data_train,data_test],axis=<span class="hljs-number">0</span>,ignore_index=<span class="hljs-literal">True</span>)<br><span class="hljs-comment">#View data</span><br>data_all.head()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Explore feature distibution </span><br><span class="hljs-comment">#fig = plt.figure(figsize=(6, 6))</span><br><span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> data_all.columns[<span class="hljs-number">0</span>:-<span class="hljs-number">2</span>]:<br>    g = sns.kdeplot(data_all[column][(data_all[<span class="hljs-string">&quot;oringin&quot;</span>] == <span class="hljs-string">&quot;train&quot;</span>)], color=<span class="hljs-string">&quot;Red&quot;</span>, shade = <span class="hljs-literal">True</span>)<br>    g = sns.kdeplot(data_all[column][(data_all[<span class="hljs-string">&quot;oringin&quot;</span>] == <span class="hljs-string">&quot;test&quot;</span>)], ax =g, color=<span class="hljs-string">&quot;Blue&quot;</span>, shade= <span class="hljs-literal">True</span>)<br>    g.set_xlabel(column)<br>    g.set_ylabel(<span class="hljs-string">&quot;Frequency&quot;</span>)<br>    g = g.legend([<span class="hljs-string">&quot;train&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>])<br>    plt.show()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data_all.columns)-<span class="hljs-number">2</span>):<br>    g = sns.FacetGrid(data_all, col=<span class="hljs-string">&#x27;oringin&#x27;</span>)<br>    g = g.<span class="hljs-built_in">map</span>(sns.distplot, data_all.columns[i])<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#删除特征&quot;V5&quot;,&quot;V9&quot;,&quot;V11&quot;,&quot;V17&quot;,&quot;V22&quot;,&quot;V28&quot;，训练集和测试集分布不均</span><br><span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;V5&quot;</span>,<span class="hljs-string">&quot;V9&quot;</span>,<span class="hljs-string">&quot;V11&quot;</span>,<span class="hljs-string">&quot;V17&quot;</span>,<span class="hljs-string">&quot;V22&quot;</span>,<span class="hljs-string">&quot;V28&quot;</span>]:<br>    g = sns.kdeplot(data_all[column][(data_all[<span class="hljs-string">&quot;oringin&quot;</span>] == <span class="hljs-string">&quot;train&quot;</span>)], color=<span class="hljs-string">&quot;Red&quot;</span>, shade = <span class="hljs-literal">True</span>)<br>    g = sns.kdeplot(data_all[column][(data_all[<span class="hljs-string">&quot;oringin&quot;</span>] == <span class="hljs-string">&quot;test&quot;</span>)], ax =g, color=<span class="hljs-string">&quot;Blue&quot;</span>, shade= <span class="hljs-literal">True</span>)<br>    g.set_xlabel(column)<br>    g.set_ylabel(<span class="hljs-string">&quot;Frequency&quot;</span>)<br>    g = g.legend([<span class="hljs-string">&quot;train&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>])<br>    plt.show()<br><br>data_all.drop([<span class="hljs-string">&quot;V5&quot;</span>,<span class="hljs-string">&quot;V9&quot;</span>,<span class="hljs-string">&quot;V11&quot;</span>,<span class="hljs-string">&quot;V17&quot;</span>,<span class="hljs-string">&quot;V22&quot;</span>,<span class="hljs-string">&quot;V28&quot;</span>],axis=<span class="hljs-number">1</span>,inplace=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># figure parameters</span><br>data_train1=data_all[data_all[<span class="hljs-string">&quot;oringin&quot;</span>]==<span class="hljs-string">&quot;train&quot;</span>].drop(<span class="hljs-string">&quot;oringin&quot;</span>,axis=<span class="hljs-number">1</span>)<br><br>fcols = <span class="hljs-number">2</span><br>frows = <span class="hljs-built_in">len</span>(data_train.columns)<br>plt.figure(figsize=(<span class="hljs-number">5</span>*fcols,<span class="hljs-number">4</span>*frows))<br><br>i=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> data_train1.columns:<br>    i+=<span class="hljs-number">1</span><br>    ax=plt.subplot(frows,fcols,i)<br>    sns.regplot(x=col, y=<span class="hljs-string">&#x27;target&#x27;</span>, data=data_train, ax=ax, <br>                scatter_kws=&#123;<span class="hljs-string">&#x27;marker&#x27;</span>:<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>:<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;alpha&#x27;</span>:<span class="hljs-number">0.3</span>&#125;,<br>                line_kws=&#123;<span class="hljs-string">&#x27;color&#x27;</span>:<span class="hljs-string">&#x27;k&#x27;</span>&#125;);<br>    plt.xlabel(col)<br>    plt.ylabel(<span class="hljs-string">&#x27;target&#x27;</span>)<br>    <br>    i+=<span class="hljs-number">1</span><br>    ax=plt.subplot(frows,fcols,i)<br>    sns.distplot(data_train[col].dropna() , fit=stats.norm)<br>    plt.xlabel(col)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 找出相关程度</span><br>plt.figure(figsize=(<span class="hljs-number">20</span>, <span class="hljs-number">16</span>))  <span class="hljs-comment"># 指定绘图对象宽度和高度</span><br>colnm = data_train1.columns.tolist()  <span class="hljs-comment"># 列表头</span><br>mcorr = data_train1[colnm].corr(method=<span class="hljs-string">&quot;spearman&quot;</span>)  <span class="hljs-comment"># 相关系数矩阵，即给出了任意两个变量之间的相关系数</span><br>mask = np.zeros_like(mcorr, dtype=np.<span class="hljs-built_in">bool</span>)  <span class="hljs-comment"># 构造与mcorr同维数矩阵 为bool型</span><br>mask[np.triu_indices_from(mask)] = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 角分线右侧为True</span><br>cmap = sns.diverging_palette(<span class="hljs-number">220</span>, <span class="hljs-number">10</span>, as_cmap=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 返回matplotlib colormap对象</span><br>g = sns.heatmap(mcorr, mask=mask, cmap=cmap, square=<span class="hljs-literal">True</span>, annot=<span class="hljs-literal">True</span>, fmt=<span class="hljs-string">&#x27;0.2f&#x27;</span>)  <span class="hljs-comment"># 热力图（看两两相似度）</span><br>plt.show()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Threshold for removing correlated variables</span><br>threshold = <span class="hljs-number">0.1</span><br><br><span class="hljs-comment"># Absolute value correlation matrix</span><br>corr_matrix = data_train1.corr().<span class="hljs-built_in">abs</span>()<br>drop_col=corr_matrix[corr_matrix[<span class="hljs-string">&quot;target&quot;</span>]&lt;threshold].index<br>data_all.drop(drop_col,axis=<span class="hljs-number">1</span>,inplace=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># normalise numeric columns</span><br>cols_numeric=<span class="hljs-built_in">list</span>(data_all.columns)<br>cols_numeric.remove(<span class="hljs-string">&quot;oringin&quot;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">scale_minmax</span>(<span class="hljs-params">col</span>):<br>    <span class="hljs-keyword">return</span> (col-col.<span class="hljs-built_in">min</span>())/(col.<span class="hljs-built_in">max</span>()-col.<span class="hljs-built_in">min</span>())<br>scale_cols = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> cols_numeric <span class="hljs-keyword">if</span> col!=<span class="hljs-string">&#x27;target&#x27;</span>]<br>data_all[scale_cols] = data_all[scale_cols].apply(scale_minmax,axis=<span class="hljs-number">0</span>)<br>data_all[scale_cols].describe()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#Check effect of Box-Cox transforms on distributions of continuous variables</span><br><br>fcols = <span class="hljs-number">6</span><br>frows = <span class="hljs-built_in">len</span>(cols_numeric)-<span class="hljs-number">1</span><br>plt.figure(figsize=(<span class="hljs-number">4</span>*fcols,<span class="hljs-number">4</span>*frows))<br>i=<span class="hljs-number">0</span><br><br><span class="hljs-keyword">for</span> var <span class="hljs-keyword">in</span> cols_numeric:<br>    <span class="hljs-keyword">if</span> var!=<span class="hljs-string">&#x27;target&#x27;</span>:<br>        dat = data_all[[var, <span class="hljs-string">&#x27;target&#x27;</span>]].dropna()<br>        <br>        i+=<span class="hljs-number">1</span><br>        plt.subplot(frows,fcols,i)<br>        sns.distplot(dat[var] , fit=stats.norm);<br>        plt.title(var+<span class="hljs-string">&#x27; Original&#x27;</span>)<br>        plt.xlabel(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <br>        i+=<span class="hljs-number">1</span><br>        plt.subplot(frows,fcols,i)<br>        _=stats.probplot(dat[var], plot=plt)<br>        plt.title(<span class="hljs-string">&#x27;skew=&#x27;</span>+<span class="hljs-string">&#x27;&#123;:.4f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(stats.skew(dat[var])))<br>        plt.xlabel(<span class="hljs-string">&#x27;&#x27;</span>)<br>        plt.ylabel(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <br>        i+=<span class="hljs-number">1</span><br>        plt.subplot(frows,fcols,i)<br>        plt.plot(dat[var], dat[<span class="hljs-string">&#x27;target&#x27;</span>],<span class="hljs-string">&#x27;.&#x27;</span>,alpha=<span class="hljs-number">0.5</span>)<br>        plt.title(<span class="hljs-string">&#x27;corr=&#x27;</span>+<span class="hljs-string">&#x27;&#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(np.corrcoef(dat[var], dat[<span class="hljs-string">&#x27;target&#x27;</span>])[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]))<br> <br>        i+=<span class="hljs-number">1</span><br>        plt.subplot(frows,fcols,i)<br>        trans_var, lambda_var = stats.boxcox(dat[var].dropna()+<span class="hljs-number">1</span>)<br>        trans_var = scale_minmax(trans_var)      <br>        sns.distplot(trans_var , fit=stats.norm);<br>        plt.title(var+<span class="hljs-string">&#x27; Tramsformed&#x27;</span>)<br>        plt.xlabel(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <br>        i+=<span class="hljs-number">1</span><br>        plt.subplot(frows,fcols,i)<br>        _=stats.probplot(trans_var, plot=plt)<br>        plt.title(<span class="hljs-string">&#x27;skew=&#x27;</span>+<span class="hljs-string">&#x27;&#123;:.4f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(stats.skew(trans_var)))<br>        plt.xlabel(<span class="hljs-string">&#x27;&#x27;</span>)<br>        plt.ylabel(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <br>        i+=<span class="hljs-number">1</span><br>        plt.subplot(frows,fcols,i)<br>        plt.plot(trans_var, dat[<span class="hljs-string">&#x27;target&#x27;</span>],<span class="hljs-string">&#x27;.&#x27;</span>,alpha=<span class="hljs-number">0.5</span>)<br>        plt.title(<span class="hljs-string">&#x27;corr=&#x27;</span>+<span class="hljs-string">&#x27;&#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(np.corrcoef(trans_var,dat[<span class="hljs-string">&#x27;target&#x27;</span>])[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">cols_transform=data_all.columns[<span class="hljs-number">0</span>:-<span class="hljs-number">2</span>]<br><span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> cols_transform:   <br>    <span class="hljs-comment"># transform column</span><br>    data_all.loc[:,col], _ = stats.boxcox(data_all.loc[:,col]+<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(data_all.target.describe())<br><br>plt.figure(figsize=(<span class="hljs-number">12</span>,<span class="hljs-number">4</span>))<br>plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>sns.distplot(data_all.target.dropna() , fit=stats.norm);<br>plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>_=stats.probplot(data_all.target.dropna(), plot=plt)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#Log Transform SalePrice to improve normality</span><br>sp = data_train.target<br>data_train.target1 =np.power(<span class="hljs-number">1.5</span>,sp)<br><span class="hljs-built_in">print</span>(data_train.target1.describe())<br><br>plt.figure(figsize=(<span class="hljs-number">12</span>,<span class="hljs-number">4</span>))<br>plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>sns.distplot(data_train.target1.dropna(),fit=stats.norm);<br>plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>_=stats.probplot(data_train.target1.dropna(), plot=plt)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> data_all.columns[<span class="hljs-number">0</span>:-<span class="hljs-number">2</span>]:<br>    g = sns.kdeplot(data_all[column][(data_all[<span class="hljs-string">&quot;oringin&quot;</span>] == <span class="hljs-string">&quot;train&quot;</span>)], color=<span class="hljs-string">&quot;Red&quot;</span>, shade = <span class="hljs-literal">True</span>)<br>    g = sns.kdeplot(data_all[column][(data_all[<span class="hljs-string">&quot;oringin&quot;</span>] == <span class="hljs-string">&quot;test&quot;</span>)], ax =g, color=<span class="hljs-string">&quot;Blue&quot;</span>, shade= <span class="hljs-literal">True</span>)<br>    g.set_xlabel(column)<br>    g.set_ylabel(<span class="hljs-string">&quot;Frequency&quot;</span>)<br>    g = g.legend([<span class="hljs-string">&quot;train&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>])<br>    plt.show()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># function to get training samples</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_training_data</span>():<br>    <span class="hljs-comment"># extract training samples</span><br>    <span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<br>    df_train = data_all[data_all[<span class="hljs-string">&quot;oringin&quot;</span>]==<span class="hljs-string">&quot;train&quot;</span>]<br>    df_train[<span class="hljs-string">&quot;label&quot;</span>]=data_train.target1<br>    <span class="hljs-comment"># split SalePrice and features</span><br>    y = df_train.target<br>    X = df_train.drop([<span class="hljs-string">&quot;oringin&quot;</span>,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-string">&quot;label&quot;</span>],axis=<span class="hljs-number">1</span>)<br>    X_train,X_valid,y_train,y_valid=train_test_split(X,y,test_size=<span class="hljs-number">0.3</span>,random_state=<span class="hljs-number">100</span>)<br>    <span class="hljs-keyword">return</span> X_train,X_valid,y_train,y_valid<br><br><span class="hljs-comment"># extract test data (without SalePrice)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_test_data</span>():<br>    df_test = data_all[data_all[<span class="hljs-string">&quot;oringin&quot;</span>]==<span class="hljs-string">&quot;test&quot;</span>].reset_index(drop=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> df_test.drop([<span class="hljs-string">&quot;oringin&quot;</span>,<span class="hljs-string">&quot;target&quot;</span>],axis=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> make_scorer<br><span class="hljs-comment"># metric for evaluation</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rmse</span>(<span class="hljs-params">y_true, y_pred</span>):<br>    diff = y_pred - y_true<br>    sum_sq = <span class="hljs-built_in">sum</span>(diff**<span class="hljs-number">2</span>)    <br>    n = <span class="hljs-built_in">len</span>(y_pred)   <br>    <br>    <span class="hljs-keyword">return</span> np.sqrt(sum_sq/n)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mse</span>(<span class="hljs-params">y_ture,y_pred</span>):<br>    <span class="hljs-keyword">return</span> mean_squared_error(y_ture,y_pred)<br><br><span class="hljs-comment"># scorer to be used in sklearn model fitting</span><br>rmse_scorer = make_scorer(rmse, greater_is_better=<span class="hljs-literal">False</span>)<br>mse_scorer = make_scorer(mse, greater_is_better=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># function to detect outliers based on the predictions of a model</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_outliers</span>(<span class="hljs-params">model, X, y, sigma=<span class="hljs-number">3</span></span>):<br><br>    <span class="hljs-comment"># predict y values using model</span><br>    <span class="hljs-keyword">try</span>:<br>        y_pred = pd.Series(model.predict(X), index=y.index)<br>    <span class="hljs-comment"># if predicting fails, try fitting the model first</span><br>    <span class="hljs-keyword">except</span>:<br>        model.fit(X,y)<br>        y_pred = pd.Series(model.predict(X), index=y.index)<br>        <br>    <span class="hljs-comment"># calculate residuals between the model prediction and true y values</span><br>    resid = y - y_pred<br>    mean_resid = resid.mean()<br>    std_resid = resid.std()<br><br>    <span class="hljs-comment"># calculate z statistic, define outliers to be where |z|&gt;sigma</span><br>    z = (resid - mean_resid)/std_resid    <br>    outliers = z[<span class="hljs-built_in">abs</span>(z)&gt;sigma].index<br>    <br>    <span class="hljs-comment"># print and plot the results</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;R2=&#x27;</span>,model.score(X,y))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;rmse=&#x27;</span>,rmse(y, y_pred))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mse=&quot;</span>,mean_squared_error(y,y_pred))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;---------------------------------------&#x27;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;mean of residuals:&#x27;</span>,mean_resid)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;std of residuals:&#x27;</span>,std_resid)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;---------------------------------------&#x27;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(outliers),<span class="hljs-string">&#x27;outliers:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(outliers.tolist())<br><br>    plt.figure(figsize=(<span class="hljs-number">15</span>,<span class="hljs-number">5</span>))<br>    ax_131 = plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>)<br>    plt.plot(y,y_pred,<span class="hljs-string">&#x27;.&#x27;</span>)<br>    plt.plot(y.loc[outliers],y_pred.loc[outliers],<span class="hljs-string">&#x27;ro&#x27;</span>)<br>    plt.legend([<span class="hljs-string">&#x27;Accepted&#x27;</span>,<span class="hljs-string">&#x27;Outlier&#x27;</span>])<br>    plt.xlabel(<span class="hljs-string">&#x27;y&#x27;</span>)<br>    plt.ylabel(<span class="hljs-string">&#x27;y_pred&#x27;</span>);<br><br>    ax_132=plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>)<br>    plt.plot(y,y-y_pred,<span class="hljs-string">&#x27;.&#x27;</span>)<br>    plt.plot(y.loc[outliers],y.loc[outliers]-y_pred.loc[outliers],<span class="hljs-string">&#x27;ro&#x27;</span>)<br>    plt.legend([<span class="hljs-string">&#x27;Accepted&#x27;</span>,<span class="hljs-string">&#x27;Outlier&#x27;</span>])<br>    plt.xlabel(<span class="hljs-string">&#x27;y&#x27;</span>)<br>    plt.ylabel(<span class="hljs-string">&#x27;y - y_pred&#x27;</span>);<br><br>    ax_133=plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>    z.plot.hist(bins=<span class="hljs-number">50</span>,ax=ax_133)<br>    z.loc[outliers].plot.hist(color=<span class="hljs-string">&#x27;r&#x27;</span>,bins=<span class="hljs-number">50</span>,ax=ax_133)<br>    plt.legend([<span class="hljs-string">&#x27;Accepted&#x27;</span>,<span class="hljs-string">&#x27;Outlier&#x27;</span>])<br>    plt.xlabel(<span class="hljs-string">&#x27;z&#x27;</span>)<br>    <br>    plt.savefig(<span class="hljs-string">&#x27;outliers.png&#x27;</span>)<br>    <br>    <span class="hljs-keyword">return</span> outliers<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># get training data</span><br><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> Ridge<br>X_train, X_valid,y_train,y_valid = get_training_data()<br>test=get_test_data()<br><br><span class="hljs-comment"># find and remove outliers using a Ridge model</span><br>outliers = find_outliers(Ridge(), X_train, y_train)<br><br><span class="hljs-comment"># permanently remove these outliers from the data</span><br><span class="hljs-comment">#df_train = data_all[data_all[&quot;oringin&quot;]==&quot;train&quot;]</span><br><span class="hljs-comment">#df_train[&quot;label&quot;]=data_train.target1</span><br><span class="hljs-comment">#df_train=df_train.drop(outliers)</span><br>X_outliers=X_train.loc[outliers]<br>y_outliers=y_train.loc[outliers]<br>X_t=X_train.drop(outliers)<br>y_t=y_train.drop(outliers)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_trainning_data_omitoutliers</span>():<br>    y1=y_t.copy()<br>    X1=X_t.copy()<br>    <span class="hljs-keyword">return</span> X1,y1<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>(<span class="hljs-params">model, param_grid=[], X=[], y=[], </span><br><span class="hljs-params">                splits=<span class="hljs-number">5</span>, repeats=<span class="hljs-number">5</span></span>):<br><br>    <span class="hljs-comment"># get unmodified training data, unless data to use already specified</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y)==<span class="hljs-number">0</span>:<br>        X,y = get_trainning_data_omitoutliers()<br>        <span class="hljs-comment">#poly_trans=PolynomialFeatures(degree=2)</span><br>        <span class="hljs-comment">#X=poly_trans.fit_transform(X)</span><br>        <span class="hljs-comment">#X=MinMaxScaler().fit_transform(X)</span><br>    <br>    <span class="hljs-comment"># create cross-validation method</span><br>    rkfold = RepeatedKFold(n_splits=splits, n_repeats=repeats)<br>    <br>    <span class="hljs-comment"># perform a grid search if param_grid given</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(param_grid)&gt;<span class="hljs-number">0</span>:<br>        <span class="hljs-comment"># setup grid search parameters</span><br>        gsearch = GridSearchCV(model, param_grid, cv=rkfold,<br>                               scoring=<span class="hljs-string">&quot;neg_mean_squared_error&quot;</span>,<br>                               verbose=<span class="hljs-number">1</span>, return_train_score=<span class="hljs-literal">True</span>)<br><br>        <span class="hljs-comment"># search the grid</span><br>        gsearch.fit(X,y)<br><br>        <span class="hljs-comment"># extract best model from the grid</span><br>        model = gsearch.best_estimator_        <br>        best_idx = gsearch.best_index_<br><br>        <span class="hljs-comment"># get cv-scores for best model</span><br>        grid_results = pd.DataFrame(gsearch.cv_results_)       <br>        cv_mean = <span class="hljs-built_in">abs</span>(grid_results.loc[best_idx,<span class="hljs-string">&#x27;mean_test_score&#x27;</span>])<br>        cv_std = grid_results.loc[best_idx,<span class="hljs-string">&#x27;std_test_score&#x27;</span>]<br><br>    <span class="hljs-comment"># no grid search, just cross-val score for given model    </span><br>    <span class="hljs-keyword">else</span>:<br>        grid_results = []<br>        cv_results = cross_val_score(model, X, y, scoring=<span class="hljs-string">&quot;neg_mean_squared_error&quot;</span>, cv=rkfold)<br>        cv_mean = <span class="hljs-built_in">abs</span>(np.mean(cv_results))<br>        cv_std = np.std(cv_results)<br>    <br>    <span class="hljs-comment"># combine mean and std cv-score in to a pandas series</span><br>    cv_score = pd.Series(&#123;<span class="hljs-string">&#x27;mean&#x27;</span>:cv_mean,<span class="hljs-string">&#x27;std&#x27;</span>:cv_std&#125;)<br><br>    <span class="hljs-comment"># predict y using the fitted model</span><br>    y_pred = model.predict(X)<br>    <br>    <span class="hljs-comment"># print stats on model performance         </span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;----------------------&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(model)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;----------------------&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;score=&#x27;</span>,model.score(X,y))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;rmse=&#x27;</span>,rmse(y, y_pred))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;mse=&#x27;</span>,mse(y, y_pred))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;cross_val: mean=&#x27;</span>,cv_mean,<span class="hljs-string">&#x27;, std=&#x27;</span>,cv_std)<br>    <br>    <span class="hljs-comment"># residual plots</span><br>    y_pred = pd.Series(y_pred,index=y.index)<br>    resid = y - y_pred<br>    mean_resid = resid.mean()<br>    std_resid = resid.std()<br>    z = (resid - mean_resid)/std_resid    <br>    n_outliers = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">abs</span>(z)&gt;<span class="hljs-number">3</span>)<br>    <br>    plt.figure(figsize=(<span class="hljs-number">15</span>,<span class="hljs-number">5</span>))<br>    ax_131 = plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>)<br>    plt.plot(y,y_pred,<span class="hljs-string">&#x27;.&#x27;</span>)<br>    plt.xlabel(<span class="hljs-string">&#x27;y&#x27;</span>)<br>    plt.ylabel(<span class="hljs-string">&#x27;y_pred&#x27;</span>);<br>    plt.title(<span class="hljs-string">&#x27;corr = &#123;:.3f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(np.corrcoef(y,y_pred)[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]))<br>    ax_132=plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>)<br>    plt.plot(y,y-y_pred,<span class="hljs-string">&#x27;.&#x27;</span>)<br>    plt.xlabel(<span class="hljs-string">&#x27;y&#x27;</span>)<br>    plt.ylabel(<span class="hljs-string">&#x27;y - y_pred&#x27;</span>);<br>    plt.title(<span class="hljs-string">&#x27;std resid = &#123;:.3f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(std_resid))<br>    <br>    ax_133=plt.subplot(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>    z.plot.hist(bins=<span class="hljs-number">50</span>,ax=ax_133)<br>    plt.xlabel(<span class="hljs-string">&#x27;z&#x27;</span>)<br>    plt.title(<span class="hljs-string">&#x27;&#123;:.0f&#125; samples with z&gt;3&#x27;</span>.<span class="hljs-built_in">format</span>(n_outliers))<br><br>    <span class="hljs-keyword">return</span> model, cv_score, grid_results<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># places to store optimal models and scores</span><br>opt_models = <span class="hljs-built_in">dict</span>()<br>score_models = pd.DataFrame(columns=[<span class="hljs-string">&#x27;mean&#x27;</span>,<span class="hljs-string">&#x27;std&#x27;</span>])<br><br><span class="hljs-comment"># no. k-fold splits</span><br>splits=<span class="hljs-number">5</span><br><span class="hljs-comment"># no. k-fold iterations</span><br>repeats=<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;Ridge&#x27;</span><br><br>opt_models[model] = Ridge()<br>alph_range = np.arange(<span class="hljs-number">0.25</span>,<span class="hljs-number">6</span>,<span class="hljs-number">0.25</span>)<br>param_grid = &#123;<span class="hljs-string">&#x27;alpha&#x27;</span>: alph_range&#125;<br><br>opt_models[model],cv_score,grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=splits, repeats=repeats)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br><br>plt.figure()<br>plt.errorbar(alph_range, <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>]),<br>             <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;std_test_score&#x27;</span>])/np.sqrt(splits*repeats))<br>plt.xlabel(<span class="hljs-string">&#x27;alpha&#x27;</span>)<br>plt.ylabel(<span class="hljs-string">&#x27;score&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;Lasso&#x27;</span><br><br>opt_models[model] = Lasso()<br>alph_range = np.arange(<span class="hljs-number">1e-4</span>,<span class="hljs-number">1e-3</span>,<span class="hljs-number">4e-5</span>)<br>param_grid = &#123;<span class="hljs-string">&#x27;alpha&#x27;</span>: alph_range&#125;<br><br>opt_models[model], cv_score, grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=splits, repeats=repeats)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br><br>plt.figure()<br>plt.errorbar(alph_range, <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>]),<span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;std_test_score&#x27;</span>])/np.sqrt(splits*repeats))<br>plt.xlabel(<span class="hljs-string">&#x27;alpha&#x27;</span>)<br>plt.ylabel(<span class="hljs-string">&#x27;score&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model =<span class="hljs-string">&#x27;ElasticNet&#x27;</span><br>opt_models[model] = ElasticNet()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;alpha&#x27;</span>: np.arange(<span class="hljs-number">1e-4</span>,<span class="hljs-number">1e-3</span>,<span class="hljs-number">1e-4</span>),<br>              <span class="hljs-string">&#x27;l1_ratio&#x27;</span>: np.arange(<span class="hljs-number">0.1</span>,<span class="hljs-number">1.0</span>,<span class="hljs-number">0.1</span>),<br>              <span class="hljs-string">&#x27;max_iter&#x27;</span>:[<span class="hljs-number">100000</span>]&#125;<br><br>opt_models[model], cv_score, grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=splits, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">model=<span class="hljs-string">&#x27;LinearSVR&#x27;</span><br>opt_models[model] = LinearSVR()<br><br>crange = np.arange(<span class="hljs-number">0.1</span>,<span class="hljs-number">1.0</span>,<span class="hljs-number">0.1</span>)<br>param_grid = &#123;<span class="hljs-string">&#x27;C&#x27;</span>:crange,<br>             <span class="hljs-string">&#x27;max_iter&#x27;</span>:[<span class="hljs-number">1000</span>]&#125;<br><br>opt_models[model], cv_score, grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=splits, repeats=repeats)<br><br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br><br>plt.figure()<br>plt.errorbar(crange, <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>]),<span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;std_test_score&#x27;</span>])/np.sqrt(splits*repeats))<br>plt.xlabel(<span class="hljs-string">&#x27;C&#x27;</span>)<br>plt.ylabel(<span class="hljs-string">&#x27;score&#x27;</span>)<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;KNeighbors&#x27;</span><br>opt_models[model] = KNeighborsRegressor()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;n_neighbors&#x27;</span>:np.arange(<span class="hljs-number">3</span>,<span class="hljs-number">11</span>,<span class="hljs-number">1</span>)&#125;<br><br>opt_models[model], cv_score, grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=splits, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br><br>plt.figure()<br>plt.errorbar(np.arange(<span class="hljs-number">3</span>,<span class="hljs-number">11</span>,<span class="hljs-number">1</span>), <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>]),<span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;std_test_score&#x27;</span>])/np.sqrt(splits*<span class="hljs-number">1</span>))<br>plt.xlabel(<span class="hljs-string">&#x27;n_neighbors&#x27;</span>)<br>plt.ylabel(<span class="hljs-string">&#x27;score&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;GradientBoosting&#x27;</span><br>opt_models[model] = GradientBoostingRegressor()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;n_estimators&#x27;</span>:[<span class="hljs-number">150</span>,<span class="hljs-number">250</span>,<span class="hljs-number">350</span>],<br>              <span class="hljs-string">&#x27;max_depth&#x27;</span>:[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<br>              <span class="hljs-string">&#x27;min_samples_split&#x27;</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]&#125;<br><br>opt_models[model], cv_score, grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=splits, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;XGB&#x27;</span><br>opt_models[model] = XGBRegressor()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;n_estimators&#x27;</span>:[<span class="hljs-number">100</span>,<span class="hljs-number">200</span>,<span class="hljs-number">300</span>,<span class="hljs-number">400</span>,<span class="hljs-number">500</span>],<br>              <span class="hljs-string">&#x27;max_depth&#x27;</span>:[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<br>             &#125;<br><br>opt_models[model], cv_score,grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=splits, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;RandomForest&#x27;</span><br>opt_models[model] = RandomForestRegressor()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;n_estimators&#x27;</span>:[<span class="hljs-number">100</span>,<span class="hljs-number">150</span>,<span class="hljs-number">200</span>],<br>              <span class="hljs-string">&#x27;max_features&#x27;</span>:[<span class="hljs-number">8</span>,<span class="hljs-number">12</span>,<span class="hljs-number">16</span>,<span class="hljs-number">20</span>,<span class="hljs-number">24</span>],<br>              <span class="hljs-string">&#x27;min_samples_split&#x27;</span>:[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>]&#125;<br><br>opt_models[model], cv_score, grid_results = train_model(opt_models[model], param_grid=param_grid, <br>                                              splits=<span class="hljs-number">5</span>, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">model_predict</span>(<span class="hljs-params">test_data,test_y=[],stack=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-comment">#poly_trans=PolynomialFeatures(degree=2)</span><br>    <span class="hljs-comment">#test_data1=poly_trans.fit_transform(test_data)</span><br>    <span class="hljs-comment">#test_data=MinMaxScaler().fit_transform(test_data)</span><br>    i=<span class="hljs-number">0</span><br>    y_predict_total=np.zeros((test_data.shape[<span class="hljs-number">0</span>],))<br>    <span class="hljs-keyword">if</span> stack:<br>        <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> metal_models.keys():<br>            y_predict=metal_models[model].predict(test_data)<br>            y_predict_total+=y_predict<br>            i+=<span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(test_y)&gt;<span class="hljs-number">0</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&#123;&#125;_mse:&quot;</span>.<span class="hljs-built_in">format</span>(model),mean_squared_error(y_predict,test_y))<br>        y_predict_mean=np.<span class="hljs-built_in">round</span>(y_predict_total/i,<span class="hljs-number">3</span>)  <br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(test_y)&gt;<span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mean_mse:&quot;</span>,mean_squared_error(y_predict_mean,test_y))<br>        <span class="hljs-keyword">else</span>:<br>            y_metal_mean=pd.Series(y_predict_mean)<br>            <span class="hljs-keyword">return</span> y_metal_mean <br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> opt_models.keys():<br>            <span class="hljs-keyword">if</span> model!=<span class="hljs-string">&quot;LinearSVR&quot;</span> <span class="hljs-keyword">and</span> model!=<span class="hljs-string">&quot;KNeighbors&quot;</span>:<br>                y_predict=opt_models[model].predict(test_data)<br>                y_predict_total+=y_predict<br>                i+=<span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(test_y)&gt;<span class="hljs-number">0</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&#123;&#125;_mse:&quot;</span>.<span class="hljs-built_in">format</span>(model),mean_squared_error(y_predict,test_y))<br>        y_predict_mean=np.<span class="hljs-built_in">round</span>(y_predict_total/i,<span class="hljs-number">3</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(test_y)&gt;<span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mean_mse:&quot;</span>,mean_squared_error(y_predict_mean,test_y))<br>        <span class="hljs-keyword">else</span>:<br>            y_predict_mean=pd.Series(y_predict_mean)<br>            <span class="hljs-keyword">return</span> y_predict_mean<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">model_predict(X_valid,y_valid)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_stack_features</span>(<span class="hljs-params">test_data</span>):<br>    features=&#123;&#125;<br>    columns=[]<br>    <span class="hljs-keyword">for</span> model <span class="hljs-keyword">in</span> opt_models.keys():<br>        columns.append(model)<br>        features[model]=opt_models[model].predict(test_data)<br>    stack_feature=pd.DataFrame(features,columns=columns)<br>    <span class="hljs-keyword">return</span> stack_feature<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#load metal data</span><br>metal_x_train=create_stack_features(X_t)<br>metal_y_train=pd.Series(y_t.values)<br>metal_x_valid=create_stack_features(X_valid)<br>metal_y_valid=pd.Series(y_valid.values)<br>metal_x_test=create_stack_features(test)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># places to store metal models and scores</span><br>metal_models = <span class="hljs-built_in">dict</span>()<br>score_models = pd.DataFrame(columns=[<span class="hljs-string">&#x27;mean&#x27;</span>,<span class="hljs-string">&#x27;std&#x27;</span>])<br><br><span class="hljs-comment"># no. k-fold splits</span><br>splits=<span class="hljs-number">5</span><br><span class="hljs-comment"># no. k-fold iterations</span><br>repeats=<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;Ridge&#x27;</span><br><br>metal_models[model] = Ridge()<br>alph_range = np.arange(<span class="hljs-number">0.25</span>,<span class="hljs-number">6</span>,<span class="hljs-number">0.25</span>)<br>param_grid = &#123;<span class="hljs-string">&#x27;alpha&#x27;</span>: alph_range&#125;<br><br>metal_models[model],cv_score,grid_results = train_model(metal_models[model], param_grid=param_grid, X=metal_x_train,y=metal_y_train,<br>                                              splits=splits, repeats=repeats)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br><br>plt.figure()<br>plt.errorbar(alph_range, <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>]),<br>             <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;std_test_score&#x27;</span>])/np.sqrt(splits*repeats))<br>plt.xlabel(<span class="hljs-string">&#x27;alpha&#x27;</span>)<br>plt.ylabel(<span class="hljs-string">&#x27;score&#x27;</span>)<br></code></pre></td></tr></table></figure><p>若报错：AttributeError: 'DataFrame' object has no attribute 'append'</p><p>解决方案：</p><p>pandas版本较新，新版本将append改为了_append</p><p><code>dataframe = dataframe._append()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;Lasso&#x27;</span><br><br>metal_models[model] = Lasso()<br>alph_range = np.arange(<span class="hljs-number">1e-4</span>,<span class="hljs-number">1e-3</span>,<span class="hljs-number">4e-5</span>)<br>param_grid = &#123;<span class="hljs-string">&#x27;alpha&#x27;</span>: alph_range&#125;<br><br>metal_models[model], cv_score, grid_results = train_model(metal_models[model], param_grid=param_grid, X=metal_x_train,y=metal_y_train,<br>                                              splits=splits, repeats=repeats)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br><br>plt.figure()<br>plt.errorbar(alph_range, <span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;mean_test_score&#x27;</span>]),<span class="hljs-built_in">abs</span>(grid_results[<span class="hljs-string">&#x27;std_test_score&#x27;</span>])/np.sqrt(splits*repeats))<br>plt.xlabel(<span class="hljs-string">&#x27;alpha&#x27;</span>)<br>plt.ylabel(<span class="hljs-string">&#x27;score&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model =<span class="hljs-string">&#x27;ElasticNet&#x27;</span><br>metal_models[model] = ElasticNet()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;alpha&#x27;</span>: np.arange(<span class="hljs-number">1e-4</span>,<span class="hljs-number">1e-3</span>,<span class="hljs-number">1e-4</span>),<br>              <span class="hljs-string">&#x27;l1_ratio&#x27;</span>: np.arange(<span class="hljs-number">0.1</span>,<span class="hljs-number">1.0</span>,<span class="hljs-number">0.1</span>),<br>              <span class="hljs-string">&#x27;max_iter&#x27;</span>:[<span class="hljs-number">100000</span>]&#125;<br><br>metal_models[model], cv_score, grid_results = train_model(metal_models[model], param_grid=param_grid, X=metal_x_train,y=metal_y_train,<br>                                              splits=splits, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;XGB&#x27;</span><br>metal_models[model] = XGBRegressor()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;n_estimators&#x27;</span>:[<span class="hljs-number">100</span>,<span class="hljs-number">200</span>,<span class="hljs-number">300</span>,<span class="hljs-number">400</span>,<span class="hljs-number">500</span>],<br>              <span class="hljs-string">&#x27;max_depth&#x27;</span>:[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<br>             &#125;<br><br>metal_models[model], cv_score,grid_results = train_model(metal_models[model], param_grid=param_grid, X=metal_x_train,y=metal_train_y_train,<br>                                              splits=splits, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;GradientBoosting&#x27;</span><br>metal_models[model] = GradientBoostingRegressor()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;n_estimators&#x27;</span>:[<span class="hljs-number">150</span>,<span class="hljs-number">250</span>,<span class="hljs-number">350</span>],<br>              <span class="hljs-string">&#x27;max_depth&#x27;</span>:[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],<br>              <span class="hljs-string">&#x27;min_samples_split&#x27;</span>:[<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]&#125;<br><br>metal_models[model], cv_score, grid_results = train_model(metal_models[model], param_grid=param_grid, X=metal_x_train,y=metal_y_train,<br>                                              splits=splits, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">model = <span class="hljs-string">&#x27;RandomForest&#x27;</span><br>metal_models[model] = RandomForestRegressor()<br><br>param_grid = &#123;<span class="hljs-string">&#x27;n_estimators&#x27;</span>:[<span class="hljs-number">100</span>,<span class="hljs-number">150</span>,<span class="hljs-number">200</span>],<br>              <span class="hljs-string">&#x27;max_features&#x27;</span>:[<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],<br>              <span class="hljs-string">&#x27;min_samples_split&#x27;</span>:[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>]&#125;<br><br>metal_models[model], cv_score, grid_results = train_model(metal_models[model], param_grid=param_grid,  X=metal_x_train,y=metal_y_train,<br>                                              splits=<span class="hljs-number">5</span>, repeats=<span class="hljs-number">1</span>)<br><br>cv_score.name = model<br>score_models = score_models.append(cv_score)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">model_predict(metal_x_valid,metal_y_valid,stack=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8/" class="category-chain-item">机器学习实战入门</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">#机器学习</a></div></div><div class="license-box my-3"><div class="license-title"><div>工业蒸汽预测-赛题完整代码分享</div><div>http://zhou1317fe5.link/2023/09/28/工业蒸汽预测-赛题完整代码分享/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Zhou1317fe5</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年9月28日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2023/09/19/%E5%B7%A5%E4%B8%9A%E8%92%B8%E6%B1%BD%E9%A2%84%E6%B5%8B-07%E6%A8%A1%E5%9E%8B%E8%9E%8D%E5%90%88/" title="工业蒸汽预测-07模型融合"><span class="hidden-mobile">工业蒸汽预测-07模型融合</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>